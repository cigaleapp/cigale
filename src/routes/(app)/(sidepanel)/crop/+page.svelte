<script>
	import AreaObservations from '$lib/AreaObservations.svelte';
	import ButtonSecondary from '$lib/ButtonSecondary.svelte';
	import CardImageFile from '$lib/CardImageFile.svelte';
	import * as idb from '$lib/idb.svelte.js';
	import { deleteImageFile, imageIsAnalyzed } from '$lib/images';
	import Logo from '$lib/Logo.svelte';
	import { deleteObservation } from '$lib/observations.js';

	import { goto } from '$lib/paths.js';
	import { cancelTask, detectMore } from '$lib/queue.svelte.js';
	import { seo } from '$lib/seo.svelte';
	import { getSettings } from '$lib/settings.svelte';
	import { uiState } from '$lib/state.svelte.js';
	import { avg, groupBy, nonnull } from '$lib/utils.js';
	import { watch } from 'runed';
	import { onMount } from 'svelte';

	seo({ title: 'Recadrer' });

	const items = $derived(
		[...groupBy(idb.tables.Image.state, (img) => img.fileId ?? '').entries()].map(
			([fileId, images]) => ({
				id: fileId,
				addedAt: new Date(avg(images.map((i) => i.addedAt.getTime()))),
				name: images[0].filename,
				virtual: false,
				data: images
			})
		)
	);

	$effect(() => {
		uiState.imageOpenedInCropper = '';
	});

	onMount(() => {
		detectMore(
			idb.tables.Image.state
				.map(({ fileId }) => fileId)
				.filter(nonnull)
				.filter((fileId) => !imageIsAnalyzed(uiState.currentProtocol, fileId))
		);
	});

	watch(
		() => uiState.imagePreviouslyOpenedInCropper,
		() => {
			uiState.setSelection?.([uiState.imagePreviouslyOpenedInCropper]);
		}
	);
</script>

<section class="observations">
	<AreaObservations
		{items}
		sort={getSettings().gallerySort}
		groups={['Avec détections', 'Sans détection']}
		grouping={({ data: images }) =>
			images.some((img) => uiState.cropMetadataValueOf(img)) ? 'Avec détections' : 'Sans détection'}
	>
		{#snippet item(images, { id: fileId })}
			<CardImageFile
				{fileId}
				{images}
				boxes="show-all"
				highlighted={fileId === uiState.imagePreviouslyOpenedInCropper}
				loadingStatusText={'Analyse…'}
				onretry={() => {
					uiState.erroredImages.delete(fileId);
					detectMore([fileId]);
				}}
				ondelete={async () => {
					cancelTask(fileId, 'Cancelled by user');
					uiState.processing.removeFile(fileId);
					await deleteObservation(fileId);
					await deleteImageFile(fileId);
				}}
				onclick={async () => goto('/(app)/(sidepanel)/crop/[image]', { image: fileId })}
			/>
		{/snippet}
	</AreaObservations>
	{#if !items.length}
		<div class="empty">
			<Logo variant="empty" --size="6em" />
			<p>{'Aucune image'}</p>
			<ButtonSecondary onclick={() => goto('/import')}>
				{'Importer'}
			</ButtonSecondary>
		</div>
	{/if}
</section>

<style>
	.observations {
		padding: 2.5em;
		display: flex;
		flex-direction: column;
		flex-grow: 1;
	}

	.empty {
		display: flex;
		flex-direction: column;
		gap: 1em;
		max-width: 400px;
		justify-content: center;
		align-items: center;
		margin: auto;
	}
</style>
