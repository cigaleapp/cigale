import"../chunks/DsnmJJEf.js";import{p as te,g as e,u as q,k as $,s as H,e as Y,d as Z,a as u,b as re,i as R,c as A,az as o,aA as f,r as s,ab as x,aB as se,aa as oe}from"../chunks/CKFr55HY.js";import{a as z}from"../chunks/BSJa-gCr.js";import{i as V}from"../chunks/BnINZmlg.js";import{c as ie}from"../chunks/Eu4gtx6U.js";import{_ as le,g as ne,s as ce,b as de}from"../chunks/B0sfP6zc.js";import{t as J,f as K}from"../chunks/CQ7DZjSk.js";import{w as me}from"../chunks/CfgHx0iS.js";import{A as fe}from"../chunks/BqLOnghX.js";import{B as ve}from"../chunks/B0qXVrpE.js";import{C as pe}from"../chunks/dBco5EFm.js";import{c as ee,e as ue,a as ge,b as _e,d as be}from"../chunks/kBTncvD5.js";import{t as T,e as he}from"../chunks/BfjK8oC1.js";import{i as Ie,a as ye,b as ze,d as xe,c as we}from"../chunks/BkWgRosR.js";import{L as Q}from"../chunks/CKTUSNu_.js";import{g as Me}from"../chunks/bCylyxMO.js";import{P as Ce}from"../chunks/De1XvMMn.js";import{s as Se}from"../chunks/CUqDLSou.js";import{a as Ae,i as ke}from"../chunks/CaMFGYwT.js";import{u as r}from"../chunks/CzznUtHs.js";import{t as X}from"../chunks/C4Cali0V.js";import{s as Oe}from"../chunks/BmYW83mJ.js";const ae=U=>{var w=Y(),n=Z(w);{var k=M=>{const v=q(()=>{const{model:P}=r.classificationModels[r.selectedClassificationModel];return{model:P}}),b=q(()=>new URL(typeof e(v).model=="string"?e(v).model:e(v).model?.url));var C=Pe(),O=o(C),W=o(O,!0);s(O),s(C),x((P,j)=>{ce(C,"href",P),z(W,j)},[()=>e(b).toString(),()=>e(b).pathname.split("/").at(-1)]),u(M,C)};V(n,M=>{r.classificationInferenceAvailable&&M(k)})}u(U,w)};var Pe=A('<a target="_blank" class="svelte-1o687fz"><code class="svelte-1o687fz"> </code></a>'),Le=A('<section class="loading svelte-1o687fz"><!> <p> </p> <p class="source svelte-1o687fz"><!></p> <div class="progressbar svelte-1o687fz"><!></div></section>'),Be=A('<div class="empty svelte-1o687fz"><svelte-css-wrapper style="display: contents"><!></svelte-css-wrapper> <p> </p> <!></div>'),Fe=A("<section><!> <!></section>"),Ee=A('<pre class="trace svelte-1o687fz"> </pre>'),Ne=A('<section class="loading errored svelte-1o687fz"><!> <h2 class="svelte-1o687fz"> </h2> <p class="svelte-1o687fz"> </p> <p class="source svelte-1o687fz"><!></p> <p class="message svelte-1o687fz"> </p> <!></section>');function oa(U,w){te(w,!0);const n=q(()=>le(ne("main")));Se({title:e(n).t(63)});const k=q(()=>T.Observation.state.map(a=>({id:a.id,addedAt:a.addedAt,name:a.label,virtual:!1,data:{observation:a,images:T.Image.state.filter(t=>a.images.includes(t.id))}})));let M=H(0),v=H(!1),b=H(void 0);async function C(){if(e(v)||!r.currentProtocol||!r.classificationInferenceAvailable)return;const a=ge(r.currentProtocol,r.selectedClassificationModel);if(!a){X.error(e(n).t(34,[r.selectedClassificationModel,r.currentProtocol.name]));return}await w.data.swarpc.loadModel.broadcast({protocolId:r.currentProtocol.id,request:a.model,classmapping:a.classmapping,task:"classification"},t=>{R(M,Oe(t.values())/w.data.parallelism)}).then(()=>{R(v,!0)}).catch(t=>{console.error(t),X.error(e(n).t(92))})}$(()=>{if(!r.classificationInferenceAvailable||!e(v)||e(b))return;const a=T.Image.state.filter(t=>Ie(t)&&!ye(t)&&!r.loadingImages.has(t.id));ee(a.map(t=>t.id))}),me(()=>r.selectedClassificationModel,()=>{R(v,!1),C().catch(a=>{R(b,a,!0)}).finally(()=>{R(v,!0)})}),$(()=>{r.setSelection&&ue()});var O=Y(),W=Z(O);{var P=a=>{var t=Le(),D=o(t);Q(D,{loading:!0});var L=f(D,2),G=o(L,!0);s(L);var p=f(L,2),c=o(p);ae(c),s(p);var h=f(p,2),I=o(h);Ce(I,{percentage:!0,alwaysActive:!0,get progress(){return e(M)}}),s(h),s(t),x(B=>z(G,B),[()=>e(n).t(56)]),J(1,t,()=>K,()=>({duration:100})),u(a,t)},j=a=>{var t=Y(),D=Z(t);{var L=p=>{var c=Fe();let h;var I=o(c);fe(I,{get items(){return e(k)},get sort(){return Ae().gallerySort},groups:["Recadrées","Non recadrées"],grouping:({data:{images:d}})=>d.some(m=>r.cropMetadataValueOf(m))?"Recadrées":"Non recadrées",item:(d,m,g)=>{let E=()=>m?.().observation,N=()=>m?.().images,i=()=>g?.().id;{let y=q(()=>e(n).t(30));pe(d,{get observation(){return E()},get images(){return N()},boxes:"apply-first",get loadingStatusText(){return e(y)},onretry:()=>{r.erroredImages.delete(i());const l=T.Observation.getFromState(i())?.images;l?(l.forEach(_=>r.erroredImages.delete(_)),ee(l)):X.error(e(n).t(214,[i()]))},ondelete:async()=>{(T.Observation.getFromState(i())?.images??[i()]).forEach(_=>_e(_,"Cancelled by user")),ze(i())&&await xe(we(i())),await be(i(),{notFoundOk:!0,recursive:!0})}})}},$$slots:{item:!0}});var B=f(I,2);{var F=S=>{var d=Be(),m=o(d);ie(m,()=>({"--size":"6em"})),Q(m.lastChild,{variant:"empty"}),s(m);var g=f(m,2),E=o(g,!0);s(g);var N=f(g,2);ve(N,{onclick:()=>Me("/import"),children:(i,y)=>{se();var l=oe();x(_=>z(l,_),[()=>e(n).t(108)]),u(i,l)},$$slots:{default:!0}}),s(d),x(i=>z(E,i),[()=>e(n).t(38)]),u(S,d)};V(B,S=>{e(k).length||S(F)})}s(c),x(()=>h=de(c,1,"observations svelte-1o687fz",null,h,{empty:!e(k).length})),J(1,c,()=>K,()=>({duration:100})),u(p,c)},G=p=>{var c=Ne(),h=o(c);Q(h,{variant:"error"});var I=f(h,2),B=o(I,!0);s(I);var F=f(I,2),S=o(F,!0);s(F);var d=f(F,2),m=o(d);ae(m),s(d);var g=f(d,2),E=o(g,!0);s(g);var N=f(g,2);{var i=y=>{var l=Ee(),_=o(l,!0);s(l),x(()=>z(_,e(b)?.stack)),u(y,l)};V(N,y=>{ke()&&y(i)})}s(c),x((y,l,_)=>{z(B,y),z(S,l),z(E,_)},[()=>e(n).t(141),()=>e(n).t(113),()=>he(e(b))]),J(1,c,()=>K,()=>({duration:100})),u(p,c)};V(D,p=>{e(b)?p(G,!1):p(L)},!0)}u(a,t)};V(W,a=>{e(v)?a(j,!1):a(P)})}u(U,O),re()}export{oa as component};
