const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BfjK8oC1.js","./CKFr55HY.js","./DIeogL5L.js","./B0sfP6zc.js","./BSJa-gCr.js","./PPVm8Dsz.js","./BmYW83mJ.js"])))=>i.map(i=>d[i]);
import{_ as ee}from"./PPVm8Dsz.js";import{G as te,v as T,J as Y,K as ne,L as re,N as ae,O as oe,P as ie,Q as se,R as ce,S as V,U as ue,V as de,W as fe,X as me,B as q,Y as I,Z as ge,_ as le,C as X,n as L,$ as N,a0 as R,a1 as he,k as we,g as p}from"./BfjK8oC1.js";import{g as _,n as F,e as pe,s as ye,p as be,j as k,m as j,a as x}from"./BmYW83mJ.js";import{s as Me}from"./BYsmyf-T.js";import{g as Oe}from"./CaMFGYwT.js";function xe(t,...e){const n=te.bind(null,t||e.find(r=>typeof r=="object"));return e.map(n)}function C(t,e){const n=T(t,e?.in);return n.setHours(0,0,0,0),n}function ve(t,e,n){const[r,a]=xe(n?.in,t,e),o=C(r),i=C(a),s=+o-Y(o),c=+i-Y(i);return Math.round((s-c)/ne)}function Ee(t,e){const n=T(t,e?.in);return n.setFullYear(n.getFullYear(),0,1),n.setHours(0,0,0,0),n}function De(t,e){const n=T(t,e?.in);return ve(n,Ee(n))+1}function d(t,e){const n=t<0?"-":"",r=Math.abs(t).toString().padStart(e,"0");return n+r}const y={y(t,e){const n=t.getFullYear(),r=n>0?n:1-n;return d(e==="yy"?r%100:r,e.length)},M(t,e){const n=t.getMonth();return e==="M"?String(n+1):d(n+1,2)},d(t,e){return d(t.getDate(),e.length)},a(t,e){const n=t.getHours()/12>=1?"pm":"am";switch(e){case"a":case"aa":return n.toUpperCase();case"aaa":return n;case"aaaaa":return n[0];case"aaaa":default:return n==="am"?"a.m.":"p.m."}},h(t,e){return d(t.getHours()%12||12,e.length)},H(t,e){return d(t.getHours(),e.length)},m(t,e){return d(t.getMinutes(),e.length)},s(t,e){return d(t.getSeconds(),e.length)},S(t,e){const n=e.length,r=t.getMilliseconds(),a=Math.trunc(r*Math.pow(10,n-3));return d(a,e.length)}},v={midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},G={G:function(t,e,n){const r=t.getFullYear()>0?1:0;switch(e){case"G":case"GG":case"GGG":return n.era(r,{width:"abbreviated"});case"GGGGG":return n.era(r,{width:"narrow"});case"GGGG":default:return n.era(r,{width:"wide"})}},y:function(t,e,n){if(e==="yo"){const r=t.getFullYear(),a=r>0?r:1-r;return n.ordinalNumber(a,{unit:"year"})}return y.y(t,e)},Y:function(t,e,n,r){const a=ie(t,r),o=a>0?a:1-a;if(e==="YY"){const i=o%100;return d(i,2)}return e==="Yo"?n.ordinalNumber(o,{unit:"year"}):d(o,e.length)},R:function(t,e){const n=oe(t);return d(n,e.length)},u:function(t,e){const n=t.getFullYear();return d(n,e.length)},Q:function(t,e,n){const r=Math.ceil((t.getMonth()+1)/3);switch(e){case"Q":return String(r);case"QQ":return d(r,2);case"Qo":return n.ordinalNumber(r,{unit:"quarter"});case"QQQ":return n.quarter(r,{width:"abbreviated",context:"formatting"});case"QQQQQ":return n.quarter(r,{width:"narrow",context:"formatting"});case"QQQQ":default:return n.quarter(r,{width:"wide",context:"formatting"})}},q:function(t,e,n){const r=Math.ceil((t.getMonth()+1)/3);switch(e){case"q":return String(r);case"qq":return d(r,2);case"qo":return n.ordinalNumber(r,{unit:"quarter"});case"qqq":return n.quarter(r,{width:"abbreviated",context:"standalone"});case"qqqqq":return n.quarter(r,{width:"narrow",context:"standalone"});case"qqqq":default:return n.quarter(r,{width:"wide",context:"standalone"})}},M:function(t,e,n){const r=t.getMonth();switch(e){case"M":case"MM":return y.M(t,e);case"Mo":return n.ordinalNumber(r+1,{unit:"month"});case"MMM":return n.month(r,{width:"abbreviated",context:"formatting"});case"MMMMM":return n.month(r,{width:"narrow",context:"formatting"});case"MMMM":default:return n.month(r,{width:"wide",context:"formatting"})}},L:function(t,e,n){const r=t.getMonth();switch(e){case"L":return String(r+1);case"LL":return d(r+1,2);case"Lo":return n.ordinalNumber(r+1,{unit:"month"});case"LLL":return n.month(r,{width:"abbreviated",context:"standalone"});case"LLLLL":return n.month(r,{width:"narrow",context:"standalone"});case"LLLL":default:return n.month(r,{width:"wide",context:"standalone"})}},w:function(t,e,n,r){const a=ae(t,r);return e==="wo"?n.ordinalNumber(a,{unit:"week"}):d(a,e.length)},I:function(t,e,n){const r=re(t);return e==="Io"?n.ordinalNumber(r,{unit:"week"}):d(r,e.length)},d:function(t,e,n){return e==="do"?n.ordinalNumber(t.getDate(),{unit:"date"}):y.d(t,e)},D:function(t,e,n){const r=De(t);return e==="Do"?n.ordinalNumber(r,{unit:"dayOfYear"}):d(r,e.length)},E:function(t,e,n){const r=t.getDay();switch(e){case"E":case"EE":case"EEE":return n.day(r,{width:"abbreviated",context:"formatting"});case"EEEEE":return n.day(r,{width:"narrow",context:"formatting"});case"EEEEEE":return n.day(r,{width:"short",context:"formatting"});case"EEEE":default:return n.day(r,{width:"wide",context:"formatting"})}},e:function(t,e,n,r){const a=t.getDay(),o=(a-r.weekStartsOn+8)%7||7;switch(e){case"e":return String(o);case"ee":return d(o,2);case"eo":return n.ordinalNumber(o,{unit:"day"});case"eee":return n.day(a,{width:"abbreviated",context:"formatting"});case"eeeee":return n.day(a,{width:"narrow",context:"formatting"});case"eeeeee":return n.day(a,{width:"short",context:"formatting"});case"eeee":default:return n.day(a,{width:"wide",context:"formatting"})}},c:function(t,e,n,r){const a=t.getDay(),o=(a-r.weekStartsOn+8)%7||7;switch(e){case"c":return String(o);case"cc":return d(o,e.length);case"co":return n.ordinalNumber(o,{unit:"day"});case"ccc":return n.day(a,{width:"abbreviated",context:"standalone"});case"ccccc":return n.day(a,{width:"narrow",context:"standalone"});case"cccccc":return n.day(a,{width:"short",context:"standalone"});case"cccc":default:return n.day(a,{width:"wide",context:"standalone"})}},i:function(t,e,n){const r=t.getDay(),a=r===0?7:r;switch(e){case"i":return String(a);case"ii":return d(a,e.length);case"io":return n.ordinalNumber(a,{unit:"day"});case"iii":return n.day(r,{width:"abbreviated",context:"formatting"});case"iiiii":return n.day(r,{width:"narrow",context:"formatting"});case"iiiiii":return n.day(r,{width:"short",context:"formatting"});case"iiii":default:return n.day(r,{width:"wide",context:"formatting"})}},a:function(t,e,n){const a=t.getHours()/12>=1?"pm":"am";switch(e){case"a":case"aa":return n.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"aaa":return n.dayPeriod(a,{width:"abbreviated",context:"formatting"}).toLowerCase();case"aaaaa":return n.dayPeriod(a,{width:"narrow",context:"formatting"});case"aaaa":default:return n.dayPeriod(a,{width:"wide",context:"formatting"})}},b:function(t,e,n){const r=t.getHours();let a;switch(r===12?a=v.noon:r===0?a=v.midnight:a=r/12>=1?"pm":"am",e){case"b":case"bb":return n.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"bbb":return n.dayPeriod(a,{width:"abbreviated",context:"formatting"}).toLowerCase();case"bbbbb":return n.dayPeriod(a,{width:"narrow",context:"formatting"});case"bbbb":default:return n.dayPeriod(a,{width:"wide",context:"formatting"})}},B:function(t,e,n){const r=t.getHours();let a;switch(r>=17?a=v.evening:r>=12?a=v.afternoon:r>=4?a=v.morning:a=v.night,e){case"B":case"BB":case"BBB":return n.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"BBBBB":return n.dayPeriod(a,{width:"narrow",context:"formatting"});case"BBBB":default:return n.dayPeriod(a,{width:"wide",context:"formatting"})}},h:function(t,e,n){if(e==="ho"){let r=t.getHours()%12;return r===0&&(r=12),n.ordinalNumber(r,{unit:"hour"})}return y.h(t,e)},H:function(t,e,n){return e==="Ho"?n.ordinalNumber(t.getHours(),{unit:"hour"}):y.H(t,e)},K:function(t,e,n){const r=t.getHours()%12;return e==="Ko"?n.ordinalNumber(r,{unit:"hour"}):d(r,e.length)},k:function(t,e,n){let r=t.getHours();return r===0&&(r=24),e==="ko"?n.ordinalNumber(r,{unit:"hour"}):d(r,e.length)},m:function(t,e,n){return e==="mo"?n.ordinalNumber(t.getMinutes(),{unit:"minute"}):y.m(t,e)},s:function(t,e,n){return e==="so"?n.ordinalNumber(t.getSeconds(),{unit:"second"}):y.s(t,e)},S:function(t,e){return y.S(t,e)},X:function(t,e,n){const r=t.getTimezoneOffset();if(r===0)return"Z";switch(e){case"X":return Q(r);case"XXXX":case"XX":return O(r);case"XXXXX":case"XXX":default:return O(r,":")}},x:function(t,e,n){const r=t.getTimezoneOffset();switch(e){case"x":return Q(r);case"xxxx":case"xx":return O(r);case"xxxxx":case"xxx":default:return O(r,":")}},O:function(t,e,n){const r=t.getTimezoneOffset();switch(e){case"O":case"OO":case"OOO":return"GMT"+H(r,":");case"OOOO":default:return"GMT"+O(r,":")}},z:function(t,e,n){const r=t.getTimezoneOffset();switch(e){case"z":case"zz":case"zzz":return"GMT"+H(r,":");case"zzzz":default:return"GMT"+O(r,":")}},t:function(t,e,n){const r=Math.trunc(+t/1e3);return d(r,e.length)},T:function(t,e,n){return d(+t,e.length)}};function H(t,e=""){const n=t>0?"-":"+",r=Math.abs(t),a=Math.trunc(r/60),o=r%60;return o===0?n+String(a):n+String(a)+e+d(o,2)}function Q(t,e){return t%60===0?(t>0?"-":"+")+d(Math.abs(t)/60,2):O(t,e)}function O(t,e=""){const n=t>0?"-":"+",r=Math.abs(t),a=d(Math.trunc(r/60),2),o=d(r%60,2);return n+a+e+o}const Se=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,Te=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,ke=/^'([^]*?)'?$/,$e=/''/g,Be=/[a-zA-Z]/;function Pe(t,e,n){const r=se(),a=r.locale??ce,o=r.firstWeekContainsDate??r.locale?.options?.firstWeekContainsDate??1,i=r.weekStartsOn??r.locale?.options?.weekStartsOn??0,s=T(t,n?.in);if(!V(s))throw new RangeError("Invalid time value");let c=e.match(Te).map(f=>{const u=f[0];if(u==="p"||u==="P"){const l=ue[u];return l(f,a.formatLong)}return f}).join("").match(Se).map(f=>{if(f==="''")return{isToken:!1,value:"'"};const u=f[0];if(u==="'")return{isToken:!1,value:Ye(f)};if(G[u])return{isToken:!0,value:f};if(u.match(Be))throw new RangeError("Format string contains an unescaped latin alphabet character `"+u+"`");return{isToken:!1,value:f}});a.localize.preprocessor&&(c=a.localize.preprocessor(s,c));const m={firstWeekContainsDate:o,weekStartsOn:i,locale:a};return c.map(f=>{if(!f.isToken)return f.value;const u=f.value;(de(u)||fe(u))&&me(u,e,String(t));const l=G[u[0]];return l(s,u,a.localize,m)}).join("")}function Ye(t){const e=t.match(ke);return e?e[1].replace($e,"'"):t}async function qe({db:t,metadataId:e,confidence:n,value:r,alternatives:a}){return await Promise.all([{value:r,confidence:n},...a].map(async({confidence:o,value:i})=>{const s=await t.get("MetadataOption",q(e,i));if(!s?.cascade)return;const{cascade:c}=s;return{cascade:c,confidence:o}})).then(o=>{const i=_(o.filter(F).flatMap(({cascade:c,confidence:m})=>pe(c).map(([f,u])=>({optionId:q(f,u),confidence:m}))),c=>c.optionId,c=>c.confidence);return[..._(i.entries(),([c])=>I(c).metadataId,([c,m])=>({value:I(c).key,confidence:ye(m)})).entries()].map(([c,m])=>{const[{value:f,confidence:u},...l]=m.toSorted(({confidence:b},{confidence:h})=>h-b);return{metadataId:c,value:f,confidence:u,alternatives:l}})})}async function Ie(t,e,n,r,a,o){const i=await Oe("beamupPreferences",t);if(!i[e.id]?.enable)return;const s=await t.get("Image",n).catch(()=>{}),c=s?void 0:await t.get("Observation",n).catch(()=>{}),m=s?.fileId?await t.get("ImageFile",s.fileId):void 0,f=s?.sha1??await Promise.all((c?.images??[]).map(async u=>t.get("Image",u).catch(()=>{}).then(l=>l?.sha1))).then(u=>u.filter(F).join(" "));await t.add("BeamupCorrection",Me({id:ge("BeamupCorrection"),client:{version:"ac0ccf7aaa725c4cd32d23e833f44b204891973f"},protocol:k(e,"id","version","beamup"),metadata:k(r,"id","type"),email:i[e.id]?.email??null,subject:{[s?"image":"observation"]:{id:n},contentHash:f||null},...be("file",m?k(m,"id","filename","contentType","dimensions"):void 0),before:{...a,value:E(a)},after:{...o,value:E(o)},occurredAt:new Date().toISOString()}))}async function K(...t){try{const e=await ee(()=>import("./BfjK8oC1.js").then(n=>n.aj),__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url);await Promise.all(t.map(n=>e.tables[n].refresh()))}catch(e){console.warn(`Cannot refresh tables ${t}:`,e)}}function je(t,e,n){const r=t.metadata[n];if(r!==void 0)return{...r,value:We(e,r.value)}}function E(t){return JSON.stringify(t instanceof Date&&V(t)?Pe(t,"yyyy-MM-dd'T'HH:mm:ss"):t)}function Ke(t){return j(t,({value:e,...n})=>({...n,value:E(e)}))}async function W({db:t,subjectId:e,metadataId:n,type:r,value:a,confidence:o=1,alternatives:i=[],manuallyModified:s=!1,cascadedFrom:c=[],abortSignal:m,protocol:f}){let u=null;if(!N(n))throw new Error(`Le metadataId ${n} n'est pas namespacé`);m?.throwIfAborted();const l={value:E(a),confidence:o,manuallyModified:s,alternatives:Object.fromEntries(i.map(g=>[E(g.value),g.confidence]))};l.alternatives=Object.fromEntries(Object.entries(l.alternatives).filter(([g])=>g!==l.value)),console.debug(`Store metadata ${n} = `,a,` in ${e}`,l);const b=await t.get("Metadata",n);if(!b)throw new Error(`Métadonnée inconnue avec l'ID ${n}`);if(r&&b.type!==r)throw new Error(`Type de métadonnée incorrect: ${b.type} !== ${r}`);m?.throwIfAborted();const h=await t.get("Image",e),M=await t.get("Observation",e),P=await t.getAll("Image").then(g=>g.filter(({fileId:w})=>w===e));if(m?.throwIfAborted(),h)n in h.metadata&&(u=structuredClone(h.metadata[n])),h.metadata[n]=l,t.put("Image",h);else if(M){if(n in M.metadataOverrides)u=structuredClone(M.metadataOverrides[n]);else if(M.images.length>0){const g=await t.getAll("Image").then(D=>D.filter(z=>M.images.includes(z.id))),w=J(b,g.filter(D=>D.metadata[n]).map(D=>D.metadata[n]).map(R.MetadataValue.assert));w&&(u={...w,value:E(w.value)})}M.metadataOverrides[n]=l,t.put("Observation",M)}else if(P)for(const{id:g}of P)await W({db:t,subjectId:g,metadataId:n,value:a,confidence:o,manuallyModified:s,abortSignal:m,protocol:f});else throw new Error(`Aucune image ou observation avec l'ID ${e}`);m?.throwIfAborted();const Z=await qe({db:t,metadataId:n,value:a,confidence:o,alternatives:i});for(const g of Z){if(m?.throwIfAborted(),c.includes(g.metadataId))throw new Error(`Boucle infinie de cascade détectée pour ${g.metadataId} avec ${g.value}: ${c.join(" -> ")} -> ${n} -> ${g.metadataId}`);console.info(`Cascading metadata ${n} @ ${a} -> ${g.metadataId}  = ${g.value}`);const w=N(n);if(!w)throw new Error(`Metadata ${n} is not namespaced, cannot cascade onto ${g.metadataId}`);g.metadataId=X(g.metadataId,w),await W({db:t,subjectId:e,manuallyModified:s,cascadedFrom:[...c,n],abortSignal:m,protocol:f,...g})}"beamup"in f&&u&&!u.manuallyModified&&s&&Ie(we(),f,e,b,he.assert(u),l).catch(console.error),c.length===0&&await K(h?"Image":"Observation")}async function Le({db:t,subjectId:e,metadataId:n,recursive:r=!1,reactive:a=!0}){const o=await t.get("Image",e),i=await t.get("Observation",e);if(!o&&!i)throw new Error(`Aucune image ou observation avec l'ID ${e}`);if(console.debug(`Delete metadata ${n} in ${e}`),o)delete o.metadata[n],t.put("Image",o);else if(i&&(delete i.metadataOverrides[n],t.put("Observation",i),r))for(const s of i.images)await Le({db:t,subjectId:s,recursive:!1,metadataId:n,reactive:!1});a&&await K("Image","Observation")}const Je=new Set(["boolean","integer","float","date","location","boundingbox","enum"]);async function Ue(t,e,n){const r=await A(t,e.map(s=>s.metadata)),a=await A(t,n.map(s=>s.metadataOverrides)),o=new Set([...Object.keys(r),...Object.keys(a)]),i={};for(const s of o){const c=a[s]??r[s];c&&(i[s]=c)}return i}async function A(t,e){if(e.length===1)return j(e[0],a=>({...a,merged:!1}));const n={},r=new Set(e.flatMap(a=>Object.keys(a)));for(const a of r){const o=R.Metadata.assert(await t.get("Metadata",a));if(!o){console.warn(`Cannot merge metadata values for unknown key ${a}`);continue}const i=e.flatMap(c=>Object.entries(c).filter(([m])=>m===a).map(([,m])=>m)),s=J(o,i);s!=null&&(n[a]={...s,merged:new Set(i.map(c=>JSON.stringify(c.value))).size>1})}return n}function J(t,e){const n=(r,a)=>Object.fromEntries(a.flatMap(o=>Object.keys(o.alternatives)).map(o=>[o,r(a.flatMap(i=>i.alternatives[o]??null).filter(Boolean))]));switch(t.mergeMethod){case"average":return{value:Ce(t.type,e.map(r=>r.value)),manuallyModified:e.some(r=>r.manuallyModified),confidence:x(e.map(r=>r.confidence)),alternatives:n(x,e)};case"max":case"min":return{value:_e(t.type,e,t.mergeMethod==="max"?$:Ne),manuallyModified:e.some(r=>r.manuallyModified),confidence:$(e.map(r=>r.confidence)),alternatives:n($,e)};case"median":return{value:Ge(t.type,e.map(r=>r.value)),manuallyModified:e.some(r=>r.manuallyModified),confidence:S(e.map(r=>r.confidence)),alternatives:n(S,e)};case"union":return{value:He(t.type,e.map(r=>r.value)),manuallyModified:e.some(r=>r.manuallyModified),confidence:x(e.map(r=>r.confidence)),alternatives:n(x,e)};case"none":return null}}const $=t=>Math.max(...t),Ne=t=>Math.min(...t);function _e(t,e,n){const r=Math.max(...e.map(o=>o.confidence)),a=e.filter(o=>o.confidence===r);try{return n(a.map(o=>o.value))}catch(o){return console.error(o),a[0].value}}function Ce(t,e){const n=r=>x(U(t,r));if(t==="boolean")return n(e)>.5;if(t==="integer")return Math.ceil(n(e));if(t==="float")return n(e);if(t==="date")return new Date(n(e));if(t==="location")return{latitude:x(e.map(r=>r.latitude)),longitude:x(e.map(r=>r.longitude))};throw new Error(`Impossible de fusionner en mode moyenne des valeurs de type ${t}`)}const S=t=>{const e=t.sort((r,a)=>r-a),n=Math.floor(e.length/2);return e.length%2===0?(e[n-1]+e[n])/2:e[n]};function Ge(t,e){const n=r=>S(U(t,r));if(t==="boolean")return n(e)>.5;if(t==="integer")return Math.ceil(n(e));if(t==="float")return n(e);if(t==="date")return new Date(n(e));if(t==="location")return{latitude:S(e.map(r=>r.latitude)),longitude:S(e.map(r=>r.longitude))};throw new Error(`Impossible de fusionner en mode médiane des valeurs de type ${t}`)}function He(t,e){if(!Qe("boundingbox",t,e))throw new Error(`Impossible de fusionner en mode union des valeurs de type ${t}`);const n=Math.min(...e.map(i=>i.x)),r=Math.min(...e.map(i=>i.y)),a=Math.max(...e.map(i=>i.x+i.w)),o=Math.max(...e.map(i=>i.y+i.h));return{x:n,y:r,w:a-n,h:o-r}}function U(t,e){if(t==="integer"||t==="float")return e;if(t==="boolean")return e.map(n=>n?1:0);if(t==="date")return e.map(n=>new Date(n).getTime());throw new Error(`Impossible de convertir des valeurs de type ${t} en nombre`)}function B(t,e,n){const r=a=>e===t&&(n===void 0||!(a(n)instanceof p.errors));switch(t){case"boolean":return r(p("boolean"));case"integer":case"float":return r(p("number"));case"enum":return r(p("string | number"));case"date":return r(p("Date"));case"location":return r(p({latitude:"number",longitude:"number"}));case"boundingbox":return r(p({x:"number",y:"number",w:"number",h:"number"}));case"string":return r(p("string"));default:throw new Error(`Type inconnu: ${t}`)}}function Qe(t,e,n){return n.every(r=>B(t,e,r))}function Ze(t,e){return B(t,t,e)}function We(t,e){if(!B(t,t,e))throw new Error(`La valeur n'est pas de type ${t}: ${JSON.stringify(e)}`);return e}function ze(t){return(e,n)=>(typeof e!="string"&&(e=e.id),typeof n!="string"&&(n=n.id),t.metadataOrder?t.metadataOrder.indexOf(e)-t.metadataOrder.indexOf(n):le(e,n))}function et(t,e){if(e){const n=X(e,t);return IDBKeyRange.bound(n+":",n+":￿")}else return IDBKeyRange.bound(L("",t),L("￿",t))}export{Je as M,d as a,ze as b,We as c,Le as d,Ke as e,E as f,je as g,Ze as h,A as i,B as j,Pe as k,Ue as l,et as m,xe as n,W as s};
