import"../chunks/DsnmJJEf.js";import{p as ne,g as a,u as A,c as X,aj as j,D as q,F as D,a as l,b as le,al as h,I as H,ak as d,ai as C,K as n,H as B,am as de,G as me}from"../chunks/Dt6m180S.js";import{s as G}from"../chunks/BqMK6M8M.js";import{i as E}from"../chunks/cmrSGx3m.js";import{c as ce}from"../chunks/BptB6vFW.js";import{t as Q,a as Y,f as Z}from"../chunks/DM93I2Od.js";import{b as fe,c as ve,s as pe}from"../chunks/CoW7fDOc.js";import{w as ue}from"../chunks/C02cds9o.js";import{A as ge}from"../chunks/CcbyKDVt.js";import{B as _e}from"../chunks/BWvVnymT.js";import{C as be}from"../chunks/ChS1jMTj.js";import{C as Ie}from"../chunks/C_tRnt_U.js";import{c as $,a as ye,b as he}from"../chunks/62CSzXnv.js";import{t as u}from"../chunks/h9n_zjAt.js";import{a as Ce,b as Ae,c as we,d as xe,e as Me}from"../chunks/CXutPItK.js";import{l as Se}from"../chunks/yErRaHIP.js";import{L as ee}from"../chunks/DJljq93Y.js";import{m as Oe}from"../chunks/DwQPgNTU.js";import{e as Pe,d as Fe}from"../chunks/Z9u04OLA.js";import{g as ke}from"../chunks/CoCzgeuV.js";import{P as ze}from"../chunks/1LLQNKI6.js";import{s as Le}from"../chunks/DDk1L18j.js";import{u as r}from"../chunks/fpNj8U5y.js";import{i as Be,n as ae}from"../chunks/C0SiBqD8.js";const Ee=K=>{var w=q(),o=D(w);{var g=m=>{const x=A(()=>{const{model:O}=r.classificationModels[r.selectedClassificationModel];return{model:O}}),M=A(()=>new URL(typeof a(x).model=="string"?a(x).model:a(x).model?.url));var c=Re(),f=d(c),S=d(f,!0);n(f),n(c),B((O,R)=>{pe(c,"href",O),G(S,R)},[()=>a(M).toString(),()=>a(M).pathname.split("/").at(-1)]),l(m,c)};E(o,m=>{r.classificationInferenceAvailable&&m(g)})}l(K,w)};var Re=H('<a target="_blank"><code> </code></a>'),Te=H('<section class="loading svelte-1o687fz"><!> <p> </p> <p class="source svelte-1o687fz"><!></p> <div class="progressbar svelte-1o687fz"><!></div></section>'),Ue=H('<div class="empty svelte-1o687fz"><svelte-css-wrapper style="display: contents"><!></svelte-css-wrapper> <p> </p> <!></div>'),Ve=H("<section><!> <!></section>");function ma(K,w){ne(w,!0);const o=A(()=>fe("main"));Le({title:a(o)(61)});const g=A(()=>u.Observation.state.map(e=>({id:e.id,sessionId:e.sessionId,addedAt:e.addedAt,name:e.label,metadata:Oe({definitions:u.Metadata.state,images:e.images.map(t=>u.Image.getFromState(t)).filter(ae),observations:[e]}),virtual:!1,data:{image:void 0,observation:e,images:e.images.map(t=>u.Image.getFromState(t)).filter(ae)}})));let m=j("");const x=A(()=>[a(m),a(g).find(e=>e.id===a(m))?.data.images.map(e=>({id:e.id,name:e.filename,addedAt:e.addedAt,virtual:!1,data:{image:e,observation:void 0,images:[e]}}))??[]]);let M=j(0),c=new AbortController,f=j(!1),S=j(void 0);async function O(){if(a(f)||!r.currentProtocol||!r.classificationInferenceAvailable)return;const e=ye(r.currentProtocol,r.selectedClassificationModel);if(!e){Q.error(a(o)(33,[r.selectedClassificationModel,r.currentProtocol.name]));return}c.abort(),h(S,void 0),c=new AbortController,await Se(w.data.swarpc,"classification",{abortSignal:c.signal,protocolId:r.currentProtocol.id,requests:{model:e.model,classmapping:e.classmapping},onProgress(t){h(M,t,!0)}})}X(()=>{if(!r.classificationInferenceAvailable||!a(f)||a(S))return;const e=u.Image.state.filter(t=>Ce(t)&&!Ae(t)&&!r.loadingImages.has(t.id)&&(r.currentProtocol?.crop.classifyUncropped?!0:r.cropMetadataValueOf(t)));$(e.map(t=>t.id))}),ue(()=>r.selectedClassificationModel,()=>{h(f,!1),O().catch(e=>{h(S,e,!0),!Be(e)&&(console.error(e),Q.error(a(o)(90)))}).then(()=>{h(f,!0)})}),X(()=>{r.setSelection&&Pe()});var R=q(),te=D(R);{var re=e=>{var t=Te(),P=d(t);ee(P,{loading:!0});var _=C(P,2),N=d(_,!0);n(_);var F=C(_,2),b=d(F);Ee(b),n(F);var v=C(F,2),i=d(v);ze(i,{percentage:!0,alwaysActive:!0,get progress(){return a(M)}}),n(v),n(t),B(p=>G(N,p),[()=>a(o)(55)]),Y(1,t,()=>Z,()=>({duration:100})),l(e,t)},se=e=>{var t=Ve();let P;var _=d(t);ge(_,{get items(){return a(g)},get unroll(){return a(x)},zone:"classify",item:(v,i,p)=>{let T=()=>i?.().observation,U=()=>i?.().image,k=()=>i?.().images,s=()=>p?.().id;var z=q(),W=D(z);{var oe=I=>{{let V=A(()=>a(o)(29));Ie(I,{get observation(){return T()},get images(){return k()},boxes:"apply-first",get loadingStatusText(){return a(V)},onstacksizeclick:()=>{h(m,a(m)===s()?"":s(),!0)},onretry:()=>{r.erroredImages.delete(s());const y=u.Observation.getFromState(s())?.images;y?(y.forEach(L=>r.erroredImages.delete(L)),$(y)):Q.error(a(o)(194,[s()]))},ondelete:async()=>{(u.Observation.getFromState(s())?.images??[s()]).forEach(L=>he(L,"Cancelled by user")),we(s())&&await xe(Me(s())),await Fe(s(),{notFoundOk:!0,recursive:!0})}})}},ie=I=>{var V=q(),y=D(V);{var L=J=>{be(J,{get image(){return U()},boxes:"apply-first"})};E(y,J=>{U()&&J(L)},!0)}l(I,V)};E(W,I=>{T()?I(oe):I(ie,!1)})}l(v,z)},$$slots:{item:!0}});var N=C(_,2);{var F=b=>{var v=Ue(),i=d(v);ce(i,()=>({"--size":"6em"})),ee(i.lastChild,{variant:"empty"}),n(i);var p=C(i,2),T=d(p,!0);n(p);var U=C(p,2);_e(U,{onclick:()=>ke("/import"),children:(k,s)=>{de();var z=me();B(W=>G(z,W),[()=>a(o)(104)]),l(k,z)},$$slots:{default:!0}}),n(v),B(k=>G(T,k),[()=>a(o)(37)]),l(b,v)};E(N,b=>{a(g).length||b(F)})}n(t),B(()=>P=ve(t,1,"observations svelte-1o687fz",null,P,{empty:!a(g).length})),Y(1,t,()=>Z,()=>({duration:100})),l(e,t)};E(te,e=>{a(f)?e(se,!1):e(re)})}l(K,R),le()}export{ma as component};
