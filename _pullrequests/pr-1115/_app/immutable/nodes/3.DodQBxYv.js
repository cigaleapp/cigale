import"../chunks/DsnmJJEf.js";import{f as we,a as c,p as ye,al as re,aj as je,g as e,u as i,I as L,ak as C,ai as F,K as T,H as E,b as xe,F as P,D as B,G as de,J as ze}from"../chunks/Dt6m180S.js";import{s as Ce}from"../chunks/BEu91mT_.js";import{r as Se,i as k}from"../chunks/cmrSGx3m.js";import{a as De,f as Ae,t as Re}from"../chunks/DM93I2Od.js";import{a as Oe,c as ke,b as Me,s as ge}from"../chunks/CoW7fDOc.js";import{p as ce}from"../chunks/BQgdUy12.js";import{t as Ee}from"../chunks/yErRaHIP.js";import{m as Le,p as He}from"../chunks/BgPK52sz.js";import{l as Ve,t as x,p as me,o as ve,v as pe}from"../chunks/h9n_zjAt.js";import{g as Be,d as _e,e as We}from"../chunks/CXutPItK.js";import{e as Ke,b as qe,i as Ne,A as Ue}from"../chunks/62CSzXnv.js";import"../chunks/C0SiBqD8.js";import{m as Ge}from"../chunks/DwQPgNTU.js";import{m as Je,d as Ye,a as Qe}from"../chunks/BHxAX_Yx.js";import{d as Xe,n as Ze,m as et}from"../chunks/Z9u04OLA.js";import{s as tt}from"../chunks/DDk1L18j.js";import{u as o}from"../chunks/fpNj8U5y.js";import{s as U}from"../chunks/BqMK6M8M.js";import{e as he,i as at}from"../chunks/Bmx3KKup.js";import{w as rt}from"../chunks/C02cds9o.js";import{D as nt}from"../chunks/C0se_-sl.js";import{F as st}from"../chunks/ByO0j4mQ.js";import{I as ot}from"../chunks/nVGfHLWF.js";import{S as it}from"../chunks/C4Q0pa3Y.js";import{B as ne}from"../chunks/BWvVnymT.js";import{C as lt}from"../chunks/i0qVP9iW.js";import{I as dt}from"../chunks/DRBqBfVL.js";import{L as be}from"../chunks/DJljq93Y.js";import{M as ct,a as mt}from"../chunks/CzFwc0eK.js";import{a as ut}from"../chunks/JZH0u_ZA.js";import{R as se}from"../chunks/CH5FdpMr.js";var Ie=Object.prototype.hasOwnProperty;function ue(m,r){var t,f;if(m===r)return!0;if(m&&r&&(t=m.constructor)===r.constructor){if(t===Date)return m.getTime()===r.getTime();if(t===RegExp)return m.toString()===r.toString();if(t===Array){if((f=m.length)===r.length)for(;f--&&ue(m[f],r[f]););return f===-1}if(!t||typeof m=="object"){f=0;for(t in m)if(Ie.call(m,t)&&++f&&!Ie.call(r,t)||!(t in r)||!ue(m[t],r[t]))return!1;return Object.keys(r).length===f}}return m!==m&&r!==r}var ft=we('<svg><path fill="currentColor" d="M13 19.9a5 5 0 0 0 4-4.9v-3c0-.701-.144-1.378-.415-2h-9.17A5 5 0 0 0 7 12v3a5 5 0 0 0 4 4.9V14h2zm-7.464-2.21A7 7 0 0 1 5 15H2v-2h3v-1c0-.643.087-1.265.249-1.856L3.036 8.866l1-1.732L6.056 8.3a7 7 0 0 1 .199-.3h11.49q.103.148.199.3l2.02-1.166l1 1.732l-2.213 1.278c.162.59.249 1.213.249 1.856v1h3v2h-3a7 7 0 0 1-.536 2.69l2.5 1.444l-1 1.732l-2.526-1.458A6.99 6.99 0 0 1 12 22a6.99 6.99 0 0 1-5.438-2.592l-2.526 1.458l-1-1.732zM8 6a4 4 0 1 1 8 0z"></path></svg>');function gt(m,r){const t=Se(r,["$$slots","$$events","$$legacy"]);var f=ft();Oe(f,()=>({class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t})),c(m,f)}var vt=we('<svg><path fill="currentColor" d="M4 19h16v-7h2v8a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-8h2zm9-10v7h-2V9H6l6-6l6 6z"></path></svg>');function pt(m,r){const t=Se(r,["$$slots","$$events","$$legacy"]);var f=vt();Oe(f,()=>({class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...t})),c(m,f)}var _t=L("<img/>"),ht=L("<!> <!>",1),bt=L("<!> ",1),It=L('<div class="images svelte-xtkozr"></div> <h2 class="svelte-xtkozr"><!></h2> <!>',1),wt=L('<section class="empty-selection svelte-xtkozr"><!> <p> </p></section>'),yt=L('<section class="empty-selection svelte-xtkozr"><!> <p> </p></section>'),xt=L('<div class="side-by-side svelte-xtkozr"><!> <!></div>'),St=L('<aside data-testid="sidepanel"><!> <section class="button svelte-xtkozr"><!> <!> <!></section></aside>');function Ot(m,r){ye(r,!0);const t=i(()=>Me("main")),f=i(()=>{const a=x.Protocol.state.find(s=>s.id===o.currentProtocolId);return a?a.metadata.filter(s=>!a.sessionMetadata.includes(s)).map(s=>x.Metadata.state.find(l=>l.id===s)).filter(s=>s!==void 0).toSorted(Le(a)):[]}),$={};let j=je(!0);rt([()=>e(f)],()=>{if(!o.currentProtocolId){re(j,!1);return}if(Object.keys($).length>0){re(j,!1);return}Ve("MetadataOption",Je(o.currentProtocolId,null)).then(a=>{if(Object.keys($).length>0){re(j,!1);return}for(const{metadataId:s,key:l,...d}of a)$[s]??=[],$[s].push({key:l.toString(),...d});for(const s of Object.keys($))$[s].sort((l,d)=>l.label.localeCompare(d.label));re(j,!1)})});const X=i(()=>ut().showTechnicalMetadata),D=i(()=>o.selection.length===1?x.Observation.state.find(a=>a.id===o.selection[0]):void 0),G=i(()=>o.selection.length===1?x.Image.state.find(a=>[a.id,a.fileId].includes(o.selection[0])):void 0),A=i(()=>({image:o.selection.filter(a=>x.Image.state.some(s=>[s.id,s.fileId].includes(a))).length,observation:o.selection.filter(a=>x.Observation.state.some(s=>s.id===a)).length,get all(){return this.image+this.observation}}));var K=St();let Z;var H=C(K);{var ee=a=>{var s=It(),l=P(s);he(l,21,()=>r.images,at,(_,w,h)=>{let V=()=>e(w).src,z=()=>e(w).box;const b=i(()=>e(D)?`Image ${h+1} de l'observation ${e(D).label}`:`Image ${h+1} de la sÃ©lection`);var O=B(),R=P(O);{var W=y=>{lt(y,{blurfill:!0,get src(){return V()},get alt(){return e(b)},get box(){return z()}})},Y=y=>{var M=_t();E(()=>{ge(M,"src",V()),ge(M,"alt",e(b))}),c(y,M)};k(R,y=>{z()?y(W):y(Y,!1)})}c(_,O)}),T(l);var d=F(l,2),u=C(d);{var p=_=>{var w=ht(),h=P(w);gt(h,{});var V=F(h,2);{let z=i(()=>e(t)(126));dt(V,{get label(){return e(z)},get value(){return e(D).label},onblur:async b=>{b!==e(D).label&&await x.Observation.update(e(D).id,"label",b)}})}c(_,w)},S=_=>{var w=B(),h=P(w);{var V=b=>{var O=bt(),R=P(O);ot(R,{});var W=F(R);E(()=>U(W,` ${e(G).filename??""}`)),c(b,O)},z=b=>{var O=B(),R=P(O);{var W=y=>{var M=de();E(q=>U(M,q),[()=>me(e(A).all,e(t).p(338),e(t)._.p)]),c(y,M)},Y=y=>{var M=B(),q=P(M);{var Pe=N=>{var Q=de();E(ie=>U(Q,ie),[()=>me(e(A).image,e(t).p(339),e(t)._.p)]),c(N,Q)},Fe=N=>{var Q=B(),ie=P(Q);{var Te=le=>{var fe=de();E($e=>U(fe,$e),[()=>me(e(A).observation,e(t).p(340),e(t)._.p)]),c(le,fe)};k(ie,le=>{e(A).observation>0&&le(Te)},!0)}c(N,Q)};k(q,N=>{e(A).image>0?N(Pe):N(Fe,!1)},!0)}c(y,M)};k(R,y=>{e(A).image>0&&e(A).observation>0?y(W):y(Y,!1)},!0)}c(b,O)};k(h,b=>{e(G)?b(V):b(z,!1)},!0)}c(_,w)};k(u,_=>{e(D)?_(p):_(S,!1)})}T(d);var I=F(d,2);ct(I,{children:(_,w)=>{var h=B(),V=P(h);he(V,17,()=>e(f),z=>z.id,(z,b)=>{const O=i(()=>r.metadata[e(b).id]);var R=B(),W=P(R);{var Y=y=>{{let M=i(()=>e(O)?.merged);mt(y,{get merged(){return e(M)},get definition(){return e(b)},get value(){return e(O)},get options(){return $[e(b).id]},onchange:async q=>{ue(q,e(O)?.value)||r.onmetadatachange(e(b).id,q)}})}};k(W,y=>{(e(b).label||e(X))&&y(Y)})}c(z,R)}),c(_,h)}}),c(a,s)},J=a=>{var s=B(),l=P(s);{var d=p=>{var S=wt(),I=C(S);be(I,{variant:"empty"});var _=F(I,2),w=C(_,!0);T(_),T(S),E(h=>U(w,h),[()=>e(t)(54)]),c(p,S)},u=p=>{var S=yt(),I=C(S);be(I,{variant:"empty"});var _=F(I,2),w=C(_,!0);T(_),T(S),E(h=>U(w,h),[()=>e(t)(162)]),c(p,S)};k(l,p=>{e(j)?p(d):p(u,!1)},!0)}c(a,s)};k(H,a=>{r.images.length>0&&!e(j)?a(ee):a(J,!1)})}var te=F(H,2),ae=C(te);{var oe=a=>{var s=xt(),l=C(s);{const u=I=>{it(I,{})};let p=i(()=>!r.canmerge),S=i(()=>e(t)(144));ne(l,{get disabled(){return e(p)},get onclick(){return r.onmerge},keyboard:"$mod+g",get help(){return e(S)},_w_snippet_0:u,children:(I,_)=>{{let w=i(()=>[u]),h=i(()=>e(t).c(10));se(I,{get t(){return e(w)},get x(){return e(h)}})}},$$slots:{_w_snippet_0:!0,default:!0}})}var d=F(l,2);{const u=I=>{st(I,{})};let p=i(()=>!r.cansplit),S=i(()=>e(t)(163));ne(d,{get disabled(){return e(p)},get onclick(){return r.onsplit},keyboard:"$mod+Shift+g",get help(){return e(S)},_w_snippet_1:u,children:(I,_)=>{{let w=i(()=>[u]),h=i(()=>e(t).c(17));se(I,{get t(){return e(w)},get x(){return e(h)}})}},$$slots:{_w_snippet_1:!0,default:!0}})}T(s),c(a,s)};k(ae,a=>{r.onmerge&&r.onsplit&&a(oe)})}var n=F(ae,2);{var g=a=>{{const s=l=>{pt(l,{})};ne(a,{get onclick(){return r.onimport},_w_snippet_2:s,children:(l,d)=>{{let u=i(()=>[s]),p=i(()=>e(t).c(6));se(l,{get t(){return e(u)},get x(){return e(p)}})}},$$slots:{_w_snippet_2:!0,default:!0}})}};k(n,a=>{r.onimport&&a(g)})}var v=F(n,2);{const a=d=>{nt(d,{})};let s=i(()=>r.images.length===0),l=i(()=>e(t)(158));ne(v,{get disabled(){return e(s)},get onclick(){return r.ondelete},keyboard:"Delete",get help(){return e(l)},danger:!0,_w_snippet_3:a,children:(d,u)=>{{let p=i(()=>[a]),S=i(()=>e(t).c(16)),I=i(()=>[r.images.length]);se(d,{get t(){return e(p)},get x(){return e(S)},get a(){return e(I)}})}},$$slots:{_w_snippet_3:!0,default:!0}})}T(te),T(K),E(()=>Z=ke(K,1,"sidepanel svelte-xtkozr",null,Z,{empty:r.images.length===0||e(j)})),c(m,K),xe()}var kt=L('<div><main data-testid="app-main" class="svelte-di4wkt"><!></main> <!></div>');function sa(m,r){ye(r,!0);const t=i(()=>Me("main"));tt({title:e(t)(104)});async function f(){Ne(await He({accept:Ue,multiple:!0}))}async function $(){const n=await et(o.selection);o.setSelection?.([n])}async function j(){const n=[],g=o.currentProtocol;if(!g)throw new Error("No protocol selected");await ve(["Image","Observation"],{mode:"readwrite"},async v=>{if(!o.currentSession)throw new Error("No session selected, cannot split observations");for(const a of o.selection){const s=x.Observation.getFromState(a);if(s){v.objectStore("Observation").delete(a);for(const l of s.images){const d=await v.objectStore("Image").get(l);if(!d)continue;const u=Ze(d,g,o.currentSession);v.objectStore("Observation").add(u),n.push(u.id)}}}}),o.setSelection?.(n)}async function X(){await ve(["Image","Observation","ImageFile","ImagePreviewFile"],{},async n=>{for(const g of o.selection)qe(g,"Cancelled by user"),await Xe(g,{tx:n,notFoundOk:!0,recursive:!0}),await _e(g,n,!0),await _e(We(g),n,!0)}),o.setSelection?.([])}Ke("observations",{"x x":{help:e(t)(190),debug:!0,do(){for(const n of o.selection)o.erroredImages.has(n)||o.erroredImages.set(n,"Errored!")}},"x u":{help:e(t)(191),debug:!0,do(){for(const n of o.selection)o.erroredImages.delete(n)}},"x f":{help:e(t)(192),debug:!0,do(){o.processing.files.push({id:Be(),name:"Debug image.jpeg",addedAt:new Date})}},"$mod+g":{help:e(t)(96),do:$},"$mod+Shift+g":{help:e(t)(163),do:j},Delete:{help:e(t)(156),do:X}});let D=i(()=>o.processing.files.length+x.Observation.state.length+x.Image.state.length>0);const G=i(()=>o.selection.flatMap(n=>{const g=x.Image.state.find(v=>[v.fileId,v.id].includes(n));return g?[g]:x.Observation.state.find(v=>v.id===n)?.images.map(v=>x.Image.state.find(a=>a.id===v)).filter(v=>v!==void 0)}).filter(n=>n!==void 0)),A=i(()=>o.selection.map(n=>x.Observation.state.find(g=>g.id===n)).filter(n=>n!==void 0)),K=i(()=>e(G).map(n=>{if(!n.fileId)return;const g=o.getPreviewURL(n.fileId);if(!g)return;const v=o.cropMetadataValueOf(n)?.value;return{src:g,box:v?Ee(v):void 0}}).filter(n=>n!==void 0));let Z=i(()=>{if(!o.currentProtocol)return{};try{return Ge({definitions:x.Metadata.state,images:e(G),observations:e(A)})}catch(n){return console.error(n),Re.error(n),{}}});var H=kt();let ee;var J=C(H),te=C(J);Ce(te,()=>r.children??ze),T(J);var ae=F(J,2);{var oe=n=>{{let g=i(()=>o.selection.length>0),v=i(()=>ce.route.id?.endsWith("classify")?$:void 0),a=i(()=>o.selection.some(d=>x.Observation.state.some(u=>u.id===d))),s=i(()=>ce.route.id?.endsWith("classify")?j:void 0),l=i(()=>ce.route.id?.endsWith("import")?f:void 0);Ot(n,{get images(){return e(K)},get metadata(){return e(Z)},get canmerge(){return e(g)},get onmerge(){return e(v)},get cansplit(){return e(a)},get onsplit(){return e(s)},get onimport(){return e(l)},ondelete:X,onaddmetadata:()=>{},onmetadatachange:async(d,u)=>{if(o.currentProtocol)for(const p of o.selection)u===void 0?await Ye({db:pe(),sessionId:o.currentSession?.id,subjectId:p,metadataId:d,recursive:!0}):await Qe({db:pe(),sessionId:o.currentSession?.id,subjectId:p,metadataId:d,confidence:1,manuallyModified:!0,value:u})}})}};k(ae,n=>{e(D)&&n(oe)})}T(H),E(()=>ee=ke(H,1,"main-and-sidepanel svelte-di4wkt",null,ee,{"has-sidepanel":e(D)})),De(1,H,()=>Ae,()=>({duration:100})),c(m,H),xe()}export{sa as component};
