import{e as gt}from"../chunks/CTlA2v4V.js";import{d as z,t as B,a as pt,l as ht,y as st,p as rt,v as ot}from"../chunks/h9n_zjAt.js";import{n as wt,c as yt}from"../chunks/C0SiBqD8.js";import{m as xt,a as Mt,d as bt}from"../chunks/BHxAX_Yx.js";import"../chunks/DsnmJJEf.js";import{f as St,a as u,p as ut,J as kt,g as r,u as p,b as vt,I as b,ak as f,ai as y,K as _,H as M,D as et,F as V,G as K,al as It,am as it,aX as Pt}from"../chunks/Dt6m180S.js";import{s as P,e as nt}from"../chunks/BqMK6M8M.js";import{r as Ot,p as Lt,i as C,s as jt}from"../chunks/cmrSGx3m.js";import{e as Bt}from"../chunks/Bmx3KKup.js";import{a as At,t as Ct,f as Dt}from"../chunks/DM93I2Od.js";import{a as mt,C as Rt,b as ft,e as zt}from"../chunks/CoW7fDOc.js";import{i as $}from"../chunks/CyxF7S3o.js";import{B as Tt}from"../chunks/CSftjQJd.js";import{B as Et}from"../chunks/BWvVnymT.js";import{F as tt}from"../chunks/DwPLocwb.js";import{I as Vt}from"../chunks/DRBqBfVL.js";import{a as Ft,t as Ut}from"../chunks/C3lM_sxf.js";import{A as Ht}from"../chunks/KZAX_y5O.js";import{C as qt}from"../chunks/BpKhbQBB.js";import{B as Gt}from"../chunks/BLmbeBA7.js";import{D as Kt}from"../chunks/By2MCAXu.js";import{g as G}from"../chunks/CoCzgeuV.js";import{M as Jt,a as Xt}from"../chunks/CzFwc0eK.js";import{M as Qt}from"../chunks/Cht11lhj.js";import{s as lt,f as Wt}from"../chunks/62CSzXnv.js";import{R as Yt}from"../chunks/CH5FdpMr.js";async function Zt({params:{id:s},depends:t}){t(z("Session",s));const e=await B.Session.get(s),a=pt("js");e||gt(404,a(469)),t(z("Protocol",e.protocol));const n=await B.Protocol.get(e.protocol);if(!n)return{session:e,protocol:null,sessionMetadata:[],sessionMetadataOptions:{},counts:{observations:0,images:0}};const O=await Promise.all(n.sessionMetadata.map(o=>B.Metadata.get(o))).then(o=>o.filter(wt));O.forEach(({id:o})=>t(z("Metadata",o))),O.sort(yt(({id:o})=>n.metadataOrder?.indexOf(o)??-1));const L=O.map(o=>({def:o,value:e.metadata?.[o.id]})),v=await Promise.all(O.map(async o=>[o.id,o.type==="enum"?await ht("MetadataOption",xt(n.id,o.id)):[]])).then(o=>Object.fromEntries(o)),S={observations:await st("Observation","sessionId",e.id).then(o=>o.length),images:await st("Image","sessionId",e.id).then(o=>o.length)};return{session:e,protocol:n,sessionMetadata:L,sessionMetadataOptions:v,counts:S}}const Ee=Object.freeze(Object.defineProperty({__proto__:null,load:Zt},Symbol.toStringTag,{value:"Module"}));var dt=Object.prototype.hasOwnProperty;function ct(s,t,e){for(e of s.keys())if(F(e,t))return e}function F(s,t){var e,a,n;if(s===t)return!0;if(s&&t&&(e=s.constructor)===t.constructor){if(e===Date)return s.getTime()===t.getTime();if(e===RegExp)return s.toString()===t.toString();if(e===Array){if((a=s.length)===t.length)for(;a--&&F(s[a],t[a]););return a===-1}if(e===Set){if(s.size!==t.size)return!1;for(a of s)if(n=a,n&&typeof n=="object"&&(n=ct(t,n),!n)||!t.has(n))return!1;return!0}if(e===Map){if(s.size!==t.size)return!1;for(a of s)if(n=a[0],n&&typeof n=="object"&&(n=ct(t,n),!n)||!F(a[1],t.get(n)))return!1;return!0}if(e===ArrayBuffer)s=new Uint8Array(s),t=new Uint8Array(t);else if(e===DataView){if((a=s.byteLength)===t.byteLength)for(;a--&&s.getInt8(a)===t.getInt8(a););return a===-1}if(ArrayBuffer.isView(s)){if((a=s.byteLength)===t.byteLength)for(;a--&&s[a]===t[a];);return a===-1}if(!e||typeof s=="object"){a=0;for(e in s)if(dt.call(s,e)&&++a&&!dt.call(t,e)||!(e in t)||!F(s[e],t[e]))return!1;return Object.keys(t).length===a}}return s!==s&&t!==t}var Nt=St('<svg><path fill="currentColor" d="M18.207 9.043L12 2.836L5.793 9.043l1.414 1.414L12 5.664l4.793 4.793zM5.793 14.957L12 21.164l6.207-6.207l-1.414-1.414L12 18.336l-4.793-4.793z"></path></svg>');function $t(s,t){const e=Ot(t,["$$slots","$$events","$$legacy"]);var a=Nt();mt(a,()=>({class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...e})),u(s,a)}var te=b("<button><!> <!></button>"),ee=b('<code class="svelte-ngwarr"> </code>'),ae=b("<!> <!>",1),se=b('<div class="item svelte-ngwarr"><div class="label svelte-ngwarr"><div class="icon svelte-ngwarr"><!></div> </div> <div class="version svelte-ngwarr"><!></div></div>');function re(s,t){ut(t,!0);const e=p(()=>ft("main"));let a=Lt(t,"value",15);{const n=(v,S=kt)=>{var o=te();mt(o,()=>({class:"trigger",...S(),[Rt]:{"none-selected":!a()}}),void 0,void 0,void 0,"svelte-ngwarr");var w=f(o);{var D=h=>{var k=K();M(j=>P(k,j),[()=>B.Protocol.getFromState(a())?.name]),u(h,k)},A=h=>{var k=K();M(j=>P(k,j),[()=>r(e)(34)]),u(h,k)};C(w,h=>{a()?h(D):h(A,!1)})}var x=y(w,2);$t(x,{}),_(o),u(v,o)},O=(v,S,o)=>{let w=()=>S?.().protocol,D=()=>o?.().label;var A=se(),x=f(A),h=f(x),k=f(h);{var j=i=>{qt(i,{})},J=i=>{var c=et(),d=V(c);{var m=g=>{Ht(g,{})};C(d,g=>{w()||g(m)},!0)}u(i,c)};C(k,i=>{a()===w()?.id?i(j):i(J,!1)})}_(h);var X=y(h);_(x);var T=y(x,2),Q=f(T);{var l=i=>{var c=ae(),d=V(c);{var m=I=>{var R=ee(),U=f(R);_(R),Ft(R,(W,E)=>Ut?.(W,E),()=>"Version du protocole"),M(()=>P(U,`v${w().version??""}`)),u(I,R)};C(d,I=>{w().version&&I(m)})}var g=y(d,2);Gt(g,jt({compact:!0},w)),u(i,c)};C(Q,i=>{w()&&i(l)})}_(T),_(A),M(()=>P(X,` ${D()??""}`)),u(v,A)};let L=p(()=>[{label:"Choisir un protocole",items:B.Protocol.state.map(v=>({type:"selectable",data:{protocol:v},key:v.id,label:v.name,selected:a()===v.id,async onclick(){a(v.id),await t.onchange?.(a())}}))},{items:[{type:"clickable",data:{protocol:null},label:"GÃ©rer les protocoles",async onclick(){await G("/protocols")}}]}]);Kt(s,{get testid(){return t.testid},get items(){return r(L)},trigger:n,item:O,$$slots:{trigger:!0,item:!0}})}vt()}var oe=b("<textarea></textarea>"),ie=b('<code class="svelte-1xkdn1f"> </code>'),ne=b('<section class="error svelte-1xkdn1f"><!></section>'),le=b('<h2> </h2> <form class="metadata svelte-1xkdn1f" data-testid="session-metadata"><!></form>',1),de=b("<code> </code>"),ce=b('<main class="svelte-1xkdn1f"><h1 class="svelte-1xkdn1f"><!> <section class="actions svelte-1xkdn1f"><!> <!></section></h1> <form class="svelte-1xkdn1f"><!> <!></form> <!> <!> <!></main>');function Ve(s,t){ut(t,!0);const e=p(()=>ft("main"));let a=p(()=>t.data.sessionMetadata),n=p(()=>t.data.session),O=p(()=>r(n).protocol),L=p(()=>r(n).name);var v=ce(),S=f(v),o=f(S);{let l=p(()=>r(e)(392));Vt(o,{discreet:!0,get label(){return r(l)},get value(){return r(L)},placeholder:"",onblur:async i=>{i!==r(L)&&(await B.Session.update(t.data.session.id,"name",i),It(L,i),$(z("Session",t.data.session.id)))}})}var w=y(o,2),D=f(w);{let l=p(()=>[rt(t.data.counts.images,r(e).p(402),r(e)._.p),rt(t.data.counts.observations,r(e).p(403),r(e)._.p)]);Qt(D,{key:"modal_delete_session",get typeToConfirm(){return r(L)},get consequences(){return r(l)},onconfirm:async()=>{await Wt(t.data.session.id),Ct.success(r(e)(393)),await G("/sessions")}})}var A=y(D,2);Et(A,{onclick:async()=>{await lt(t.data.session.id),await G("/import")},children:(l,i)=>{it();var c=K();M(d=>P(c,d),[()=>r(e)(394)]),u(l,c)},$$slots:{default:!0}}),_(w),_(S);var x=y(S,2),h=f(x);{let l=p(()=>r(e)(273));tt(h,{get label(){return r(l)},children:(i,c)=>{var d=oe();Pt(d),M(()=>zt(d,t.data.session.description)),nt("blur",d,async({target:m})=>{m instanceof HTMLTextAreaElement&&(await B.Session.update(t.data.session.id,"description",m.value),$(z("Session",t.data.session.id)))}),u(i,d)}})}var k=y(h,2);{let l=p(()=>r(e)(395));tt(k,{composite:!0,get label(){return r(l)},children:(i,c)=>{re(i,{testid:"protocol",get value(){return r(O)},onchange:async d=>{await B.Session.update(t.data.session.id,"protocol",d),$(z("Session",t.data.session.id))}})}})}_(x);var j=y(x,2);{var J=l=>{var i=ne();{const d=m=>{var g=ie(),I=f(g,!0);_(g),M(()=>P(I,t.data.session.protocol)),u(m,g)};var c=f(i);{let m=p(()=>[d]),g=p(()=>r(e).c(404));Yt(c,{get t(){return r(m)},get x(){return r(g)}})}_(i)}u(l,i)},X=l=>{var i=et(),c=V(i);{var d=m=>{var g=le(),I=V(g),R=f(I,!0);_(I);var U=y(I,2),W=f(U);Jt(W,{children:(E,ue)=>{var at=et(),_t=V(at);Bt(_t,17,()=>r(a),({def:Y,value:Z})=>Y.id,(Y,Z)=>{let H=()=>r(Z).def,N=()=>r(Z).value;Xt(Y,{get options(){return t.data.sessionMetadataOptions[H().id]},get definition(){return H()},get value(){return N()},onchange:async q=>{console.log(q,N()),!F(q,N()?.value)&&(q!==void 0?await Mt({db:ot(),manuallyModified:!0,subjectId:t.data.session.id,metadataId:H().id,value:q}):await bt({db:ot(),subjectId:t.data.session.id,metadataId:H().id}))}})}),u(E,at)}}),_(U),M(E=>P(R,E),[()=>r(e)(396)]),u(m,g)};C(c,m=>{r(a).length>0&&m(d)},!0)}u(l,i)};C(j,l=>{t.data.protocol?l(X,!1):l(J)})}var T=y(j,2);Tt(T,{loading:!0,onclick:async()=>{await lt(t.data.session.id),await G("/import")},children:(l,i)=>{it();var c=K();M(d=>P(c,d),[()=>r(e)(386)]),u(l,c)},$$slots:{default:!0}});var Q=y(T,2);{let l=p(()=>r(e)(397));tt(Q,{get label(){return r(l)},children:(i,c)=>{var d=de(),m=f(d,!0);_(d),M(()=>P(m,t.data.session.id)),u(i,d)}})}_(v),nt("submit",x,l=>{l.preventDefault()}),At(1,v,()=>Dt,()=>({duration:100})),u(s,v),vt()}export{Ve as component,Ee as universal};
