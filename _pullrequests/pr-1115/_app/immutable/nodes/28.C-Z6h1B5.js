import"../chunks/DsnmJJEf.js";import{p as _e,c as Y,g as e,u as i,al as c,aj as R,an as we,I as O,H as z,a as h,b as xe,ai as _,ak as d,D as he,F as ye,J as G,G as ee,am as te,K as p,ao as $e}from"../chunks/Dt6m180S.js";import{s as x}from"../chunks/BqMK6M8M.js";import{i as be}from"../chunks/cmrSGx3m.js";import{a as ke,t as Se}from"../chunks/C3lM_sxf.js";import{c as Ie,b as Pe,d as Re}from"../chunks/CoW7fDOc.js";import{w as se}from"../chunks/C02cds9o.js";import{D as ze}from"../chunks/Cku3ZTO-.js";import{a as Le}from"../chunks/z0W9Yv9z.js";import{p as Te}from"../chunks/BQgdUy12.js";import{B as Ze}from"../chunks/BWvVnymT.js";import{d as Be}from"../chunks/BgPK52sz.js";import{g as Ne}from"../chunks/U1OIFfFg.js";import{k as L}from"../chunks/h9n_zjAt.js";import{p as k}from"../chunks/CXutPItK.js";import{I as Ue}from"../chunks/DRBqBfVL.js";import{L as je}from"../chunks/CJbDBvUJ.js";import{L as T,Z as Ae,a as re}from"../chunks/CPTesWAz.js";import{e as ae}from"../chunks/Z9u04OLA.js";import{R as Ce}from"../chunks/C6gbgflb.js";import{S as De}from"../chunks/BiVo_KZK.js";import{u}from"../chunks/fpNj8U5y.js";import{t as S}from"../chunks/DM93I2Od.js";import{e as Fe}from"../chunks/C0SiBqD8.js";import{R as oe}from"../chunks/CH5FdpMr.js";var He=O('<code class="size svelte-1t5c71w"><!></code>'),Me=O('<div class="numeric svelte-1t5c71w"><!> </div>'),Ee=O('<main class="svelte-1t5c71w"><header class="svelte-1t5c71w"><h1> </h1> <!></header> <div class="side-by-side svelte-1t5c71w"><section class="settings svelte-1t5c71w"><div class="include svelte-1t5c71w"><!></div> <div><div class="label svelte-1t5c71w"> </div> <!> <p class="fineprint svelte-1t5c71w"> </p></div></section> <section class="preview" data-testid="zip-preview"><h2> </h2> <div class="tree loading"><!></div></section></div></main>');function ft(ie,J){_e(J,!0);const Z=i(()=>J.data.swarpc);let y=R(!1),g=R("croppedonly"),n=i(()=>k(u.currentProtocol?.crop.padding??"0px")),I=i(()=>e(n).unitless===0?"none":e(n).unit==="px"?"customPixels":e(n).unitless===5?"small":e(n).unitless===10?"medium":"customPercent");Y(()=>{switch(e(I)){case"none":c(n,k("0px"));break;case"small":c(n,k("5%"));break;case"medium":c(n,k("10%"));break}}),Y(()=>{!e(y)&&u.processing.task==="export"&&u.processing.reset()});const v=i(()=>Pe("main"));async function ne(){if(await S.clear("exporter"),u.processing.reset(),c(y,!0),!u.currentSessionId){S.error(e(v)(419)),c(y,!1);return}try{await ae(),u.processing.task="export",u.processing.total=1,u.processing.done=0;const r=await e(Z).generateResultsZip.once({include:e(g),sessionId:u.currentSessionId,cropPadding:e(n).withUnit,jsonSchemaURL:new URL(Le("/results.schema.json"),Te.url.origin).toString()},({warning:l,progress:s})=>{if(l){const[t,{filename:a}]=l;switch(t){case"exif-write-error":S.warn(e(v)(373,[a]));break}}s&&(u.processing.done=s)});Be(r,"results.zip","application/zip")}catch(r){console.error(r),S.error(e(v)(374,[r]))}finally{c(y,!1)}}async function le(){if(!u.currentSessionId)return S.error(e(v)(420)),[];await ae();const r=await e(Z).previewResultsZip.once({include:e(g),sessionId:u.currentSessionId}),l=[];for(const[s,t]of Fe(r))Ne({tree:l,paths:t,provenance:s});return l}let B=R(void 0);se([()=>e(g)],()=>{c(B,void 0),(async()=>c(B,await le(),!0))()});let P=R(we({}));se([()=>e(g),()=>e(n)],()=>{c(P,{},!0),(async()=>u.currentSessionId&&c(P,await e(Z).estimateResultsZipSize.once({include:e(g),sessionId:u.currentSessionId,cropPadding:e(n).withUnit}),!0))()});const N={folder:T,children:Array(10).fill(T)};var U=Ee(),j=d(U),A=d(j),ce=d(A,!0);p(A);var de=_(A,2);{const r=s=>{var t=he(),a=ye(t);{var o=m=>{je(m,{})},f=m=>{ze(m,{})};be(a,m=>{e(y)?m(o):m(f,!1)})}h(s,t)},l=s=>{var t=He(),a=d(t);{const o=(m,$=G)=>{te();var w=ee();z(b=>x(w,`~${b??""}`),[()=>L($())]),h(m,w)};let f=i(()=>L(15e4));re(a,{get value(){return e(P).compressed},get mask(){return`~${e(f)??""}`},loaded:o,$$slots:{loaded:!0}})}p(t),ke(t,(o,f)=>Se?.(o,f),()=>"Taille estimée de l'archive .zip"),h(s,t)};Ze(de,{onclick:ne,_w_snippet_0:r,_w_snippet_1:l,children:(s,t)=>{{let a=i(()=>[r,l]),o=i(()=>e(v).c(421));oe(s,{get t(){return e(a)},get x(){return e(o)}})}},$$slots:{_w_snippet_0:!0,_w_snippet_1:!0,default:!0}})}p(j);var K=_(j,2),C=d(K),D=d(C),pe=d(D);Ce(pe,{options:[{key:"metadataonly",label:"Métadonnées seulement"},{key:"croppedonly",label:"Métadonnées et images recadrées"},{key:"full",label:"Métadonnées, images recadrées et images originales",subtext:"Permet de ré-importer les résultats ultérieurement"}],get value(){return e(g)},set value(r){c(g,r,!0)}}),p(D);var F=_(D,2);let q;var H=d(F),ue=d(H,!0);p(H);var Q=_(H,2);{const r=(s,t=G)=>{const a=i(()=>t()==="customPercent"?"%":"px");var o=Me();let f;var m=d(o);{let w=i(()=>t()==="customPercent"?"en pourcentage des dimensions de l'image":"en pixels"),b=i(()=>e(n).unitless===0?"0":e(n).unit===e(a)?e(n).unitless.toString():"?");Ue(m,{get label(){return e(w)},get value(){return e(b)},onblur:async ge=>{await $e();const E=Number.parseInt(ge,10);!isNaN(E)&&E>0&&(c(n,k(E+e(a))),c(I,t()))}})}var $=_(m);p(o),z(()=>{f=Re(o,"",f,{"--width":e(a)==="%"?"3ch":"4ch"}),x($,` ${e(a)??""}`)}),h(s,o)};let l=i(()=>e(v)(116));De(Q,{get"aria-label"(){return e(l)},options:["none","small","medium","customPercent","customPixels"],labels:{none:"Aucune",small:"5%",medium:"10%"},get value(){return e(I)},set value(s){c(I,s)},customOption:r,$$slots:{customOption:!0}})}var V=_(Q,2),me=d(V,!0);p(V),p(F),p(C);var W=_(C,2),M=d(W),ve=d(M,!0);p(M);var X=_(M,2),fe=d(X);{const r=s=>{const t=a=>{{const o=(m,$=G)=>{te();var w=ee();z(b=>x(w,`~${b??""}`),[()=>L($())]),h(m,w)};let f=i(()=>L(1e6));re(a,{get value(){return e(P).uncompressed},get mask(){return`~${e(f)??""}`},loaded:o,$$slots:{loaded:!0}})}};{let a=i(()=>[t]),o=i(()=>e(v).c(425));oe(s,{get t(){return e(a)},get x(){return e(o)}})}};let l=i(()=>e(B)??[T,T,...{metadataonly:[],croppedonly:[N],full:[N,N]}[e(g)]]);Ae(fe,{get tree(){return e(l)},rootHelp:r,$$slots:{rootHelp:!0}})}p(X),p(W),p(K),p(U),z((r,l,s,t)=>{x(ce,r),q=Ie(F,1,"crop-padding svelte-1t5c71w",null,q,{irrelevant:e(g)==="metadataonly"}),x(ue,l),x(me,s),x(ve,t)},[()=>e(v)(13),()=>e(v)(116),()=>e(v)(422),()=>e(v)(423)]),h(ie,U),xe()}export{ft as component};
