import{c as Ze}from"./Dt6m180S.js";import{s as ve}from"./CFbM8ao4.js";import{c as Rt,t as N,ae as He,af as Lt,b as te,a as je,l as Bt,v as Tt,h as Gt,a7 as Ot,ag as Mt,ah as kt,ai as Nt,o as Ut,A as _t,aj as zt,p as We,e as Vt}from"./h9n_zjAt.js";import{u as C}from"./fpNj8U5y.js";import{m as Ht,n as mt,r as pt,s as ht,h as ke,e as Ce,g as jt}from"./CXutPItK.js";import{f as Wt,g as Se}from"./yErRaHIP.js";import{e as Ne,k as qt,y as Jt,m as Pe,x as Ke,z as Xt,w as Yt,A as $t}from"./C0SiBqD8.js";import{b as Q,a as Qt,c as Zt,e as Ie}from"./BHxAX_Yx.js";import{t as _}from"./DM93I2Od.js";import{g as xe}from"./CoW7fDOc.js";import{a as Kt}from"./JZH0u_ZA.js";import{o as xt,a as dt}from"./D6d8D7oP.js";function gt(t,e){const i=Rt(t,e?.in);if(isNaN(+i))throw new RangeError("Invalid time value");let a="",r="";const c="-",m=":";{const u=Q(i.getDate(),2),x=Q(i.getMonth()+1,2);a=`${Q(i.getFullYear(),4)}${c}${x}${c}${u}`}{const u=i.getTimezoneOffset();if(u!==0){const d=Math.abs(u),v=Q(Math.trunc(d/60),2),b=Q(d%60,2);r=`${u<0?"+":"-"}${v}:${b}`}else r="Z";const x=Q(i.getHours(),2),P=Q(i.getMinutes(),2),y=Q(i.getSeconds(),2),f=a===""?"":"T",S=[x,P,y].join(m);a=`${a}${f}${S}${r}`}return a}const ei={general:"Général",observations:"Observations",navigation:"Navigation",cropping:"Recadrage",debugmode:"Debug mode"};function ti(t,e){xt(()=>{for(const[i,a]of Ne(e)){if(i in C.keybinds){console.warn(`Keybind ${i} already defined, not overriding.`);continue}C.keybinds[i]={group:ei[a.debug?"debugmode":t],...a}}}),dt(()=>{for(const i of qt(e))delete C.keybinds[i]})}async function ii(t,e,i){if(!C.currentProtocol)throw new Error("Aucun protocole sélectionné");if(!C.classificationMetadataId){console.warn("No metadata with neural inference defined, not analyzing image. Configure neural inference on a enum metadata (set metadata.<your metadata id>.infer.neural) if this was not intentional.");return}const{cancel:a,request:r}=t.classify.cancelable({imageId:e,metadataIds:{cropbox:C.cropMetadataId,target:C.classificationMetadataId},taskSettings:ai(C.currentProtocol,C.selectedClassificationModel)});i?.set(e,a),await r,await N.Image.refresh(C.currentSessionId)}function ai(t,e){const i=He.case({id:te.string.narrow(a=>t.metadata.includes(a)),type:'"enum"',infer:Lt},a=>a.infer.neural[e]).default(()=>{});return N.Metadata.state.map(a=>i(a)).filter(Boolean).at(0)}var be,et;function ni(){return et||(et=1,be={parseSections:function(t,e){var i,a;for(t.setBigEndian(!0);t.remainingLength()>0&&a!==218;){if(t.nextUInt8()!==255)throw new Error("Invalid JPEG section offset");a=t.nextUInt8(),a>=208&&a<=217||a===218?i=0:i=t.nextUInt16()-2,e(a,t.branch(0,i)),t.skip(i)}},getSizeFromSOFSection:function(t){return t.skip(1),{height:t.nextUInt16(),width:t.nextUInt16()}},getSectionName:function(t){var e,i;switch(t){case 216:e="SOI";break;case 196:e="DHT";break;case 219:e="DQT";break;case 221:e="DRI";break;case 218:e="SOS";break;case 254:e="COM";break;case 217:e="EOI";break;default:t>=224&&t<=239?(e="APP",i=t-224):t>=192&&t<=207&&t!==196&&t!==200&&t!==204?(e="SOF",i=t-192):t>=208&&t<=215&&(e="RST",i=t-208);break}var a={name:e};return typeof i=="number"&&(a.index=i),a}}),be}var De,tt;function St(){if(tt)return De;tt=1;function t(c,m){switch(c){case 1:return m.nextUInt8();case 3:return m.nextUInt16();case 4:return m.nextUInt32();case 5:return[m.nextUInt32(),m.nextUInt32()];case 6:return m.nextInt8();case 8:return m.nextUInt16();case 9:return m.nextUInt32();case 10:return[m.nextInt32(),m.nextInt32()];case 11:return m.nextFloat();case 12:return m.nextDouble();default:throw new Error("Invalid format while decoding: "+c)}}function e(c){switch(c){case 1:case 2:case 6:case 7:return 1;case 3:case 8:return 2;case 4:case 9:case 11:return 4;case 5:case 10:case 12:return 8;default:return 0}}function i(c,m){var u=m.nextUInt16(),x=m.nextUInt16(),P=e(x),y=m.nextUInt32(),f=P*y,S,d;if(f>4&&(m=c.openWithOffset(m.nextUInt32())),x===2){S=m.nextString(y);var v=S.indexOf("\0");v!==-1&&(S=S.substr(0,v))}else if(x===7)S=m.nextBuffer(y);else if(x!==0)for(S=[],d=0;d<y;++d)S.push(t(x,m));return f<4&&m.skip(4-f),[u,S,x]}function a(c,m,u){var x=m.nextUInt16(),P,y;for(y=0;y<x;++y)P=i(c,m),u(P[0],P[1],P[2])}function r(c){var m=c.nextString(6);if(m!=="Exif\0\0")throw new Error("Invalid EXIF header");var u=c.mark(),x=c.nextUInt16();if(x===18761)c.setBigEndian(!1);else if(x===19789)c.setBigEndian(!0);else throw new Error("Invalid TIFF header");if(c.nextUInt16()!==42)throw new Error("Invalid TIFF data");return u}return De={IFD0:1,IFD1:2,GPSIFD:3,SubIFD:4,InteropIFD:5,parseTags:function(c,m){var u;try{u=r(c)}catch{return!1}var x,P,y,f=u.openWithOffset(c.nextUInt32()),S=this.IFD0;a(u,f,function(F,w,n){switch(F){case 34853:P=w[0];break;case 34665:x=w[0];break;default:m(S,F,w,n);break}});var d=f.nextUInt32();if(d!==0){var v=u.openWithOffset(d);a(u,v,m.bind(null,this.IFD1))}if(P){var b=u.openWithOffset(P);a(u,b,m.bind(null,this.GPSIFD))}if(x){var B=u.openWithOffset(x),L=this.InteropIFD;a(u,B,function(F,w,n){F===40965?y=w[0]:m(L,F,w,n)})}if(y){var G=u.openWithOffset(y);a(u,G,m.bind(null,this.InteropIFD))}return!0}},De}var Ee,it;function ri(){if(it)return Ee;it=1;function t(u){return parseInt(u,10)}var e=3600,i=60;function a(u,x){u=u.map(t),x=x.map(t);var P=u[0],y=u[1]-1,f=u[2],S=x[0],d=x[1],v=x[2],b=Date.UTC(P,y,f,S,d,v,0),B=b/1e3;return B}function r(u){var x=u.substr(0,10).split("-"),P=u.substr(11,8).split(":"),y=u.substr(19,6),f=y.split(":").map(t),S=f[0]*e+f[1]*i,d=a(x,P);if(d-=S,typeof d=="number"&&!isNaN(d))return d}function c(u){var x=u.split(" "),P=x[0].split(":"),y=x[1].split(":"),f=a(P,y);if(typeof f=="number"&&!isNaN(f))return f}function m(u){var x=u.length===19&&u.charAt(4)===":",P=u.length===25&&u.charAt(10)==="T";if(P)return r(u);if(x)return c(u)}return Ee={parseDateWithSpecFormat:c,parseDateWithTimezoneFormat:r,parseExifDate:m},Ee}var we,at;function oi(){if(at)return we;at=1;var t=St(),e=ri(),i=[{section:t.GPSIFD,type:2,name:"GPSLatitude",refType:1,refName:"GPSLatitudeRef",posVal:"N"},{section:t.GPSIFD,type:4,name:"GPSLongitude",refType:3,refName:"GPSLongitudeRef",posVal:"E"}],a=[{section:t.SubIFD,type:306,name:"ModifyDate"},{section:t.SubIFD,type:36867,name:"DateTimeOriginal"},{section:t.SubIFD,type:36868,name:"CreateDate"},{section:t.SubIFD,type:306,name:"ModifyDate"}];return we={castDegreeValues:function(r,c){i.forEach(function(m){var u=r(m);if(u){var x=r({section:m.section,type:m.refType,name:m.refName}),P=x===m.posVal?1:-1,y=(u[0]+u[1]/60+u[2]/3600)*P;c(m,y)}})},castDateValues:function(r,c){a.forEach(function(m){var u=r(m);if(u){var x=e.parseExifDate(u);typeof x<"u"&&c(m,x)}})},simplifyValue:function(r,c){return Array.isArray(r)&&(r=r.map(function(m){return c===10||c===5?m[0]/m[1]:m}),r.length===1&&(r=r[0])),r}},we}var Ae,nt;function si(){return nt||(nt=1,Ae={exif:{1:"InteropIndex",2:"InteropVersion",11:"ProcessingSoftware",254:"SubfileType",255:"OldSubfileType",256:"ImageWidth",257:"ImageHeight",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",263:"Thresholding",264:"CellWidth",265:"CellLength",266:"FillOrder",269:"DocumentName",270:"ImageDescription",271:"Make",272:"Model",273:"StripOffsets",274:"Orientation",277:"SamplesPerPixel",278:"RowsPerStrip",279:"StripByteCounts",280:"MinSampleValue",281:"MaxSampleValue",282:"XResolution",283:"YResolution",284:"PlanarConfiguration",285:"PageName",286:"XPosition",287:"YPosition",288:"FreeOffsets",289:"FreeByteCounts",290:"GrayResponseUnit",291:"GrayResponseCurve",292:"T4Options",293:"T6Options",296:"ResolutionUnit",297:"PageNumber",300:"ColorResponseUnit",301:"TransferFunction",305:"Software",306:"ModifyDate",315:"Artist",316:"HostComputer",317:"Predictor",318:"WhitePoint",319:"PrimaryChromaticities",320:"ColorMap",321:"HalftoneHints",322:"TileWidth",323:"TileLength",324:"TileOffsets",325:"TileByteCounts",326:"BadFaxLines",327:"CleanFaxData",328:"ConsecutiveBadFaxLines",330:"SubIFD",332:"InkSet",333:"InkNames",334:"NumberofInks",336:"DotRange",337:"TargetPrinter",338:"ExtraSamples",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",342:"TransferRange",343:"ClipPath",344:"XClipPathUnits",345:"YClipPathUnits",346:"Indexed",347:"JPEGTables",351:"OPIProxy",400:"GlobalParametersIFD",401:"ProfileType",402:"FaxProfile",403:"CodingMethods",404:"VersionYear",405:"ModeNumber",433:"Decode",434:"DefaultImageColor",435:"T82Options",437:"JPEGTables",512:"JPEGProc",513:"ThumbnailOffset",514:"ThumbnailLength",515:"JPEGRestartInterval",517:"JPEGLosslessPredictors",518:"JPEGPointTransforms",519:"JPEGQTables",520:"JPEGDCTables",521:"JPEGACTables",529:"YCbCrCoefficients",530:"YCbCrSubSampling",531:"YCbCrPositioning",532:"ReferenceBlackWhite",559:"StripRowCounts",700:"ApplicationNotes",999:"USPTOMiscellaneous",4096:"RelatedImageFileFormat",4097:"RelatedImageWidth",4098:"RelatedImageHeight",18246:"Rating",18247:"XP_DIP_XML",18248:"StitchInfo",18249:"RatingPercent",32781:"ImageID",32931:"WangTag1",32932:"WangAnnotation",32933:"WangTag3",32934:"WangTag4",32995:"Matteing",32996:"DataType",32997:"ImageDepth",32998:"TileDepth",33405:"Model2",33421:"CFARepeatPatternDim",33422:"CFAPattern2",33423:"BatteryLevel",33424:"KodakIFD",33432:"Copyright",33434:"ExposureTime",33437:"FNumber",33445:"MDFileTag",33446:"MDScalePixel",33447:"MDColorTable",33448:"MDLabName",33449:"MDSampleInfo",33450:"MDPrepDate",33451:"MDPrepTime",33452:"MDFileUnits",33550:"PixelScale",33589:"AdventScale",33590:"AdventRevision",33628:"UIC1Tag",33629:"UIC2Tag",33630:"UIC3Tag",33631:"UIC4Tag",33723:"IPTC-NAA",33918:"IntergraphPacketData",33919:"IntergraphFlagRegisters",33920:"IntergraphMatrix",33921:"INGRReserved",33922:"ModelTiePoint",34016:"Site",34017:"ColorSequence",34018:"IT8Header",34019:"RasterPadding",34020:"BitsPerRunLength",34021:"BitsPerExtendedRunLength",34022:"ColorTable",34023:"ImageColorIndicator",34024:"BackgroundColorIndicator",34025:"ImageColorValue",34026:"BackgroundColorValue",34027:"PixelIntensityRange",34028:"TransparencyIndicator",34029:"ColorCharacterization",34030:"HCUsage",34031:"TrapIndicator",34032:"CMYKEquivalent",34118:"SEMInfo",34152:"AFCP_IPTC",34232:"PixelMagicJBIGOptions",34264:"ModelTransform",34306:"WB_GRGBLevels",34310:"LeafData",34377:"PhotoshopSettings",34665:"ExifOffset",34675:"ICC_Profile",34687:"TIFF_FXExtensions",34688:"MultiProfiles",34689:"SharedData",34690:"T88Options",34732:"ImageLayer",34735:"GeoTiffDirectory",34736:"GeoTiffDoubleParams",34737:"GeoTiffAsciiParams",34850:"ExposureProgram",34852:"SpectralSensitivity",34853:"GPSInfo",34855:"ISO",34856:"Opto-ElectricConvFactor",34857:"Interlace",34858:"TimeZoneOffset",34859:"SelfTimerMode",34864:"SensitivityType",34865:"StandardOutputSensitivity",34866:"RecommendedExposureIndex",34867:"ISOSpeed",34868:"ISOSpeedLatitudeyyy",34869:"ISOSpeedLatitudezzz",34908:"FaxRecvParams",34909:"FaxSubAddress",34910:"FaxRecvTime",34954:"LeafSubIFD",36864:"ExifVersion",36867:"DateTimeOriginal",36868:"CreateDate",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureCompensation",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",37387:"FlashEnergy",37388:"SpatialFrequencyResponse",37389:"Noise",37390:"FocalPlaneXResolution",37391:"FocalPlaneYResolution",37392:"FocalPlaneResolutionUnit",37393:"ImageNumber",37394:"SecurityClassification",37395:"ImageHistory",37396:"SubjectArea",37397:"ExposureIndex",37398:"TIFF-EPStandardID",37399:"SensingMethod",37434:"CIP3DataFile",37435:"CIP3Sheet",37436:"CIP3Side",37439:"StoNits",37500:"MakerNote",37510:"UserComment",37520:"SubSecTime",37521:"SubSecTimeOriginal",37522:"SubSecTimeDigitized",37679:"MSDocumentText",37680:"MSPropertySetStorage",37681:"MSDocumentTextPosition",37724:"ImageSourceData",40091:"XPTitle",40092:"XPComment",40093:"XPAuthor",40094:"XPKeywords",40095:"XPSubject",40960:"FlashpixVersion",40961:"ColorSpace",40962:"ExifImageWidth",40963:"ExifImageHeight",40964:"RelatedSoundFile",40965:"InteropOffset",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41485:"Noise",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41489:"ImageNumber",41490:"SecurityClassification",41491:"ImageHistory",41492:"SubjectLocation",41493:"ExposureIndex",41494:"TIFF-EPStandardID",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRatio",41989:"FocalLengthIn35mmFormat",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",42016:"ImageUniqueID",42032:"OwnerName",42033:"SerialNumber",42034:"LensInfo",42035:"LensMake",42036:"LensModel",42037:"LensSerialNumber",42112:"GDALMetadata",42113:"GDALNoData",42240:"Gamma",44992:"ExpandSoftware",44993:"ExpandLens",44994:"ExpandFilm",44995:"ExpandFilterLens",44996:"ExpandScanner",44997:"ExpandFlashLamp",48129:"PixelFormat",48130:"Transformation",48131:"Uncompressed",48132:"ImageType",48256:"ImageWidth",48257:"ImageHeight",48258:"WidthResolution",48259:"HeightResolution",48320:"ImageOffset",48321:"ImageByteCount",48322:"AlphaOffset",48323:"AlphaByteCount",48324:"ImageDataDiscard",48325:"AlphaDataDiscard",50215:"OceScanjobDesc",50216:"OceApplicationSelector",50217:"OceIDNumber",50218:"OceImageLogic",50255:"Annotations",50341:"PrintIM",50560:"USPTOOriginalContentType",50706:"DNGVersion",50707:"DNGBackwardVersion",50708:"UniqueCameraModel",50709:"LocalizedCameraModel",50710:"CFAPlaneColor",50711:"CFALayout",50712:"LinearizationTable",50713:"BlackLevelRepeatDim",50714:"BlackLevel",50715:"BlackLevelDeltaH",50716:"BlackLevelDeltaV",50717:"WhiteLevel",50718:"DefaultScale",50719:"DefaultCropOrigin",50720:"DefaultCropSize",50721:"ColorMatrix1",50722:"ColorMatrix2",50723:"CameraCalibration1",50724:"CameraCalibration2",50725:"ReductionMatrix1",50726:"ReductionMatrix2",50727:"AnalogBalance",50728:"AsShotNeutral",50729:"AsShotWhiteXY",50730:"BaselineExposure",50731:"BaselineNoise",50732:"BaselineSharpness",50733:"BayerGreenSplit",50734:"LinearResponseLimit",50735:"CameraSerialNumber",50736:"DNGLensInfo",50737:"ChromaBlurRadius",50738:"AntiAliasStrength",50739:"ShadowScale",50740:"DNGPrivateData",50741:"MakerNoteSafety",50752:"RawImageSegmentation",50778:"CalibrationIlluminant1",50779:"CalibrationIlluminant2",50780:"BestQualityScale",50781:"RawDataUniqueID",50784:"AliasLayerMetadata",50827:"OriginalRawFileName",50828:"OriginalRawFileData",50829:"ActiveArea",50830:"MaskedAreas",50831:"AsShotICCProfile",50832:"AsShotPreProfileMatrix",50833:"CurrentICCProfile",50834:"CurrentPreProfileMatrix",50879:"ColorimetricReference",50898:"PanasonicTitle",50899:"PanasonicTitle2",50931:"CameraCalibrationSig",50932:"ProfileCalibrationSig",50933:"ProfileIFD",50934:"AsShotProfileName",50935:"NoiseReductionApplied",50936:"ProfileName",50937:"ProfileHueSatMapDims",50938:"ProfileHueSatMapData1",50939:"ProfileHueSatMapData2",50940:"ProfileToneCurve",50941:"ProfileEmbedPolicy",50942:"ProfileCopyright",50964:"ForwardMatrix1",50965:"ForwardMatrix2",50966:"PreviewApplicationName",50967:"PreviewApplicationVersion",50968:"PreviewSettingsName",50969:"PreviewSettingsDigest",50970:"PreviewColorSpace",50971:"PreviewDateTime",50972:"RawImageDigest",50973:"OriginalRawFileDigest",50974:"SubTileBlockSize",50975:"RowInterleaveFactor",50981:"ProfileLookTableDims",50982:"ProfileLookTableData",51008:"OpcodeList1",51009:"OpcodeList2",51022:"OpcodeList3",51041:"NoiseProfile",51043:"TimeCodes",51044:"FrameRate",51058:"TStop",51081:"ReelName",51089:"OriginalDefaultFinalSize",51090:"OriginalBestQualitySize",51091:"OriginalDefaultCropSize",51105:"CameraLabel",51107:"ProfileHueSatMapEncoding",51108:"ProfileLookTableEncoding",51109:"BaselineExposureOffset",51110:"DefaultBlackRender",51111:"NewRawImageDigest",51112:"RawToPreviewGain",51125:"DefaultUserCrop",59932:"Padding",59933:"OffsetSchema",65e3:"OwnerName",65001:"SerialNumber",65002:"Lens",65024:"KDC_IFD",65100:"RawFile",65101:"Converter",65102:"WhiteBalance",65105:"Exposure",65106:"Shadows",65107:"Brightness",65108:"Contrast",65109:"Saturation",65110:"Sharpness",65111:"Smoothness",65112:"MoireFilter"},gps:{0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential",31:"GPSHPositioningError"}}),Ae}var Fe,rt;function li(){if(rt)return Fe;rt=1;var t=ni(),e=St(),i=oi();function a(c,m,u,x,P,y,f){this.startMarker=c,this.tags=m,this.imageSize=u,this.thumbnailOffset=x,this.thumbnailLength=P,this.thumbnailType=y,this.app1Offset=f}a.prototype={hasThumbnail:function(c){return!this.thumbnailOffset||!this.thumbnailLength?!1:typeof c!="string"?!0:c.toLowerCase().trim()==="image/jpeg"?this.thumbnailType===6:c.toLowerCase().trim()==="image/tiff"?this.thumbnailType===1:!1},getThumbnailOffset:function(){return this.app1Offset+6+this.thumbnailOffset},getThumbnailLength:function(){return this.thumbnailLength},getThumbnailBuffer:function(){return this._getThumbnailStream().nextBuffer(this.thumbnailLength)},_getThumbnailStream:function(){return this.startMarker.openWithOffset(this.getThumbnailOffset())},getImageSize:function(){return this.imageSize},getThumbnailSize:function(){var c=this._getThumbnailStream(),m;return t.parseSections(c,function(u,x){t.getSectionName(u).name==="SOF"&&(m=t.getSizeFromSOFSection(x))}),m}};function r(c){this.stream=c,this.flags={readBinaryTags:!1,resolveTagNames:!0,simplifyValues:!0,imageSize:!0,hidePointers:!0,returnTags:!0}}return r.prototype={enableBinaryFields:function(c){return this.flags.readBinaryTags=!!c,this},enablePointers:function(c){return this.flags.hidePointers=!c,this},enableTagNames:function(c){return this.flags.resolveTagNames=!!c,this},enableImageSize:function(c){return this.flags.imageSize=!!c,this},enableReturnTags:function(c){return this.flags.returnTags=!!c,this},enableSimpleValues:function(c){return this.flags.simplifyValues=!!c,this},parse:function(){var c=this.stream.mark(),m=c.openWithOffset(0),u=this.flags,x,P,y,f,S,d,v,b,B;return u.resolveTagNames&&(v=si()),u.resolveTagNames?(x={},b=function(L){return x[L.name]},B=function(L,G){x[L.name]=G}):(x=[],b=function(L){var G;for(G=0;G<x.length;++G)if(x[G].type===L.type&&x[G].section===L.section)return x.value},B=function(L,G){var F;for(F=0;F<x.length;++F)if(x[F].type===L.type&&x[F].section===L.section){x.value=G;return}}),t.parseSections(m,function(L,G){var F,w=G.offsetFrom(c);L===225?(F=e.parseTags(G,function(n,o,s,p){if(!(!u.readBinaryTags&&p===7)){if(o===513){if(y=s[0],u.hidePointers)return}else if(o===514){if(f=s[0],u.hidePointers)return}else if(o===259&&(S=s[0],u.hidePointers))return;if(u.returnTags)if(u.simplifyValues&&(s=i.simplifyValue(s,p)),u.resolveTagNames){var h=n===e.GPSIFD?v.gps:v.exif,l=h[o];l||(l=v.exif[o]),x.hasOwnProperty(l)||(x[l]=s)}else x.push({section:n,type:o,value:s})}}),F&&(d=w)):u.imageSize&&t.getSectionName(L).name==="SOF"&&(P=t.getSizeFromSOFSection(G))}),u.simplifyValues&&(i.castDegreeValues(b,B),i.castDateValues(b,B)),new a(c,x,P,y,f,S,d)}},Fe=r,Fe}var Re,ot;function fi(){if(ot)return Re;ot=1;function t(e,i,a,r,c,m){this.global=c,i=i||0,a=a||e.byteLength-i,this.arrayBuffer=e.slice(i,i+a),this.view=new c.DataView(this.arrayBuffer,0,this.arrayBuffer.byteLength),this.setBigEndian(r),this.offset=0,this.parentOffset=(m||0)+i}return t.prototype={setBigEndian:function(e){this.littleEndian=!e},nextUInt8:function(){var e=this.view.getUint8(this.offset);return this.offset+=1,e},nextInt8:function(){var e=this.view.getInt8(this.offset);return this.offset+=1,e},nextUInt16:function(){var e=this.view.getUint16(this.offset,this.littleEndian);return this.offset+=2,e},nextUInt32:function(){var e=this.view.getUint32(this.offset,this.littleEndian);return this.offset+=4,e},nextInt16:function(){var e=this.view.getInt16(this.offset,this.littleEndian);return this.offset+=2,e},nextInt32:function(){var e=this.view.getInt32(this.offset,this.littleEndian);return this.offset+=4,e},nextFloat:function(){var e=this.view.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e},nextDouble:function(){var e=this.view.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e},nextBuffer:function(e){var i=this.arrayBuffer.slice(this.offset,this.offset+e);return this.offset+=e,i},remainingLength:function(){return this.arrayBuffer.byteLength-this.offset},nextString:function(e){var i=this.arrayBuffer.slice(this.offset,this.offset+e);return i=String.fromCharCode.apply(null,new this.global.Uint8Array(i)),this.offset+=e,i},mark:function(){var e=this;return{openWithOffset:function(i){return i=(i||0)+this.offset,new t(e.arrayBuffer,i,e.arrayBuffer.byteLength-i,!e.littleEndian,e.global,e.parentOffset)},offset:this.offset,getParentOffset:function(){return e.parentOffset}}},offsetFrom:function(e){return this.parentOffset+this.offset-(e.offset+e.getParentOffset())},skip:function(e){this.offset+=e},branch:function(e,i){return i=typeof i=="number"?i:this.arrayBuffer.byteLength-(this.offset+e),new t(this.arrayBuffer,this.offset+e,i,!this.littleEndian,this.global,this.parentOffset)}},Re=t,Re}var Le,st;function ci(){if(st)return Le;st=1;function t(e,i,a,r){this.buffer=e,this.offset=i||0,a=typeof a=="number"?a:e.length,this.endPosition=this.offset+a,this.setBigEndian(r)}return t.prototype={setBigEndian:function(e){this.bigEndian=!!e},nextUInt8:function(){var e=this.buffer.readUInt8(this.offset);return this.offset+=1,e},nextInt8:function(){var e=this.buffer.readInt8(this.offset);return this.offset+=1,e},nextUInt16:function(){var e=this.bigEndian?this.buffer.readUInt16BE(this.offset):this.buffer.readUInt16LE(this.offset);return this.offset+=2,e},nextUInt32:function(){var e=this.bigEndian?this.buffer.readUInt32BE(this.offset):this.buffer.readUInt32LE(this.offset);return this.offset+=4,e},nextInt16:function(){var e=this.bigEndian?this.buffer.readInt16BE(this.offset):this.buffer.readInt16LE(this.offset);return this.offset+=2,e},nextInt32:function(){var e=this.bigEndian?this.buffer.readInt32BE(this.offset):this.buffer.readInt32LE(this.offset);return this.offset+=4,e},nextFloat:function(){var e=this.bigEndian?this.buffer.readFloatBE(this.offset):this.buffer.readFloatLE(this.offset);return this.offset+=4,e},nextDouble:function(){var e=this.bigEndian?this.buffer.readDoubleBE(this.offset):this.buffer.readDoubleLE(this.offset);return this.offset+=8,e},nextBuffer:function(e){var i=this.buffer.slice(this.offset,this.offset+e);return this.offset+=e,i},remainingLength:function(){return this.endPosition-this.offset},nextString:function(e){var i=this.buffer.toString("utf8",this.offset,this.offset+e);return this.offset+=e,i},mark:function(){var e=this;return{openWithOffset:function(i){return i=(i||0)+this.offset,new t(e.buffer,i,e.endPosition-i,e.bigEndian)},offset:this.offset}},offsetFrom:function(e){return this.offset-e.offset},skip:function(e){this.offset+=e},branch:function(e,i){return i=typeof i=="number"?i:this.endPosition-(this.offset+e),new t(this.buffer,this.offset+e,i,this.bigEndian)}},Le=t,Le}var Be,lt;function ui(){if(lt)return Be;lt=1;var t=li();function e(){return(0,eval)("this")}return Be={create:function(i,a){if(a=a||e(),i instanceof a.ArrayBuffer){var r=fi();return new t(new r(i,0,i.byteLength,!0,a))}else{var c=ci();return new t(new c(i,0,i.length,!0))}}},Be}var mi=ui(),ye={exports:{}},ft;function pi(){return ft||(ft=1,(function(t,e){(function(){var i={};i.version="1.0.4",i.remove=function(n){var o=!1;if(n.slice(0,2)!="ÿØ")if(n.slice(0,23)=="data:image/jpeg;base64,"||n.slice(0,22)=="data:image/jpg;base64,")n=S(n.split(",")[1]),o=!0;else throw new Error("Given data is not jpeg.");var s=B(n),p=s.filter(function(l){return!(l.slice(0,2)=="ÿá"&&l.slice(4,10)=="Exif\0\0")}),h=p.join("");return o&&(h="data:image/jpeg;base64,"+f(h)),h},i.insert=function(n,o){var s=!1;if(n.slice(0,6)!="Exif\0\0")throw new Error("Given data is not exif.");if(o.slice(0,2)!="ÿØ")if(o.slice(0,23)=="data:image/jpeg;base64,"||o.slice(0,22)=="data:image/jpg;base64,")o=S(o.split(",")[1]),s=!0;else throw new Error("Given data is not jpeg.");var p="ÿá"+d(">H",[n.length+2])+n,h=B(o),l=G(h,p);return s&&(l="data:image/jpeg;base64,"+f(l)),l},i.load=function(n){var o;if(typeof n=="string")if(n.slice(0,2)=="ÿØ")o=n;else if(n.slice(0,23)=="data:image/jpeg;base64,"||n.slice(0,22)=="data:image/jpg;base64,")o=S(n.split(",")[1]);else if(n.slice(0,4)=="Exif")o=n.slice(6);else throw new Error("'load' gots invalid file data.");else throw new Error("'load' gots invalid type argument.");var s={"0th":{},Exif:{},GPS:{},Interop:{},"1st":{},thumbnail:null},p=new y(o);if(p.tiftag===null)return s;p.tiftag.slice(0,2)=="II"?p.endian_mark="<":p.endian_mark=">";var h=v(p.endian_mark+"L",p.tiftag.slice(4,8))[0];s["0th"]=p.get_ifd(h,"0th");var l=s["0th"].first_ifd_pointer;if(delete s["0th"].first_ifd_pointer,34665 in s["0th"]&&(h=s["0th"][34665],s.Exif=p.get_ifd(h,"Exif")),34853 in s["0th"]&&(h=s["0th"][34853],s.GPS=p.get_ifd(h,"GPS")),40965 in s.Exif&&(h=s.Exif[40965],s.Interop=p.get_ifd(h,"Interop")),l!="\0\0\0\0"&&(h=v(p.endian_mark+"L",l)[0],s["1st"]=p.get_ifd(h,"1st"),513 in s["1st"]&&514 in s["1st"])){var g=s["1st"][513]+s["1st"][514],E=p.tiftag.slice(s["1st"][513],g);s.thumbnail=E}return s},i.dump=function(n){var o=8,s=a(n),p="Exif\0\0MM\0*\0\0\0\b",h=!1,l=!1,g=!1,E=!1,D,I,R,A,q;"0th"in s?D=s["0th"]:D={},"Exif"in s&&Object.keys(s.Exif).length||"Interop"in s&&Object.keys(s.Interop).length?(D[34665]=1,h=!0,I=s.Exif,"Interop"in s&&Object.keys(s.Interop).length?(I[40965]=1,g=!0,R=s.Interop):Object.keys(I).indexOf(i.ExifIFD.InteroperabilityTag.toString())>-1&&delete I[40965]):Object.keys(D).indexOf(i.ImageIFD.ExifTag.toString())>-1&&delete D[34665],"GPS"in s&&Object.keys(s.GPS).length?(D[i.ImageIFD.GPSTag]=1,l=!0,A=s.GPS):Object.keys(D).indexOf(i.ImageIFD.GPSTag.toString())>-1&&delete D[i.ImageIFD.GPSTag],"1st"in s&&"thumbnail"in s&&s.thumbnail!=null&&(E=!0,s["1st"][513]=1,s["1st"][514]=1,q=s["1st"]);var X=P(D,"0th",0),O=X[0].length+h*12+l*12+4+X[1].length,z,ie="",M=0,V,ae="",H=0,ne,K="",re=0,Y,ge="",ee;if(h&&(z=P(I,"Exif",O),M=z[0].length+g*12+z[1].length),l&&(V=P(A,"GPS",O+M),ae=V.join(""),H=ae.length),g){var oe=O+M+H;ne=P(R,"Interop",oe),K=ne.join(""),re=K.length}if(E){var oe=O+M+H+re;if(Y=P(q,"1st",oe),ee=r(s.thumbnail),ee.length>64e3)throw new Error("Given thumbnail is too large. max 64kB")}var le="",Ye="",$e="",Qe="\0\0\0\0";if(h){var $=o+O,fe=d(">L",[$]),ce=34665,ue=d(">H",[ce]),me=d(">H",[F.Long]),pe=d(">L",[1]);le=ue+me+pe+fe}if(l){var $=o+O+M,fe=d(">L",[$]),ce=34853,ue=d(">H",[ce]),me=d(">H",[F.Long]),pe=d(">L",[1]);Ye=ue+me+pe+fe}if(g){var $=o+O+M+H,fe=d(">L",[$]),ce=40965,ue=d(">H",[ce]),me=d(">H",[F.Long]),pe=d(">L",[1]);$e=ue+me+pe+fe}if(E){var $=o+O+M+H+re;Qe=d(">L",[$]);var Et=$+Y[0].length+24+4+Y[1].length,wt="\0\0\0\0"+d(">L",[Et]),At="\0\0\0\0"+d(">L",[ee.length]);ge=Y[0]+wt+At+"\0\0\0\0"+Y[1]+ee}var Ft=X[0]+le+Ye+Qe+X[1];return h&&(ie=z[0]+$e+z[1]),p+Ft+ie+ae+K+ge};function a(n){return JSON.parse(JSON.stringify(n))}function r(n){for(var o=B(n);"ÿà"<=o[1].slice(0,2)&&o[1].slice(0,2)<="ÿï";)o=[o[0]].concat(o.slice(2));return o.join("")}function c(n){return d(">"+b("B",n.length),n)}function m(n){return d(">"+b("H",n.length),n)}function u(n){return d(">"+b("L",n.length),n)}function x(n,o,s){var p="",h="",l,g,E,D;if(o=="Byte")l=n.length,l<=4?h=c(n)+b("\0",4-l):(h=d(">L",[s]),p=c(n));else if(o=="Short")l=n.length,l<=2?h=m(n)+b("\0\0",2-l):(h=d(">L",[s]),p=m(n));else if(o=="Long")l=n.length,l<=1?h=u(n):(h=d(">L",[s]),p=u(n));else if(o=="Ascii")g=n+"\0",l=g.length,l>4?(h=d(">L",[s]),p=g):h=g+b("\0",4-l);else if(o=="Rational"){if(typeof n[0]=="number")l=1,E=n[0],D=n[1],g=d(">L",[E])+d(">L",[D]);else{l=n.length,g="";for(var I=0;I<l;I++)E=n[I][0],D=n[I][1],g+=d(">L",[E])+d(">L",[D])}h=d(">L",[s]),p=g}else if(o=="SRational"){if(typeof n[0]=="number")l=1,E=n[0],D=n[1],g=d(">l",[E])+d(">l",[D]);else{l=n.length,g="";for(var I=0;I<l;I++)E=n[I][0],D=n[I][1],g+=d(">l",[E])+d(">l",[D])}h=d(">L",[s]),p=g}else o=="Undefined"&&(l=n.length,l>4?(h=d(">L",[s]),p=n):h=n+b("\0",4-l));var R=d(">L",[l]);return[R,h,p]}function P(n,o,s){var p=8,h=Object.keys(n).length,l=d(">H",[h]),g;["0th","1st"].indexOf(o)>-1?g=2+h*12+4:g=2+h*12;var E="",D="",I;for(var I in n)if(typeof I=="string"&&(I=parseInt(I)),!(o=="0th"&&[34665,34853].indexOf(I)>-1)){{if(o=="Exif"&&I==40965)continue;if(o=="1st"&&[513,514].indexOf(I)>-1)continue}var R=n[I],A=d(">H",[I]),q=w[o][I].type,X=d(">H",[F[q]]);typeof R=="number"&&(R=[R]);var O=p+g+s+D.length,z=x(R,q,O),ie=z[0],M=z[1],V=z[2];E+=A+X+ie+M,D+=V}return[l+E,D]}function y(n){var o,s;if(n.slice(0,2)=="ÿØ")o=B(n),s=L(o),s?this.tiftag=s.slice(10):this.tiftag=null;else if(["II","MM"].indexOf(n.slice(0,2))>-1)this.tiftag=n;else if(n.slice(0,4)=="Exif")this.tiftag=n.slice(6);else throw new Error("Given file is neither JPEG nor TIFF.")}if(y.prototype={get_ifd:function(n,o){var s={},p=v(this.endian_mark+"H",this.tiftag.slice(n,n+2))[0],h=n+2,l;["0th","1st"].indexOf(o)>-1?l="Image":l=o;for(var g=0;g<p;g++){n=h+12*g;var E=v(this.endian_mark+"H",this.tiftag.slice(n,n+2))[0],D=v(this.endian_mark+"H",this.tiftag.slice(n+2,n+4))[0],I=v(this.endian_mark+"L",this.tiftag.slice(n+4,n+8))[0],R=this.tiftag.slice(n+8,n+12),A=[D,I,R];E in w[l]&&(s[E]=this.convert_value(A))}return o=="0th"&&(n=h+12*p,s.first_ifd_pointer=this.tiftag.slice(n,n+4)),s},convert_value:function(n){var o=null,s=n[0],p=n[1],h=n[2],l;if(s==1)p>4?(l=v(this.endian_mark+"L",h)[0],o=v(this.endian_mark+b("B",p),this.tiftag.slice(l,l+p))):o=v(this.endian_mark+b("B",p),h.slice(0,p));else if(s==2)p>4?(l=v(this.endian_mark+"L",h)[0],o=this.tiftag.slice(l,l+p-1)):o=h.slice(0,p-1);else if(s==3)p>2?(l=v(this.endian_mark+"L",h)[0],o=v(this.endian_mark+b("H",p),this.tiftag.slice(l,l+p*2))):o=v(this.endian_mark+b("H",p),h.slice(0,p*2));else if(s==4)p>1?(l=v(this.endian_mark+"L",h)[0],o=v(this.endian_mark+b("L",p),this.tiftag.slice(l,l+p*4))):o=v(this.endian_mark+b("L",p),h);else if(s==5)if(l=v(this.endian_mark+"L",h)[0],p>1){o=[];for(var g=0;g<p;g++)o.push([v(this.endian_mark+"L",this.tiftag.slice(l+g*8,l+4+g*8))[0],v(this.endian_mark+"L",this.tiftag.slice(l+4+g*8,l+8+g*8))[0]])}else o=[v(this.endian_mark+"L",this.tiftag.slice(l,l+4))[0],v(this.endian_mark+"L",this.tiftag.slice(l+4,l+8))[0]];else if(s==7)p>4?(l=v(this.endian_mark+"L",h)[0],o=this.tiftag.slice(l,l+p)):o=h.slice(0,p);else if(s==9)p>1?(l=v(this.endian_mark+"L",h)[0],o=v(this.endian_mark+b("l",p),this.tiftag.slice(l,l+p*4))):o=v(this.endian_mark+b("l",p),h);else if(s==10)if(l=v(this.endian_mark+"L",h)[0],p>1){o=[];for(var g=0;g<p;g++)o.push([v(this.endian_mark+"l",this.tiftag.slice(l+g*8,l+4+g*8))[0],v(this.endian_mark+"l",this.tiftag.slice(l+4+g*8,l+8+g*8))[0]])}else o=[v(this.endian_mark+"l",this.tiftag.slice(l,l+4))[0],v(this.endian_mark+"l",this.tiftag.slice(l+4,l+8))[0]];else throw new Error("Exif might be wrong. Got incorrect value type to decode. type:"+s);return o instanceof Array&&o.length==1?o[0]:o}},typeof window<"u"&&typeof window.btoa=="function")var f=window.btoa;if(typeof f>"u")var f=function(o){for(var s="",p,h,l,g,E,D,I,R=0,A="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";R<o.length;)p=o.charCodeAt(R++),h=o.charCodeAt(R++),l=o.charCodeAt(R++),g=p>>2,E=(p&3)<<4|h>>4,D=(h&15)<<2|l>>6,I=l&63,isNaN(h)?D=I=64:isNaN(l)&&(I=64),s=s+A.charAt(g)+A.charAt(E)+A.charAt(D)+A.charAt(I);return s};if(typeof window<"u"&&typeof window.atob=="function")var S=window.atob;if(typeof S>"u")var S=function(o){var s="",p,h,l,g,E,D,I,R=0,A="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";for(o=o.replace(/[^A-Za-z0-9\+\/\=]/g,"");R<o.length;)g=A.indexOf(o.charAt(R++)),E=A.indexOf(o.charAt(R++)),D=A.indexOf(o.charAt(R++)),I=A.indexOf(o.charAt(R++)),p=g<<2|E>>4,h=(E&15)<<4|D>>2,l=(D&3)<<6|I,s=s+String.fromCharCode(p),D!=64&&(s=s+String.fromCharCode(h)),I!=64&&(s=s+String.fromCharCode(l));return s};function d(n,o){if(!(o instanceof Array))throw new Error("'pack' error. Got invalid type argument.");if(n.length-1!=o.length)throw new Error("'pack' error. "+(n.length-1)+" marks, "+o.length+" elements.");var s;if(n[0]=="<")s=!0;else if(n[0]==">")s=!1;else throw new Error("");for(var p="",h=1,l=null,g=null,E=null;g=n[h];){if(g.toLowerCase()=="b"){if(l=o[h-1],g=="b"&&l<0&&(l+=256),l>255||l<0)throw new Error("'pack' error.");E=String.fromCharCode(l)}else if(g=="H"){if(l=o[h-1],l>65535||l<0)throw new Error("'pack' error.");E=String.fromCharCode(Math.floor(l%65536/256))+String.fromCharCode(l%256),s&&(E=E.split("").reverse().join(""))}else if(g.toLowerCase()=="l"){if(l=o[h-1],g=="l"&&l<0&&(l+=4294967296),l>4294967295||l<0)throw new Error("'pack' error.");E=String.fromCharCode(Math.floor(l/16777216))+String.fromCharCode(Math.floor(l%16777216/65536))+String.fromCharCode(Math.floor(l%65536/256))+String.fromCharCode(l%256),s&&(E=E.split("").reverse().join(""))}else throw new Error("'pack' error.");p+=E,h+=1}return p}function v(n,o){if(typeof o!="string")throw new Error("'unpack' error. Got invalid type argument.");for(var s=0,p=1;p<n.length;p++)if(n[p].toLowerCase()=="b")s+=1;else if(n[p].toLowerCase()=="h")s+=2;else if(n[p].toLowerCase()=="l")s+=4;else throw new Error("'unpack' error. Got invalid mark.");if(s!=o.length)throw new Error("'unpack' error. Mismatch between symbol and string length. "+s+":"+o.length);var h;if(n[0]=="<")h=!0;else if(n[0]==">")h=!1;else throw new Error("'unpack' error.");for(var l=[],g=0,E=1,D=null,I=null,R=null,A="";I=n[E];){if(I.toLowerCase()=="b")R=1,A=o.slice(g,g+R),D=A.charCodeAt(0),I=="b"&&D>=128&&(D-=256);else if(I=="H")R=2,A=o.slice(g,g+R),h&&(A=A.split("").reverse().join("")),D=A.charCodeAt(0)*256+A.charCodeAt(1);else if(I.toLowerCase()=="l")R=4,A=o.slice(g,g+R),h&&(A=A.split("").reverse().join("")),D=A.charCodeAt(0)*16777216+A.charCodeAt(1)*65536+A.charCodeAt(2)*256+A.charCodeAt(3),I=="l"&&D>=2147483648&&(D-=4294967296);else throw new Error("'unpack' error. "+I);l.push(D),g+=R,E+=1}return l}function b(n,o){for(var s="",p=0;p<o;p++)s+=n;return s}function B(n){if(n.slice(0,2)!="ÿØ")throw new Error("Given data isn't JPEG.");for(var o=2,s=["ÿØ"];;){if(n.slice(o,o+2)=="ÿÚ"){s.push(n.slice(o));break}else{var p=v(">H",n.slice(o+2,o+4))[0],h=o+p+2;s.push(n.slice(o,h)),o=h}if(o>=n.length)throw new Error("Wrong JPEG data.")}return s}function L(n){for(var o,s=0;s<n.length;s++)if(o=n[s],o.slice(0,2)=="ÿá"&&o.slice(4,10)=="Exif\0\0")return o;return null}function G(n,o){var s=!1,p=[];return n.forEach(function(h,l){h.slice(0,2)=="ÿá"&&h.slice(4,10)=="Exif\0\0"&&(s?p.unshift(l):(n[l]=o,s=!0))}),p.forEach(function(h){n.splice(h,1)}),!s&&o&&(n=[n[0],o].concat(n.slice(1))),n.join("")}var F={Byte:1,Ascii:2,Short:3,Long:4,Rational:5,Undefined:7,SLong:9,SRational:10},w={Image:{11:{name:"ProcessingSoftware",type:"Ascii"},254:{name:"NewSubfileType",type:"Long"},255:{name:"SubfileType",type:"Short"},256:{name:"ImageWidth",type:"Long"},257:{name:"ImageLength",type:"Long"},258:{name:"BitsPerSample",type:"Short"},259:{name:"Compression",type:"Short"},262:{name:"PhotometricInterpretation",type:"Short"},263:{name:"Threshholding",type:"Short"},264:{name:"CellWidth",type:"Short"},265:{name:"CellLength",type:"Short"},266:{name:"FillOrder",type:"Short"},269:{name:"DocumentName",type:"Ascii"},270:{name:"ImageDescription",type:"Ascii"},271:{name:"Make",type:"Ascii"},272:{name:"Model",type:"Ascii"},273:{name:"StripOffsets",type:"Long"},274:{name:"Orientation",type:"Short"},277:{name:"SamplesPerPixel",type:"Short"},278:{name:"RowsPerStrip",type:"Long"},279:{name:"StripByteCounts",type:"Long"},282:{name:"XResolution",type:"Rational"},283:{name:"YResolution",type:"Rational"},284:{name:"PlanarConfiguration",type:"Short"},290:{name:"GrayResponseUnit",type:"Short"},291:{name:"GrayResponseCurve",type:"Short"},292:{name:"T4Options",type:"Long"},293:{name:"T6Options",type:"Long"},296:{name:"ResolutionUnit",type:"Short"},301:{name:"TransferFunction",type:"Short"},305:{name:"Software",type:"Ascii"},306:{name:"DateTime",type:"Ascii"},315:{name:"Artist",type:"Ascii"},316:{name:"HostComputer",type:"Ascii"},317:{name:"Predictor",type:"Short"},318:{name:"WhitePoint",type:"Rational"},319:{name:"PrimaryChromaticities",type:"Rational"},320:{name:"ColorMap",type:"Short"},321:{name:"HalftoneHints",type:"Short"},322:{name:"TileWidth",type:"Short"},323:{name:"TileLength",type:"Short"},324:{name:"TileOffsets",type:"Short"},325:{name:"TileByteCounts",type:"Short"},330:{name:"SubIFDs",type:"Long"},332:{name:"InkSet",type:"Short"},333:{name:"InkNames",type:"Ascii"},334:{name:"NumberOfInks",type:"Short"},336:{name:"DotRange",type:"Byte"},337:{name:"TargetPrinter",type:"Ascii"},338:{name:"ExtraSamples",type:"Short"},339:{name:"SampleFormat",type:"Short"},340:{name:"SMinSampleValue",type:"Short"},341:{name:"SMaxSampleValue",type:"Short"},342:{name:"TransferRange",type:"Short"},343:{name:"ClipPath",type:"Byte"},344:{name:"XClipPathUnits",type:"Long"},345:{name:"YClipPathUnits",type:"Long"},346:{name:"Indexed",type:"Short"},347:{name:"JPEGTables",type:"Undefined"},351:{name:"OPIProxy",type:"Short"},512:{name:"JPEGProc",type:"Long"},513:{name:"JPEGInterchangeFormat",type:"Long"},514:{name:"JPEGInterchangeFormatLength",type:"Long"},515:{name:"JPEGRestartInterval",type:"Short"},517:{name:"JPEGLosslessPredictors",type:"Short"},518:{name:"JPEGPointTransforms",type:"Short"},519:{name:"JPEGQTables",type:"Long"},520:{name:"JPEGDCTables",type:"Long"},521:{name:"JPEGACTables",type:"Long"},529:{name:"YCbCrCoefficients",type:"Rational"},530:{name:"YCbCrSubSampling",type:"Short"},531:{name:"YCbCrPositioning",type:"Short"},532:{name:"ReferenceBlackWhite",type:"Rational"},700:{name:"XMLPacket",type:"Byte"},18246:{name:"Rating",type:"Short"},18249:{name:"RatingPercent",type:"Short"},32781:{name:"ImageID",type:"Ascii"},33421:{name:"CFARepeatPatternDim",type:"Short"},33422:{name:"CFAPattern",type:"Byte"},33423:{name:"BatteryLevel",type:"Rational"},33432:{name:"Copyright",type:"Ascii"},33434:{name:"ExposureTime",type:"Rational"},34377:{name:"ImageResources",type:"Byte"},34665:{name:"ExifTag",type:"Long"},34675:{name:"InterColorProfile",type:"Undefined"},34853:{name:"GPSTag",type:"Long"},34857:{name:"Interlace",type:"Short"},34858:{name:"TimeZoneOffset",type:"Long"},34859:{name:"SelfTimerMode",type:"Short"},37387:{name:"FlashEnergy",type:"Rational"},37388:{name:"SpatialFrequencyResponse",type:"Undefined"},37389:{name:"Noise",type:"Undefined"},37390:{name:"FocalPlaneXResolution",type:"Rational"},37391:{name:"FocalPlaneYResolution",type:"Rational"},37392:{name:"FocalPlaneResolutionUnit",type:"Short"},37393:{name:"ImageNumber",type:"Long"},37394:{name:"SecurityClassification",type:"Ascii"},37395:{name:"ImageHistory",type:"Ascii"},37397:{name:"ExposureIndex",type:"Rational"},37398:{name:"TIFFEPStandardID",type:"Byte"},37399:{name:"SensingMethod",type:"Short"},40091:{name:"XPTitle",type:"Byte"},40092:{name:"XPComment",type:"Byte"},40093:{name:"XPAuthor",type:"Byte"},40094:{name:"XPKeywords",type:"Byte"},40095:{name:"XPSubject",type:"Byte"},50341:{name:"PrintImageMatching",type:"Undefined"},50706:{name:"DNGVersion",type:"Byte"},50707:{name:"DNGBackwardVersion",type:"Byte"},50708:{name:"UniqueCameraModel",type:"Ascii"},50709:{name:"LocalizedCameraModel",type:"Byte"},50710:{name:"CFAPlaneColor",type:"Byte"},50711:{name:"CFALayout",type:"Short"},50712:{name:"LinearizationTable",type:"Short"},50713:{name:"BlackLevelRepeatDim",type:"Short"},50714:{name:"BlackLevel",type:"Rational"},50715:{name:"BlackLevelDeltaH",type:"SRational"},50716:{name:"BlackLevelDeltaV",type:"SRational"},50717:{name:"WhiteLevel",type:"Short"},50718:{name:"DefaultScale",type:"Rational"},50719:{name:"DefaultCropOrigin",type:"Short"},50720:{name:"DefaultCropSize",type:"Short"},50721:{name:"ColorMatrix1",type:"SRational"},50722:{name:"ColorMatrix2",type:"SRational"},50723:{name:"CameraCalibration1",type:"SRational"},50724:{name:"CameraCalibration2",type:"SRational"},50725:{name:"ReductionMatrix1",type:"SRational"},50726:{name:"ReductionMatrix2",type:"SRational"},50727:{name:"AnalogBalance",type:"Rational"},50728:{name:"AsShotNeutral",type:"Short"},50729:{name:"AsShotWhiteXY",type:"Rational"},50730:{name:"BaselineExposure",type:"SRational"},50731:{name:"BaselineNoise",type:"Rational"},50732:{name:"BaselineSharpness",type:"Rational"},50733:{name:"BayerGreenSplit",type:"Long"},50734:{name:"LinearResponseLimit",type:"Rational"},50735:{name:"CameraSerialNumber",type:"Ascii"},50736:{name:"LensInfo",type:"Rational"},50737:{name:"ChromaBlurRadius",type:"Rational"},50738:{name:"AntiAliasStrength",type:"Rational"},50739:{name:"ShadowScale",type:"SRational"},50740:{name:"DNGPrivateData",type:"Byte"},50741:{name:"MakerNoteSafety",type:"Short"},50778:{name:"CalibrationIlluminant1",type:"Short"},50779:{name:"CalibrationIlluminant2",type:"Short"},50780:{name:"BestQualityScale",type:"Rational"},50781:{name:"RawDataUniqueID",type:"Byte"},50827:{name:"OriginalRawFileName",type:"Byte"},50828:{name:"OriginalRawFileData",type:"Undefined"},50829:{name:"ActiveArea",type:"Short"},50830:{name:"MaskedAreas",type:"Short"},50831:{name:"AsShotICCProfile",type:"Undefined"},50832:{name:"AsShotPreProfileMatrix",type:"SRational"},50833:{name:"CurrentICCProfile",type:"Undefined"},50834:{name:"CurrentPreProfileMatrix",type:"SRational"},50879:{name:"ColorimetricReference",type:"Short"},50931:{name:"CameraCalibrationSignature",type:"Byte"},50932:{name:"ProfileCalibrationSignature",type:"Byte"},50934:{name:"AsShotProfileName",type:"Byte"},50935:{name:"NoiseReductionApplied",type:"Rational"},50936:{name:"ProfileName",type:"Byte"},50937:{name:"ProfileHueSatMapDims",type:"Long"},50938:{name:"ProfileHueSatMapData1",type:"Float"},50939:{name:"ProfileHueSatMapData2",type:"Float"},50940:{name:"ProfileToneCurve",type:"Float"},50941:{name:"ProfileEmbedPolicy",type:"Long"},50942:{name:"ProfileCopyright",type:"Byte"},50964:{name:"ForwardMatrix1",type:"SRational"},50965:{name:"ForwardMatrix2",type:"SRational"},50966:{name:"PreviewApplicationName",type:"Byte"},50967:{name:"PreviewApplicationVersion",type:"Byte"},50968:{name:"PreviewSettingsName",type:"Byte"},50969:{name:"PreviewSettingsDigest",type:"Byte"},50970:{name:"PreviewColorSpace",type:"Long"},50971:{name:"PreviewDateTime",type:"Ascii"},50972:{name:"RawImageDigest",type:"Undefined"},50973:{name:"OriginalRawFileDigest",type:"Undefined"},50974:{name:"SubTileBlockSize",type:"Long"},50975:{name:"RowInterleaveFactor",type:"Long"},50981:{name:"ProfileLookTableDims",type:"Long"},50982:{name:"ProfileLookTableData",type:"Float"},51008:{name:"OpcodeList1",type:"Undefined"},51009:{name:"OpcodeList2",type:"Undefined"},51022:{name:"OpcodeList3",type:"Undefined"}},Exif:{33434:{name:"ExposureTime",type:"Rational"},33437:{name:"FNumber",type:"Rational"},34850:{name:"ExposureProgram",type:"Short"},34852:{name:"SpectralSensitivity",type:"Ascii"},34855:{name:"ISOSpeedRatings",type:"Short"},34856:{name:"OECF",type:"Undefined"},34864:{name:"SensitivityType",type:"Short"},34865:{name:"StandardOutputSensitivity",type:"Long"},34866:{name:"RecommendedExposureIndex",type:"Long"},34867:{name:"ISOSpeed",type:"Long"},34868:{name:"ISOSpeedLatitudeyyy",type:"Long"},34869:{name:"ISOSpeedLatitudezzz",type:"Long"},36864:{name:"ExifVersion",type:"Undefined"},36867:{name:"DateTimeOriginal",type:"Ascii"},36868:{name:"DateTimeDigitized",type:"Ascii"},37121:{name:"ComponentsConfiguration",type:"Undefined"},37122:{name:"CompressedBitsPerPixel",type:"Rational"},37377:{name:"ShutterSpeedValue",type:"SRational"},37378:{name:"ApertureValue",type:"Rational"},37379:{name:"BrightnessValue",type:"SRational"},37380:{name:"ExposureBiasValue",type:"SRational"},37381:{name:"MaxApertureValue",type:"Rational"},37382:{name:"SubjectDistance",type:"Rational"},37383:{name:"MeteringMode",type:"Short"},37384:{name:"LightSource",type:"Short"},37385:{name:"Flash",type:"Short"},37386:{name:"FocalLength",type:"Rational"},37396:{name:"SubjectArea",type:"Short"},37500:{name:"MakerNote",type:"Undefined"},37510:{name:"UserComment",type:"Ascii"},37520:{name:"SubSecTime",type:"Ascii"},37521:{name:"SubSecTimeOriginal",type:"Ascii"},37522:{name:"SubSecTimeDigitized",type:"Ascii"},40960:{name:"FlashpixVersion",type:"Undefined"},40961:{name:"ColorSpace",type:"Short"},40962:{name:"PixelXDimension",type:"Long"},40963:{name:"PixelYDimension",type:"Long"},40964:{name:"RelatedSoundFile",type:"Ascii"},40965:{name:"InteroperabilityTag",type:"Long"},41483:{name:"FlashEnergy",type:"Rational"},41484:{name:"SpatialFrequencyResponse",type:"Undefined"},41486:{name:"FocalPlaneXResolution",type:"Rational"},41487:{name:"FocalPlaneYResolution",type:"Rational"},41488:{name:"FocalPlaneResolutionUnit",type:"Short"},41492:{name:"SubjectLocation",type:"Short"},41493:{name:"ExposureIndex",type:"Rational"},41495:{name:"SensingMethod",type:"Short"},41728:{name:"FileSource",type:"Undefined"},41729:{name:"SceneType",type:"Undefined"},41730:{name:"CFAPattern",type:"Undefined"},41985:{name:"CustomRendered",type:"Short"},41986:{name:"ExposureMode",type:"Short"},41987:{name:"WhiteBalance",type:"Short"},41988:{name:"DigitalZoomRatio",type:"Rational"},41989:{name:"FocalLengthIn35mmFilm",type:"Short"},41990:{name:"SceneCaptureType",type:"Short"},41991:{name:"GainControl",type:"Short"},41992:{name:"Contrast",type:"Short"},41993:{name:"Saturation",type:"Short"},41994:{name:"Sharpness",type:"Short"},41995:{name:"DeviceSettingDescription",type:"Undefined"},41996:{name:"SubjectDistanceRange",type:"Short"},42016:{name:"ImageUniqueID",type:"Ascii"},42032:{name:"CameraOwnerName",type:"Ascii"},42033:{name:"BodySerialNumber",type:"Ascii"},42034:{name:"LensSpecification",type:"Rational"},42035:{name:"LensMake",type:"Ascii"},42036:{name:"LensModel",type:"Ascii"},42037:{name:"LensSerialNumber",type:"Ascii"},42240:{name:"Gamma",type:"Rational"}},GPS:{0:{name:"GPSVersionID",type:"Byte"},1:{name:"GPSLatitudeRef",type:"Ascii"},2:{name:"GPSLatitude",type:"Rational"},3:{name:"GPSLongitudeRef",type:"Ascii"},4:{name:"GPSLongitude",type:"Rational"},5:{name:"GPSAltitudeRef",type:"Byte"},6:{name:"GPSAltitude",type:"Rational"},7:{name:"GPSTimeStamp",type:"Rational"},8:{name:"GPSSatellites",type:"Ascii"},9:{name:"GPSStatus",type:"Ascii"},10:{name:"GPSMeasureMode",type:"Ascii"},11:{name:"GPSDOP",type:"Rational"},12:{name:"GPSSpeedRef",type:"Ascii"},13:{name:"GPSSpeed",type:"Rational"},14:{name:"GPSTrackRef",type:"Ascii"},15:{name:"GPSTrack",type:"Rational"},16:{name:"GPSImgDirectionRef",type:"Ascii"},17:{name:"GPSImgDirection",type:"Rational"},18:{name:"GPSMapDatum",type:"Ascii"},19:{name:"GPSDestLatitudeRef",type:"Ascii"},20:{name:"GPSDestLatitude",type:"Rational"},21:{name:"GPSDestLongitudeRef",type:"Ascii"},22:{name:"GPSDestLongitude",type:"Rational"},23:{name:"GPSDestBearingRef",type:"Ascii"},24:{name:"GPSDestBearing",type:"Rational"},25:{name:"GPSDestDistanceRef",type:"Ascii"},26:{name:"GPSDestDistance",type:"Rational"},27:{name:"GPSProcessingMethod",type:"Undefined"},28:{name:"GPSAreaInformation",type:"Undefined"},29:{name:"GPSDateStamp",type:"Ascii"},30:{name:"GPSDifferential",type:"Short"},31:{name:"GPSHPositioningError",type:"Rational"}},Interop:{1:{name:"InteroperabilityIndex",type:"Ascii"}}};w["0th"]=w.Image,w["1st"]=w.Image,i.TAGS=w,i.ImageIFD={ProcessingSoftware:11,NewSubfileType:254,SubfileType:255,ImageWidth:256,ImageLength:257,BitsPerSample:258,Compression:259,PhotometricInterpretation:262,Threshholding:263,CellWidth:264,CellLength:265,FillOrder:266,DocumentName:269,ImageDescription:270,Make:271,Model:272,StripOffsets:273,Orientation:274,SamplesPerPixel:277,RowsPerStrip:278,StripByteCounts:279,XResolution:282,YResolution:283,PlanarConfiguration:284,GrayResponseUnit:290,GrayResponseCurve:291,T4Options:292,T6Options:293,ResolutionUnit:296,TransferFunction:301,Software:305,DateTime:306,Artist:315,HostComputer:316,Predictor:317,WhitePoint:318,PrimaryChromaticities:319,ColorMap:320,HalftoneHints:321,TileWidth:322,TileLength:323,TileOffsets:324,TileByteCounts:325,SubIFDs:330,InkSet:332,InkNames:333,NumberOfInks:334,DotRange:336,TargetPrinter:337,ExtraSamples:338,SampleFormat:339,SMinSampleValue:340,SMaxSampleValue:341,TransferRange:342,ClipPath:343,XClipPathUnits:344,YClipPathUnits:345,Indexed:346,JPEGTables:347,OPIProxy:351,JPEGProc:512,JPEGInterchangeFormat:513,JPEGInterchangeFormatLength:514,JPEGRestartInterval:515,JPEGLosslessPredictors:517,JPEGPointTransforms:518,JPEGQTables:519,JPEGDCTables:520,JPEGACTables:521,YCbCrCoefficients:529,YCbCrSubSampling:530,YCbCrPositioning:531,ReferenceBlackWhite:532,XMLPacket:700,Rating:18246,RatingPercent:18249,ImageID:32781,CFARepeatPatternDim:33421,CFAPattern:33422,BatteryLevel:33423,Copyright:33432,ExposureTime:33434,ImageResources:34377,ExifTag:34665,InterColorProfile:34675,GPSTag:34853,Interlace:34857,TimeZoneOffset:34858,SelfTimerMode:34859,FlashEnergy:37387,SpatialFrequencyResponse:37388,Noise:37389,FocalPlaneXResolution:37390,FocalPlaneYResolution:37391,FocalPlaneResolutionUnit:37392,ImageNumber:37393,SecurityClassification:37394,ImageHistory:37395,ExposureIndex:37397,TIFFEPStandardID:37398,SensingMethod:37399,XPTitle:40091,XPComment:40092,XPAuthor:40093,XPKeywords:40094,XPSubject:40095,PrintImageMatching:50341,DNGVersion:50706,DNGBackwardVersion:50707,UniqueCameraModel:50708,LocalizedCameraModel:50709,CFAPlaneColor:50710,CFALayout:50711,LinearizationTable:50712,BlackLevelRepeatDim:50713,BlackLevel:50714,BlackLevelDeltaH:50715,BlackLevelDeltaV:50716,WhiteLevel:50717,DefaultScale:50718,DefaultCropOrigin:50719,DefaultCropSize:50720,ColorMatrix1:50721,ColorMatrix2:50722,CameraCalibration1:50723,CameraCalibration2:50724,ReductionMatrix1:50725,ReductionMatrix2:50726,AnalogBalance:50727,AsShotNeutral:50728,AsShotWhiteXY:50729,BaselineExposure:50730,BaselineNoise:50731,BaselineSharpness:50732,BayerGreenSplit:50733,LinearResponseLimit:50734,CameraSerialNumber:50735,LensInfo:50736,ChromaBlurRadius:50737,AntiAliasStrength:50738,ShadowScale:50739,DNGPrivateData:50740,MakerNoteSafety:50741,CalibrationIlluminant1:50778,CalibrationIlluminant2:50779,BestQualityScale:50780,RawDataUniqueID:50781,OriginalRawFileName:50827,OriginalRawFileData:50828,ActiveArea:50829,MaskedAreas:50830,AsShotICCProfile:50831,AsShotPreProfileMatrix:50832,CurrentICCProfile:50833,CurrentPreProfileMatrix:50834,ColorimetricReference:50879,CameraCalibrationSignature:50931,ProfileCalibrationSignature:50932,AsShotProfileName:50934,NoiseReductionApplied:50935,ProfileName:50936,ProfileHueSatMapDims:50937,ProfileHueSatMapData1:50938,ProfileHueSatMapData2:50939,ProfileToneCurve:50940,ProfileEmbedPolicy:50941,ProfileCopyright:50942,ForwardMatrix1:50964,ForwardMatrix2:50965,PreviewApplicationName:50966,PreviewApplicationVersion:50967,PreviewSettingsName:50968,PreviewSettingsDigest:50969,PreviewColorSpace:50970,PreviewDateTime:50971,RawImageDigest:50972,OriginalRawFileDigest:50973,SubTileBlockSize:50974,RowInterleaveFactor:50975,ProfileLookTableDims:50981,ProfileLookTableData:50982,OpcodeList1:51008,OpcodeList2:51009,OpcodeList3:51022,NoiseProfile:51041},i.ExifIFD={ExposureTime:33434,FNumber:33437,ExposureProgram:34850,SpectralSensitivity:34852,ISOSpeedRatings:34855,OECF:34856,SensitivityType:34864,StandardOutputSensitivity:34865,RecommendedExposureIndex:34866,ISOSpeed:34867,ISOSpeedLatitudeyyy:34868,ISOSpeedLatitudezzz:34869,ExifVersion:36864,DateTimeOriginal:36867,DateTimeDigitized:36868,ComponentsConfiguration:37121,CompressedBitsPerPixel:37122,ShutterSpeedValue:37377,ApertureValue:37378,BrightnessValue:37379,ExposureBiasValue:37380,MaxApertureValue:37381,SubjectDistance:37382,MeteringMode:37383,LightSource:37384,Flash:37385,FocalLength:37386,SubjectArea:37396,MakerNote:37500,UserComment:37510,SubSecTime:37520,SubSecTimeOriginal:37521,SubSecTimeDigitized:37522,FlashpixVersion:40960,ColorSpace:40961,PixelXDimension:40962,PixelYDimension:40963,RelatedSoundFile:40964,InteroperabilityTag:40965,FlashEnergy:41483,SpatialFrequencyResponse:41484,FocalPlaneXResolution:41486,FocalPlaneYResolution:41487,FocalPlaneResolutionUnit:41488,SubjectLocation:41492,ExposureIndex:41493,SensingMethod:41495,FileSource:41728,SceneType:41729,CFAPattern:41730,CustomRendered:41985,ExposureMode:41986,WhiteBalance:41987,DigitalZoomRatio:41988,FocalLengthIn35mmFilm:41989,SceneCaptureType:41990,GainControl:41991,Contrast:41992,Saturation:41993,Sharpness:41994,DeviceSettingDescription:41995,SubjectDistanceRange:41996,ImageUniqueID:42016,CameraOwnerName:42032,BodySerialNumber:42033,LensSpecification:42034,LensMake:42035,LensModel:42036,LensSerialNumber:42037,Gamma:42240},i.GPSIFD={GPSVersionID:0,GPSLatitudeRef:1,GPSLatitude:2,GPSLongitudeRef:3,GPSLongitude:4,GPSAltitudeRef:5,GPSAltitude:6,GPSTimeStamp:7,GPSSatellites:8,GPSStatus:9,GPSMeasureMode:10,GPSDOP:11,GPSSpeedRef:12,GPSSpeed:13,GPSTrackRef:14,GPSTrack:15,GPSImgDirectionRef:16,GPSImgDirection:17,GPSMapDatum:18,GPSDestLatitudeRef:19,GPSDestLatitude:20,GPSDestLongitudeRef:21,GPSDestLongitude:22,GPSDestBearingRef:23,GPSDestBearing:24,GPSDestDistanceRef:25,GPSDestDistance:26,GPSProcessingMethod:27,GPSAreaInformation:28,GPSDateStamp:29,GPSDifferential:30,GPSHPositioningError:31},i.InteropIFD={InteroperabilityIndex:1},i.GPSHelper={degToDmsRational:function(n){var o=Math.abs(n),s=o%1*60,p=s%1*60,h=Math.floor(o),l=Math.floor(s),g=Math.round(p*100);return[[h,1],[l,1],[g,100]]},dmsRationalToDeg:function(n,o){var s=o==="S"||o==="W"?-1:1,p=n[0][0]/n[0][1]+n[1][0]/n[1][1]/60+n[2][0]/n[2][1]/3600;return p*s}},t.exports&&(e=t.exports=i),e.piexif=i})()})(ye,ye.exports)),ye.exports}pi();async function hi(t,e,i,a){const r=await N.Session.get(t);if(!r)throw new Error(`Session ${t} introuvable`);const c=await N.Protocol.get(r.protocol);if(!c)throw new Error(`Protocole ${r.protocol} introuvable`);const m=await N.Metadata.list().then(y=>y.filter(f=>c.metadata.includes(f.id))),u=je("js"),x=await xi(i.slice(0,65635),(m??[]).map(({infer:y,type:f,id:S})=>He.case([{exif:"string"},"|",{latitude:{exif:"string"},longitude:{exif:"string"}}],d=>({key:S,infer:d,type:f})).default(()=>{})(y)).filter(y=>y!==void 0)).catch(y=>(console.warn(y),a.type==="image/jpeg"&&_.warn(u(439,[a.name,y?.toString()??u(86)])),{})),P=await Bt("Image").then(y=>y.filter(f=>f.fileId===e));for(const{id:y}of P)for(const[f,{value:S,confidence:d}]of Object.entries(x))await Qt({db:Tt(),subjectId:y,sessionId:r.id,metadataId:Gt(f,c.id),value:S,confidence:d})}async function xi(t,e){const i=mi.create(t).enableImageSize(!1).parse();if(!i)return{};console.debug("Starting EXIF Extraction",{extractionPlan:e,exif:i});const a=He.case({type:'"location"',infer:{latitude:{exif:"string"},longitude:{exif:"string"}}},({infer:r})=>({confidence:1,alternatives:{},value:{longitude:Te(i.tags[r.longitude.exif],"float"),latitude:Te(i.tags[r.latitude.exif],"float")}})).case({type:Ot.MetadataTypeSchema,infer:{exif:"string"}},({infer:r,type:c})=>({confidence:1,alternatives:{},value:Te(i.tags[r.exif],c)})).default(()=>{});return Object.fromEntries(e.map(({key:r,...c})=>[r,a(c)]).filter(([,r])=>r!==void 0&&!te({latitude:"number.NaN",longitude:"number.NaN"}).allows(r.value)&&!Number.isNaN(r.value)))}function Te(t,e){switch(e){case"string":return t?.toString()??"";case"boolean":return!!t;case"date":if(typeof t!="number")throw new Error("Date value must be a number");if(Number.isNaN(t))throw new Error("Date value is invalid");return new Date(t*1e3);case"boundingbox":throw new Error("Bounding box not supported in EXIF");case"enum":if(typeof t!="string")throw new Error("Enum value must be a string");return t;case"integer":case"float":return Number(t);default:throw new Error(`Unknown type ${e}`)}}const ia=["image/jpeg","application/zip","image/png","image/tiff",".cr2",".rw2",".dng",".crw",".raw",".cr3"];async function di(t,e){const i=xe("main");if(!C.currentProtocol){_.error(i(34));return}const a=await t.arrayBuffer();if(a.byteLength>Ht.maxMemoryUsageInMB*Math.pow(2,20)){_.error(mt());return}const[[r,c],m]=await pt({source:t});await ht({id:e,resizedBytes:m,originalBytes:a,contentType:t.type,filename:t.name,width:r,height:c}),await N.Image.set({id:ke(e,0),sessionId:C.currentSessionId,filename:t.name,addedAt:gt(Date.now()),contentType:t.type,dimensions:{width:r,height:c},fileId:e,metadata:{}}),C.processing.removeFile(e),await hi(C.currentSessionId,e,a,t).catch(u=>{console.error(u);const x=xe("main");_.error(x(87,[t.name]))})}async function gi(t,e,i){const a=xe("main");if(!C.currentProtocol){_.error(a(34));return}if(!C.currentProtocol.crop.infer){console.warn("No crop inference defined, not analyzing image. Configure crop inference in the protocol (crop.infer) if this was not intentional.");return}if(!C.cropInferenceAvailable)return;const r=await N.Image.get(ke(i,0));if(!r)throw new Error(`Image ${i} not found in database`);if(!r.fileId)throw new Error(`Image ${i} has no associated ImageFile in database`);const c=t.inferBoundingBoxes.cancelable({fileId:r.fileId,taskSettings:ve(C.currentProtocol.crop.infer[C.selectedCropModel])});e?.set(r.fileId,c.cancel);const{boxes:m,scores:u}=await c.request.catch(f=>/(maxMemoryUsageInMB|maxResolutionInMP) limit exceeded/.test(f?.toString())?Promise.reject(new Error(mt())):Promise.reject(f));let[x]=m,[P]=u;if(!x||!P){await N.Image.update(r.id,"boundingBoxesAnalyzed",!0);return}const y=([f,S,d,v])=>Wt(C.currentProtocol)({x:f,y:S,w:d,h:v});for(let f=0;f<m.length;f++)await N.Image.set({...r,id:ke(r.fileId,f),addedAt:gt(f===0?r.addedAt:Date.now()),boundingBoxesAnalyzed:!0,metadata:{...Zt(r.metadata),[C.cropMetadataId]:{value:JSON.stringify(y(m[f])),confidence:u[f],alternatives:{},manuallyModified:!1}}})}async function aa(){const t=je("js");if(Notification.permission==="default")try{await Notification.requestPermission()}catch(e){console.error("Notification permission request failed",e)}else Notification.permission==="denied"&&_.error(t(452))}async function Si(t,e){yi()&&new Notification(t,e)}function yi(){return Notification.permission==="granted"&&Kt().notifications}var k=Uint8Array,se=Uint16Array,vi=Int32Array,yt=new k([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),vt=new k([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Ci=new k([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ct=function(t,e){for(var i=new se(31),a=0;a<31;++a)i[a]=e+=1<<t[a-1];for(var r=new vi(i[30]),a=1;a<30;++a)for(var c=i[a];c<i[a+1];++c)r[c]=c-i[a]<<5|a;return{b:i,r}},Pt=Ct(yt,2),It=Pt.b,Pi=Pt.r;It[28]=258,Pi[258]=28;var Ii=Ct(vt,0),bi=Ii.b,Ue=new se(32768);for(var T=0;T<32768;++T){var Z=(T&43690)>>1|(T&21845)<<1;Z=(Z&52428)>>2|(Z&13107)<<2,Z=(Z&61680)>>4|(Z&3855)<<4,Ue[T]=((Z&65280)>>8|(Z&255)<<8)>>1}var he=(function(t,e,i){for(var a=t.length,r=0,c=new se(e);r<a;++r)t[r]&&++c[t[r]-1];var m=new se(e);for(r=1;r<e;++r)m[r]=m[r-1]+c[r-1]<<1;var u;if(i){u=new se(1<<e);var x=15-e;for(r=0;r<a;++r)if(t[r])for(var P=r<<4|t[r],y=e-t[r],f=m[t[r]-1]++<<y,S=f|(1<<y)-1;f<=S;++f)u[Ue[f]>>x]=P}else for(u=new se(a),r=0;r<a;++r)t[r]&&(u[r]=Ue[m[t[r]-1]++]>>15-t[r]);return u}),de=new k(288);for(var T=0;T<144;++T)de[T]=8;for(var T=144;T<256;++T)de[T]=9;for(var T=256;T<280;++T)de[T]=7;for(var T=280;T<288;++T)de[T]=8;var bt=new k(32);for(var T=0;T<32;++T)bt[T]=5;var Di=he(de,9,1),Ei=he(bt,5,1),Ge=function(t){for(var e=t[0],i=1;i<t.length;++i)t[i]>e&&(e=t[i]);return e},j=function(t,e,i){var a=e/8|0;return(t[a]|t[a+1]<<8)>>(e&7)&i},Oe=function(t,e){var i=e/8|0;return(t[i]|t[i+1]<<8|t[i+2]<<16)>>(e&7)},wi=function(t){return(t+7)/8|0},qe=function(t,e,i){return(e==null||e<0)&&(e=0),(i==null||i>t.length)&&(i=t.length),new k(t.subarray(e,i))},Ai=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],U=function(t,e,i){var a=new Error(e||Ai[t]);if(a.code=t,Error.captureStackTrace&&Error.captureStackTrace(a,U),!i)throw a;return a},Fi=function(t,e,i,a){var r=t.length,c=a?a.length:0;if(!r||e.f&&!e.l)return i||new k(0);var m=!i,u=m||e.i!=2,x=e.i;m&&(i=new k(r*3));var P=function(ee){var oe=i.length;if(ee>oe){var le=new k(Math.max(oe*2,ee));le.set(i),i=le}},y=e.f||0,f=e.p||0,S=e.b||0,d=e.l,v=e.d,b=e.m,B=e.n,L=r*8;do{if(!d){y=j(t,f,1);var G=j(t,f+1,3);if(f+=3,G)if(G==1)d=Di,v=Ei,b=9,B=5;else if(G==2){var o=j(t,f,31)+257,s=j(t,f+10,15)+4,p=o+j(t,f+5,31)+1;f+=14;for(var h=new k(p),l=new k(19),g=0;g<s;++g)l[Ci[g]]=j(t,f+g*3,7);f+=s*3;for(var E=Ge(l),D=(1<<E)-1,I=he(l,E,1),g=0;g<p;){var R=I[j(t,f,D)];f+=R&15;var F=R>>4;if(F<16)h[g++]=F;else{var A=0,q=0;for(F==16?(q=3+j(t,f,3),f+=2,A=h[g-1]):F==17?(q=3+j(t,f,7),f+=3):F==18&&(q=11+j(t,f,127),f+=7);q--;)h[g++]=A}}var X=h.subarray(0,o),O=h.subarray(o);b=Ge(X),B=Ge(O),d=he(X,b,1),v=he(O,B,1)}else U(1);else{var F=wi(f)+4,w=t[F-4]|t[F-3]<<8,n=F+w;if(n>r){x&&U(0);break}u&&P(S+w),i.set(t.subarray(F,n),S),e.b=S+=w,e.p=f=n*8,e.f=y;continue}if(f>L){x&&U(0);break}}u&&P(S+131072);for(var z=(1<<b)-1,ie=(1<<B)-1,M=f;;M=f){var A=d[Oe(t,f)&z],V=A>>4;if(f+=A&15,f>L){x&&U(0);break}if(A||U(2),V<256)i[S++]=V;else if(V==256){M=f,d=null;break}else{var ae=V-254;if(V>264){var g=V-257,H=yt[g];ae=j(t,f,(1<<H)-1)+It[g],f+=H}var ne=v[Oe(t,f)&ie],K=ne>>4;ne||U(3),f+=ne&15;var O=bi[K];if(K>3){var H=vt[K];O+=Oe(t,f)&(1<<H)-1,f+=H}if(f>L){x&&U(0);break}u&&P(S+131072);var re=S+ae;if(S<O){var Y=c-O,ge=Math.min(O,re);for(Y+S<0&&U(3);S<ge;++S)i[S]=a[Y+S]}for(;S<re;++S)i[S]=i[S-O]}}e.l=d,e.p=M,e.b=S,e.f=y,d&&(y=1,e.m=b,e.d=v,e.n=B)}while(!y);return S!=i.length&&m?qe(i,0,S):i.subarray(0,S)},Ri=new k(0),J=function(t,e){return t[e]|t[e+1]<<8},W=function(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24)>>>0},Me=function(t,e){return W(t,e)+W(t,e+4)*4294967296};function Li(t,e){return Fi(t,{i:2},e&&e.out,e&&e.dictionary)}var _e=typeof TextDecoder<"u"&&new TextDecoder,Bi=0;try{_e.decode(Ri,{stream:!0}),Bi=1}catch{}var Ti=function(t){for(var e="",i=0;;){var a=t[i++],r=(a>127)+(a>223)+(a>239);if(i+r>t.length)return{s:e,r:qe(t,i-1)};r?r==3?(a=((a&15)<<18|(t[i++]&63)<<12|(t[i++]&63)<<6|t[i++]&63)-65536,e+=String.fromCharCode(55296|a>>10,56320|a&1023)):r&1?e+=String.fromCharCode((a&31)<<6|t[i++]&63):e+=String.fromCharCode((a&15)<<12|(t[i++]&63)<<6|t[i++]&63):e+=String.fromCharCode(a)}};function Dt(t,e){if(e){for(var i="",a=0;a<t.length;a+=16384)i+=String.fromCharCode.apply(null,t.subarray(a,a+16384));return i}else{if(_e)return _e.decode(t);var r=Ti(t),c=r.s,i=r.r;return i.length&&U(8),c}}var Gi=function(t,e){return e+30+J(t,e+26)+J(t,e+28)},Oi=function(t,e,i){var a=J(t,e+28),r=Dt(t.subarray(e+46,e+46+a),!(J(t,e+8)&2048)),c=e+46+a,m=W(t,e+20),u=i&&m==4294967295?Mi(t,c):[m,W(t,e+24),W(t,e+42)],x=u[0],P=u[1],y=u[2];return[J(t,e+10),x,P,r,c+J(t,e+30)+J(t,e+32),y]},Mi=function(t,e){for(;J(t,e)!=1;e+=4+J(t,e+2));return[Me(t,e+12),Me(t,e+4),Me(t,e+20)]};function ct(t,e){for(var i={},a=t.length-22;W(t,a)!=101010256;--a)(!a||t.length-a>65558)&&U(13);var r=J(t,a+8);if(!r)return{};var c=W(t,a+16),m=c==4294967295||r==65535;if(m){var u=W(t,a-12);m=W(t,u)==101075792,m&&(r=W(t,u+32),c=W(t,u+48))}for(var x=e&&e.filter,P=0;P<r;++P){var y=Oi(t,c,m),f=y[0],S=y[1],d=y[2],v=y[3],b=y[4],B=y[5],L=Gi(t,B);c=b,(!x||x({name:v,size:S,originalSize:d,compression:f}))&&(f?f==8?i[v]=Li(t.subarray(L,L+S),{out:new k(d)}):U(14,"unknown compression type "+f):i[v]=qe(t,L,L+S))}return i}const ki=te({observations:te({"[string]":Nt}).describe("Associe l'ID d'une observation à son label et les valeurs de ses métadonnées"),session:Mt.omit("metadata").and({metadata:kt}).describe("La session d'analyse")}),ut={"crop/box/create":te({imageId:"string",box:Se}),"crop/box/delete":te({imageId:"string",box:Se}),"crop/box/edit":te({imageId:"string",before:Se,after:Se})},Ni={"crop/box/create":t=>({op:"crop/box/delete",data:t}),"crop/box/delete":t=>({op:"crop/box/create",data:t}),"crop/box/edit":({imageId:t,before:e,after:i})=>({op:"crop/box/edit",data:{imageId:t,before:i,after:e}})};class Ui{stack=[];graveyard=[];handlers={};depth=100;#e({data:e,op:i}){const a=this.handlers[i];if(!a)throw new Error(`No handler for undo operation ${i}`);return a(ve(e))}push(e,i){const a=ve(i);if(!ut[e].allows(a)){console.error("Invalid undo operation data",{op:e,data:a},ut[e](a));return}this.graveyard=[],this.stack.push({op:e,data:a}),this.stack.length>this.depth&&this.stack.shift()}pop(){const e=this.stack.pop();if(!e){console.warn("Undo stack is empty");return}return this.graveyard.push(e),this.#e(e)}rewind(){const e=this.graveyard.pop();if(!e){console.warn("Redo stack is empty");return}const{op:i,data:a}=e;return this.#e(Ni[i](a))}clear(){this.stack=[],this.graveyard=[]}on(e,i){xt(()=>{this.handlers[e]=i}),dt(()=>{delete this.handlers[e]})}initialize(e){this.stack=[],this.graveyard=[],this.depth=e,this.handlers={};const i=xe("main");ti("general",{"$mod+z":{help:i(30),do:async()=>ze.pop()},"$mod+Shift+z":{help:i(372),do:async()=>ze.rewind()}})}}const ze=new Ui;async function na(t){await Ut(["Session","Observation","Image","ImageFile","ImagePreviewFile"],{mode:"readwrite"},async e=>{e.objectStore("Session").delete(t);const i=await e.objectStore("Observation").index("sessionId").getAll(t);for(const r of i)e.objectStore("Observation").delete(r.id);const a=await e.objectStore("Image").index("sessionId").getAll(t);for(const r of a)e.objectStore("Image").delete(r.id),e.objectStore("ImageFile").delete(Ce(r.id)),e.objectStore("ImagePreviewFile").delete(Ce(r.id))})}async function _i(t){C.setCurrentSession(t),C.clearPreviewURLs(),ze.clear();const e=je("js");Xe(i=>i.cancelAll(e(470))),await N.initialize(t)}async function zi(t,e){const i=new Uint8Array(await t.arrayBuffer()),a=ct(i,{filter:({name:f})=>f===zt}),r=xe("main");if(Object.keys(a).length===0){C.processing.removeFile(e),_.error(r(32,[t.name]));return}const[c]=Object.values(a).map(f=>Dt(f)).map(Jt).map(f=>f?ki(f):void 0);if(c===void 0){C.processing.removeFile(e),_.error(r(114,[t.name]));return}if(c instanceof _t){C.processing.removeFile(e),_.error(r(94,[t.name,c.summary]));return}const{session:m,observations:u}=c;let x;if(C.currentSession)if(C.currentSession.protocol!==m.protocol){C.processing.removeFile(e),_.error(r(378,[t.name,m.protocol,C.currentSession.protocol]));return}else x=C.currentSession;else{_.info(r(377));const f=await N.Session.add({...m,name:m.name||`Import de ${t.name}`,description:m.description||`Importée depuis ${t.name}`,protocol:m.protocol,createdAt:new Date().toISOString(),openedAt:new Date().toISOString(),metadata:Pe(m.metadata??{},({value:S,...d})=>({...d,value:Ie(S)}))});await _i(f.id),x=f}const P=Object.values(u).flatMap(f=>f.images).map(f=>({id:f.id,name:f.exportedAs.original}));C.processing.files.push(...P);const y=ct(i,{filter:({name:f})=>P.some(S=>S.name===f)});if(Object.keys(y).length===0){C.processing.removeFile(e),C.processing.files=C.processing.files.filter(f=>!P.find(S=>S.id===f.id)),_.error(r(38,[t.name]));return}for(const[f,S]of Ne(y)){const d=P.find(w=>w.name===f)?.id;if(!d)continue;const v=Ne(u).map(([w,n])=>({id:w,...n})).find(w=>w.images.some(n=>n.exportedAs.original===f));if(!v){C.processing.removeFile(d);continue}const b=v.images.find(w=>w.exportedAs.original===f);if(!b){C.processing.removeFile(d);continue}await N.Observation.set({...Ke(v,"id","label"),sessionId:x.id,images:v.images.map(w=>w.id),addedAt:new Date().toISOString(),metadataOverrides:Pe(v.metadata,w=>({value:Ie(w.value),confidence:w.confidence,manuallyModified:w.manuallyModified,alternatives:w.alternatives}))});const B=Xt(S),[[L,G],F]=await pt({source:new File([B],b.filename,{type:b.contentType})});await ht({id:Ce(b.id),sessionId:x.id,resizedBytes:F,originalBytes:B,contentType:b.contentType,filename:b.filename,width:L,height:G}),await N.Image.set({...Ke(b,"id","filename","contentType"),sessionId:x.id,dimensions:{width:L,height:G},fileId:Ce(b.id),boundingBoxesAnalyzed:!0,addedAt:new Date().toISOString(),metadata:Pe(b.metadata,w=>({value:Ie(w.value),confidence:w.confidence,manuallyModified:w.manuallyModified,alternatives:w.alternatives}))}),C.processing.removeFile(b.id)}C.processing.removeFile(e)}let Ve;class Vi{constructor({swarpc:e,cancellers:i,parallelism:a=1}){this.swarpc=e,this.cancellers=i,this.parallelism=a,this.tasks=[],this.taskIds=new Set,this.abortController=new AbortController,Ze(()=>{this.start().finally(()=>this.logWarning(null,"Processing queue mainloop exited"))}),Ze(()=>{this.log(null,"Progress is",C.processing.done,"/",C.processing.total)})}async start(){for(this.log(null,`Starting processing queue mainloop with up to ${this.parallelism} concurrent tasks`);;){for(;this.tasks.length>0;)await new Promise((e,i)=>{this.abortController.signal.addEventListener("abort",()=>{e(void 0)}),Promise.allSettled(Yt(this.parallelism).map(async()=>this.pop())).then(a=>{a.some(r=>r.status==="rejected")?i(a.filter(r=>r.status==="rejected").map(r=>r.reason)):e(void 0),C.processing.done+=a.length,this.tasks.length===0&&this.#e()})});await new Promise(e=>setTimeout(e,100))}}log(e,i,...a){console.debug(`[ProcessingQueue] ${e?e+": ":""}${i}`,...a)}logWarning(e,i,...a){console.warn(`[ProcessingQueue] ${e?e+": ":""}${i}`,...a)}#e(){this.log(null,"Queue was drained"),C.loadingImages.clear(),C.queuedImages.clear(),document.dispatchEvent(new CustomEvent("processing-queue-drained")),setTimeout(()=>{C.processing.reset()},500)}taskSubjectId(e){if(e.importing)return e.importing.id;if(e.detection)return e.detection.fileId;if(e.classification)return e.classification.imageId;throw new Error("Task must have either importing, detection or classification")}taskId(e){return this.taskSubjectId(e)}push(e){const i=this.taskId(e);if(this.taskIds.has(i)){this.logWarning(i,"Task already in queue, skipping.",e);return}this.log(i,"push",e),this.tasks.push(e),this.taskIds.add(this.taskId(e)),C.processing.total++,C.queuedImages.add(this.taskSubjectId(e)),e.importing&&C.processing.files.push({name:e.importing.file.name,id:e.importing.id,addedAt:new Date})}cancel(e,i){this.log(e,"cancel",i),this.abortController.abort(e),this.cancellers?.get(e)?.(i),this.tasks=this.tasks.filter(r=>this.taskSubjectId(r)!==e),C.processing.removeFile(e),C.queuedImages.delete(e),C.loadingImages.delete(e),C.processing.total--}cancelAll(e){if(!this.cancellers)throw new Error("No cancellers map set, cannot cancel all tasks.");for(const i of this.cancellers.keys())this.cancel(i,e)}async pop(){const e=this.tasks.shift();if(!e){this.logWarning(null,"No task to pop, queue is empty");return}this.log(this.taskId(e),"pop",ve(e)),this.taskIds.delete(this.taskId(e)),C.queuedImages.delete(this.taskSubjectId(e)),C.loadingImages.add(this.taskSubjectId(e));const{detection:i,classification:a,importing:r}=e;C.processing.task=r?"import":i?"detection":"classification";try{if(r){const{file:c,id:m}=r;$t(c.type)?await zi(c,m):await di(c,m)}else i?await gi(this.swarpc,this.cancellers,i.fileId):a&&await ii(this.swarpc,a.imageId,this.cancellers);C.processing.removeFile(this.taskSubjectId(e))}catch(c){C.erroredImages.set(this.taskSubjectId(e),Vt(c))}finally{C.loadingImages.delete(this.taskSubjectId(e))}}}function ra(t){Je(t.map(e=>({importing:{file:e,id:jt()}})),{title:"Import des images terminé",body:We(t.length,["1 image importée","# images importées"]),tag:"import-complete"})}function oa(t){Je(t.map(e=>({detection:{fileId:e}})),{title:"Détection terminée",body:We(t.length,["1 image traitée","# images traitées"]),tag:"detection-complete"})}function sa(t){Je(t.map(e=>({classification:{imageId:e}})),{title:"Classification terminée",body:We(t.length,["1 image classée","# images classées"]),tag:"classification-complete"})}function la(t,e){Xe(i=>i.cancel(t,e))}function Je(t,{title:e,...i}){Promise.all(t.map(a=>Xe(r=>r.push(a)))).then(()=>{t.length!==0&&Si(e,{icon:"/icon.png",badge:"/badge.png",...i})})}function Hi(t){if(!t)throw new Error("Processing queue not initialized. Call initializeProcessingQueue first.")}function fa(t){Ve??=new Vi({parallelism:Math.ceil(navigator.hardwareConcurrency/2),...t})}function Xe(t){return Hi(Ve),t(Ve)}export{ia as A,ai as a,la as b,sa as c,oa as d,ti as e,na as f,gt as g,aa as h,ra as i,yi as j,fa as k,_i as s,ze as u};
