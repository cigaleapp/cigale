const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./h9n_zjAt.js","./Dt6m180S.js","./DIeogL5L.js","./CoW7fDOc.js","./BqMK6M8M.js","./PPVm8Dsz.js","./C0SiBqD8.js"])))=>i.map(i=>d[i]);
import{_ as X}from"./PPVm8Dsz.js";import{K as C,c as b,O as D,R as F,S as V,T as R,U as I,V as A,L as K,N as Z,W,X as U,Y as z,Z as J,_ as j,C as S,$ as q,a0 as T,h as _,n as $}from"./h9n_zjAt.js";import{m as tt,g as Y,n as et,e as nt,q as rt}from"./C0SiBqD8.js";function at(e,...n){const t=C.bind(null,e||n.find(r=>typeof r=="object"));return n.map(t)}function L(e,n){const t=b(e,n?.in);return t.setHours(0,0,0,0),t}function ot(e,n,t){const[r,a]=at(t?.in,e,n),o=L(r),m=L(a),f=+o-D(o),s=+m-D(m);return Math.round((f-s)/F)}function it(e,n){const t=b(e,n?.in);return t.setFullYear(t.getFullYear(),0,1),t.setHours(0,0,0,0),t}function st(e,n){const t=b(e,n?.in);return ot(t,it(t))+1}function u(e,n){const t=e<0?"-":"",r=Math.abs(e).toString().padStart(n,"0");return t+r}const w={y(e,n){const t=e.getFullYear(),r=t>0?t:1-t;return u(n==="yy"?r%100:r,n.length)},M(e,n){const t=e.getMonth();return n==="M"?String(t+1):u(t+1,2)},d(e,n){return u(e.getDate(),n.length)},a(e,n){const t=e.getHours()/12>=1?"pm":"am";switch(n){case"a":case"aa":return t.toUpperCase();case"aaa":return t;case"aaaaa":return t[0];case"aaaa":default:return t==="am"?"a.m.":"p.m."}},h(e,n){return u(e.getHours()%12||12,n.length)},H(e,n){return u(e.getHours(),n.length)},m(e,n){return u(e.getMinutes(),n.length)},s(e,n){return u(e.getSeconds(),n.length)},S(e,n){const t=n.length,r=e.getMilliseconds(),a=Math.trunc(r*Math.pow(10,t-3));return u(a,n.length)}},O={midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},P={G:function(e,n,t){const r=e.getFullYear()>0?1:0;switch(n){case"G":case"GG":case"GGG":return t.era(r,{width:"abbreviated"});case"GGGGG":return t.era(r,{width:"narrow"});case"GGGG":default:return t.era(r,{width:"wide"})}},y:function(e,n,t){if(n==="yo"){const r=e.getFullYear(),a=r>0?r:1-r;return t.ordinalNumber(a,{unit:"year"})}return w.y(e,n)},Y:function(e,n,t,r){const a=A(e,r),o=a>0?a:1-a;if(n==="YY"){const m=o%100;return u(m,2)}return n==="Yo"?t.ordinalNumber(o,{unit:"year"}):u(o,n.length)},R:function(e,n){const t=I(e);return u(t,n.length)},u:function(e,n){const t=e.getFullYear();return u(t,n.length)},Q:function(e,n,t){const r=Math.ceil((e.getMonth()+1)/3);switch(n){case"Q":return String(r);case"QQ":return u(r,2);case"Qo":return t.ordinalNumber(r,{unit:"quarter"});case"QQQ":return t.quarter(r,{width:"abbreviated",context:"formatting"});case"QQQQQ":return t.quarter(r,{width:"narrow",context:"formatting"});case"QQQQ":default:return t.quarter(r,{width:"wide",context:"formatting"})}},q:function(e,n,t){const r=Math.ceil((e.getMonth()+1)/3);switch(n){case"q":return String(r);case"qq":return u(r,2);case"qo":return t.ordinalNumber(r,{unit:"quarter"});case"qqq":return t.quarter(r,{width:"abbreviated",context:"standalone"});case"qqqqq":return t.quarter(r,{width:"narrow",context:"standalone"});case"qqqq":default:return t.quarter(r,{width:"wide",context:"standalone"})}},M:function(e,n,t){const r=e.getMonth();switch(n){case"M":case"MM":return w.M(e,n);case"Mo":return t.ordinalNumber(r+1,{unit:"month"});case"MMM":return t.month(r,{width:"abbreviated",context:"formatting"});case"MMMMM":return t.month(r,{width:"narrow",context:"formatting"});case"MMMM":default:return t.month(r,{width:"wide",context:"formatting"})}},L:function(e,n,t){const r=e.getMonth();switch(n){case"L":return String(r+1);case"LL":return u(r+1,2);case"Lo":return t.ordinalNumber(r+1,{unit:"month"});case"LLL":return t.month(r,{width:"abbreviated",context:"standalone"});case"LLLLL":return t.month(r,{width:"narrow",context:"standalone"});case"LLLL":default:return t.month(r,{width:"wide",context:"standalone"})}},w:function(e,n,t,r){const a=R(e,r);return n==="wo"?t.ordinalNumber(a,{unit:"week"}):u(a,n.length)},I:function(e,n,t){const r=V(e);return n==="Io"?t.ordinalNumber(r,{unit:"week"}):u(r,n.length)},d:function(e,n,t){return n==="do"?t.ordinalNumber(e.getDate(),{unit:"date"}):w.d(e,n)},D:function(e,n,t){const r=st(e);return n==="Do"?t.ordinalNumber(r,{unit:"dayOfYear"}):u(r,n.length)},E:function(e,n,t){const r=e.getDay();switch(n){case"E":case"EE":case"EEE":return t.day(r,{width:"abbreviated",context:"formatting"});case"EEEEE":return t.day(r,{width:"narrow",context:"formatting"});case"EEEEEE":return t.day(r,{width:"short",context:"formatting"});case"EEEE":default:return t.day(r,{width:"wide",context:"formatting"})}},e:function(e,n,t,r){const a=e.getDay(),o=(a-r.weekStartsOn+8)%7||7;switch(n){case"e":return String(o);case"ee":return u(o,2);case"eo":return t.ordinalNumber(o,{unit:"day"});case"eee":return t.day(a,{width:"abbreviated",context:"formatting"});case"eeeee":return t.day(a,{width:"narrow",context:"formatting"});case"eeeeee":return t.day(a,{width:"short",context:"formatting"});case"eeee":default:return t.day(a,{width:"wide",context:"formatting"})}},c:function(e,n,t,r){const a=e.getDay(),o=(a-r.weekStartsOn+8)%7||7;switch(n){case"c":return String(o);case"cc":return u(o,n.length);case"co":return t.ordinalNumber(o,{unit:"day"});case"ccc":return t.day(a,{width:"abbreviated",context:"standalone"});case"ccccc":return t.day(a,{width:"narrow",context:"standalone"});case"cccccc":return t.day(a,{width:"short",context:"standalone"});case"cccc":default:return t.day(a,{width:"wide",context:"standalone"})}},i:function(e,n,t){const r=e.getDay(),a=r===0?7:r;switch(n){case"i":return String(a);case"ii":return u(a,n.length);case"io":return t.ordinalNumber(a,{unit:"day"});case"iii":return t.day(r,{width:"abbreviated",context:"formatting"});case"iiiii":return t.day(r,{width:"narrow",context:"formatting"});case"iiiiii":return t.day(r,{width:"short",context:"formatting"});case"iiii":default:return t.day(r,{width:"wide",context:"formatting"})}},a:function(e,n,t){const a=e.getHours()/12>=1?"pm":"am";switch(n){case"a":case"aa":return t.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"aaa":return t.dayPeriod(a,{width:"abbreviated",context:"formatting"}).toLowerCase();case"aaaaa":return t.dayPeriod(a,{width:"narrow",context:"formatting"});case"aaaa":default:return t.dayPeriod(a,{width:"wide",context:"formatting"})}},b:function(e,n,t){const r=e.getHours();let a;switch(r===12?a=O.noon:r===0?a=O.midnight:a=r/12>=1?"pm":"am",n){case"b":case"bb":return t.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"bbb":return t.dayPeriod(a,{width:"abbreviated",context:"formatting"}).toLowerCase();case"bbbbb":return t.dayPeriod(a,{width:"narrow",context:"formatting"});case"bbbb":default:return t.dayPeriod(a,{width:"wide",context:"formatting"})}},B:function(e,n,t){const r=e.getHours();let a;switch(r>=17?a=O.evening:r>=12?a=O.afternoon:r>=4?a=O.morning:a=O.night,n){case"B":case"BB":case"BBB":return t.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"BBBBB":return t.dayPeriod(a,{width:"narrow",context:"formatting"});case"BBBB":default:return t.dayPeriod(a,{width:"wide",context:"formatting"})}},h:function(e,n,t){if(n==="ho"){let r=e.getHours()%12;return r===0&&(r=12),t.ordinalNumber(r,{unit:"hour"})}return w.h(e,n)},H:function(e,n,t){return n==="Ho"?t.ordinalNumber(e.getHours(),{unit:"hour"}):w.H(e,n)},K:function(e,n,t){const r=e.getHours()%12;return n==="Ko"?t.ordinalNumber(r,{unit:"hour"}):u(r,n.length)},k:function(e,n,t){let r=e.getHours();return r===0&&(r=24),n==="ko"?t.ordinalNumber(r,{unit:"hour"}):u(r,n.length)},m:function(e,n,t){return n==="mo"?t.ordinalNumber(e.getMinutes(),{unit:"minute"}):w.m(e,n)},s:function(e,n,t){return n==="so"?t.ordinalNumber(e.getSeconds(),{unit:"second"}):w.s(e,n)},S:function(e,n){return w.S(e,n)},X:function(e,n,t){const r=e.getTimezoneOffset();if(r===0)return"Z";switch(n){case"X":return B(r);case"XXXX":case"XX":return y(r);case"XXXXX":case"XXX":default:return y(r,":")}},x:function(e,n,t){const r=e.getTimezoneOffset();switch(n){case"x":return B(r);case"xxxx":case"xx":return y(r);case"xxxxx":case"xxx":default:return y(r,":")}},O:function(e,n,t){const r=e.getTimezoneOffset();switch(n){case"O":case"OO":case"OOO":return"GMT"+k(r,":");case"OOOO":default:return"GMT"+y(r,":")}},z:function(e,n,t){const r=e.getTimezoneOffset();switch(n){case"z":case"zz":case"zzz":return"GMT"+k(r,":");case"zzzz":default:return"GMT"+y(r,":")}},t:function(e,n,t){const r=Math.trunc(+e/1e3);return u(r,n.length)},T:function(e,n,t){return u(+e,n.length)}};function k(e,n=""){const t=e>0?"-":"+",r=Math.abs(e),a=Math.trunc(r/60),o=r%60;return o===0?t+String(a):t+String(a)+n+u(o,2)}function B(e,n){return e%60===0?(e>0?"-":"+")+u(Math.abs(e)/60,2):y(e,n)}function y(e,n=""){const t=e>0?"-":"+",r=Math.abs(e),a=u(Math.trunc(r/60),2),o=u(r%60,2);return t+a+n+o}const ct=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,ut=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,ft=/^'([^]*?)'?$/,dt=/''/g,mt=/[a-zA-Z]/;function gt(e,n,t){const r=K(),a=r.locale??Z,o=r.firstWeekContainsDate??r.locale?.options?.firstWeekContainsDate??1,m=r.weekStartsOn??r.locale?.options?.weekStartsOn??0,f=b(e,t?.in);if(!W(f))throw new RangeError("Invalid time value");let s=n.match(ut).map(i=>{const c=i[0];if(c==="p"||c==="P"){const h=U[c];return h(i,a.formatLong)}return i}).join("").match(ct).map(i=>{if(i==="''")return{isToken:!1,value:"'"};const c=i[0];if(c==="'")return{isToken:!1,value:ht(i)};if(P[c])return{isToken:!0,value:i};if(c.match(mt))throw new RangeError("Format string contains an unescaped latin alphabet character `"+c+"`");return{isToken:!1,value:i}});a.localize.preprocessor&&(s=a.localize.preprocessor(f,s));const g={firstWeekContainsDate:o,weekStartsOn:m,locale:a};return s.map(i=>{if(!i.isToken)return i.value;const c=i.value;(z(c)||J(c))&&j(c,n,String(e));const h=P[c[0]];return h(f,c,a.localize,g)}).join("")}function ht(e){const n=e.match(ft);return n?n[1].replace(dt,"'"):e}function v(e){return JSON.stringify(e instanceof Date&&W(e)?gt(e,"yyyy-MM-dd'T'HH:mm:ss"):e)}function lt({value:e,...n}){return{...n,value:v(e)}}function Mt(e){return tt(e,lt)}async function wt({db:e,metadataId:n,confidence:t,value:r,alternatives:a}){return await Promise.all([{value:r,confidence:t},...a].map(async({confidence:o,value:m})=>{const f=await e.get("MetadataOption",S(n,m));if(!f?.cascade)return;const{cascade:s}=f;return{cascade:s,confidence:o}})).then(o=>{const m=Y(o.filter(et).flatMap(({cascade:s,confidence:g})=>nt(s).map(([i,c])=>({optionId:S(i,c),confidence:g}))),s=>s.optionId,s=>s.confidence);return[...Y(m.entries(),([s])=>q(s).metadataId,([s,g])=>({value:q(s).key,confidence:rt(g)})).entries()].map(([s,g])=>{const[{value:i,confidence:c},...h]=g.toSorted(({confidence:p},{confidence:M})=>M-p);return{metadataId:s,value:i,confidence:c,alternatives:h}})})}function xt(e,n){if(n){const t=_(n,e);return IDBKeyRange.bound(t+":",t+":￿")}else return IDBKeyRange.bound($("",e),$("￿",e))}async function H(e,...n){try{const t=await X(()=>import("./h9n_zjAt.js").then(r=>r.aq),__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url);await Promise.all(n.map(r=>t.tables[r].refresh(e)))}catch(t){console.warn(`Cannot refresh tables ${n}:`,t)}}async function N({db:e,subjectId:n,metadataId:t,type:r,value:a,confidence:o=1,alternatives:m=[],manuallyModified:f=!1,cascadedFrom:s=[],sessionId:g,abortSignal:i}){if(!T(t))throw new Error(`Le metadataId ${t} n'est pas namespacé`);o>1&&(console.warn(`Confidence ${o} is greater than 1, capping to 1`),o=1),i?.throwIfAborted();const c={value:v(a),confidence:o,manuallyModified:f,alternatives:Object.fromEntries(m.map(({value:d,confidence:l})=>(l>1&&(console.warn(`Confidence ${l} of alternative ${d} is greater than 1, capping to 1`),l=1),[v(d),l])))};c.alternatives=Object.fromEntries(Object.entries(c.alternatives).filter(([d])=>d!==c.value)),console.debug(`Store metadata ${t} = `,a,` in ${n}`,c);const h=await e.get("Metadata",t);if(!h)throw new Error(`Métadonnée inconnue avec l'ID ${t}`);if(r&&h.type!==r)throw new Error(`Type de métadonnée incorrect: ${h.type} !== ${r}`);i?.throwIfAborted();const p=await e.get("Image",n),M=await e.get("Observation",n),x=await e.get("Session",n),E=await e.getAll("Image").then(d=>d.filter(({fileId:l})=>l===n));if(i?.throwIfAborted(),x)x.metadata?x.metadata[t]=c:x.metadata={[t]:c},e.put("Session",x);else if(p)p.metadata[t]=c,e.put("Image",p);else if(M)M.metadataOverrides[t]=c,e.put("Observation",M);else if(E)for(const{id:d}of E)await N({db:e,sessionId:g,subjectId:d,metadataId:t,value:a,confidence:o,manuallyModified:f,abortSignal:i});else throw new Error(`Aucune image ou observation avec l'ID ${n}`);i?.throwIfAborted();const Q=await wt({db:e,metadataId:t,value:a,confidence:o,alternatives:m});for(const d of Q){if(i?.throwIfAborted(),s.includes(d.metadataId))throw new Error(`Boucle infinie de cascade détectée pour ${d.metadataId} avec ${d.value}: ${s.join(" -> ")} -> ${t} -> ${d.metadataId}`);console.info(`Cascading metadata ${t} @ ${a} -> ${d.metadataId}  = ${d.value}`);const l=T(t);if(!l)throw new Error(`Metadata ${t} is not namespaced, cannot cascade onto ${d.metadataId}`);d.metadataId=_(d.metadataId,l),await N({db:e,sessionId:g,subjectId:n,manuallyModified:f,cascadedFrom:[...s,t],abortSignal:i,...d})}s.length===0&&g&&await H(g,p?"Image":"Observation")}async function G({db:e,subjectId:n,metadataId:t,recursive:r=!1,reactive:a=!0,sessionId:o}){const m=await e.get("Image",n),f=await e.get("Observation",n),s=await e.get("Session",n),g=await e.getAllFromIndex("Image","sessionId",o).then(i=>i.filter(({fileId:c})=>c===n));if(!m&&!f&&!s&&g.length===0)throw new Error(`Aucune image, observation ou session avec l'ID ${n}`);if(console.debug(`Delete metadata ${t} in ${n}`),m)delete m.metadata[t],e.put("Image",m);else if(s)delete s.metadata[t],e.put("Session",s);else if(f){if(delete f.metadataOverrides[t],e.put("Observation",f),r)for(const i of f.images)await G({db:e,sessionId:o,subjectId:i,recursive:!1,metadataId:t,reactive:!1})}else if(g)for(const{id:i}of g)await G({db:e,sessionId:o,subjectId:i,recursive:!1,metadataId:t,reactive:!1});a&&o&&await H(o,"Image","Observation")}export{N as a,u as b,Mt as c,G as d,v as e,gt as f,xt as m,at as n,lt as s};
