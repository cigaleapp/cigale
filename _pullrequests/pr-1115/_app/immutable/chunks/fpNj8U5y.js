import{aj as d,an as g,g as t,al as s,u as i}from"./Dt6m180S.js";import{S as h,a as M}from"./BnBXxctm.js";import{t as c}from"./h9n_zjAt.js";import"./C0SiBqD8.js";import{g as P}from"./CpDocbkH.js";import{a as C}from"./BgPK52sz.js";var m={},v;function L(){return v||(v=1,(function(l){Object.defineProperty(l,"__esModule",{value:!0}),l.Estimation=l.defaultClock=void 0;const e=()=>typeof performance<"u"?performance.now():new Date().getTime();l.defaultClock=e;class r{timeFetcher;state;constructor({progress:a=0,total:n=100,startTime:f,timeFetcher:u}={}){this.timeFetcher=u??l.defaultClock,this.state={progress:a,total:n,startTime:f??this.now()}}reset(a){this.state.startTime=a!==void 0?a:this.now()}update(a,n){return this.state.progress=a,n!==void 0&&(this.state.total=n),this.measure()}estimate(){return this.measure().estimate}measure(a=1e3){const{progress:n,total:f}=this.state,u=this.now()-this.state.startTime,p=u/n,I=f-n,S=p*I,w=a/p;return{timeDelta:u,averageTime:p,progressLeft:I,speed:w,estimate:S}}now(){return this.timeFetcher()}}l.Estimation=r})(m)),m}var R=L();class U{#t=d(g({files:[],total:0,done:0,time:0,task:"",get progress(){return this.total?this.done/this.total:0},removeFile(e){const r=this.files.findIndex(o=>o.id===e);r!==-1&&this.files.splice(r,1)},reset(){this.total=0,this.done=0,this.time=0,this.task=""}}));get processing(){return t(this.#t)}set processing(e){s(this.#t,e,!0)}#e=new R.Estimation({total:0});#P(e,r){if(e>=r||r===0){this.#e.reset();return}this.#e.update(e,r)}#s=i(()=>(this.#P(this.processing.done,this.processing.total),this.#e.estimate()));get eta(){return t(this.#s)}set eta(e){s(this.#s,e)}#r=d(g([]));get selection(){return t(this.#r)}set selection(e){s(this.#r,e,!0)}#i=d("");get imageOpenedInCropper(){return t(this.#i)}set imageOpenedInCropper(e){s(this.#i,e,!0)}#n=d("");get imagePreviouslyOpenedInCropper(){return t(this.#n)}set imagePreviouslyOpenedInCropper(e){s(this.#n,e,!0)}previewURLs=new h;globalPreviewURLs=new h;erroredImages=new h;loadingImages=new M;queuedImages=new M;#o=d(g({}));get keybinds(){return t(this.#o)}set keybinds(e){s(this.#o,e,!0)}cropperZoomStates=new h;#a=d(void 0);get setSelection(){return t(this.#a)}set setSelection(e){s(this.#a,e,!0)}#c=d(null);get _currentSessionId(){return t(this.#c)}set _currentSessionId(e){s(this.#c,e,!0)}#l=i(()=>this._currentSessionId||localStorage.getItem("currentSessionId")||null);get currentSessionId(){return t(this.#l)}set currentSessionId(e){s(this.#l,e)}async setCurrentSession(e){e===null?localStorage.removeItem("currentSessionId"):(c.Session.update(e,"openedAt",new Date().toISOString()),localStorage.setItem("currentSessionId",e)),this._currentSessionId=e}#d=i(()=>c.Session.state.find(e=>e.id===this.currentSessionId));get currentSession(){return t(this.#d)}set currentSession(e){s(this.#d,e)}#u=i(()=>this.currentSession?.protocol);get currentProtocolId(){return t(this.#u)}set currentProtocolId(e){s(this.#u,e)}#h=i(()=>c.Protocol.state.find(e=>e.id===this.currentProtocolId));get currentProtocol(){return t(this.#h)}set currentProtocol(e){s(this.#h,e)}cropMetadataValueOf(e){return P(e,"boundingbox",this.cropMetadataId)}#f=i(()=>c.Metadata.state.find(e=>this.currentProtocol?.metadata.includes(e.id)&&this.currentProtocol?.crop?.metadata===e.id)?.id??"crop");get cropMetadataId(){return t(this.#f)}set cropMetadataId(e){s(this.#f,e)}#p=i(()=>c.Metadata.state.find(e=>this.currentProtocol?.metadata.includes(e.id)&&this.currentProtocol?.crop?.confirmationMetadata===e.id)?.id??"");get cropConfirmationMetadataId(){return t(this.#p)}set cropConfirmationMetadataId(e){s(this.#p,e)}hasPreviewURL(e){return e?this.globalPreviewURLs.has(e)||this.previewURLs.has(e):!1}getPreviewURL(e){if(e)return this.previewURLs.get(e)||this.globalPreviewURLs.get(e)}setPreviewURL(e,r,o=!1){console.debug("setPreviewURL",{imageFileId:e,url:r,global:o}),e&&(o?this.globalPreviewURLs.set(e,r):this.previewURLs.set(e,r))}revokePreviewURL(e){const r=this.previewURLs.get(e);r&&(URL.revokeObjectURL(r),this.previewURLs.delete(e),this.globalPreviewURLs.delete(e))}clearPreviewURLs(){for(const e of this.previewURLs.keys())this.revokePreviewURL(e)}#g=i(()=>c.Metadata.state.find(e=>e.id===this.classificationMetadataId)?.infer?.neural??[]);get classificationModels(){return t(this.#g)}set classificationModels(e){s(this.#g,e)}#m=i(()=>this.currentProtocol?.crop?.infer??[]);get cropModels(){return t(this.#m)}set cropModels(e){s(this.#m,e)}#I=i(()=>{if(!this.currentProtocolId)return-1;const e=this.cropMetadataId;return e?this.currentSession?.inferenceModels[e]??0:-1});get selectedCropModel(){return t(this.#I)}set selectedCropModel(e){s(this.#I,e)}#M=i(()=>{if(!this.currentProtocolId)return-1;const e=this.classificationMetadataId;return e?this.currentSession?.inferenceModels[e]??0:-1});get selectedClassificationModel(){return t(this.#M)}set selectedClassificationModel(e){s(this.#M,e)}#v=i(()=>this.cropModels.length>0&&this.selectedCropModel!==-1);get cropInferenceAvailable(){return t(this.#v)}set cropInferenceAvailable(e){s(this.#v,e)}#S=i(()=>this.classificationModels.length>0&&this.selectedClassificationModel!==-1);get classificationInferenceAvailable(){return t(this.#S)}set classificationInferenceAvailable(e){s(this.#S,e)}async setModelSelections({classification:e=null,crop:r=null}){if(!this.currentSession||e===null&&r===null)return;const o={classification:this.classificationMetadataId,crop:this.cropMetadataId};if(!o.classification||!o.crop)return;const a=this.currentSession.inferenceModels,n={};e!==null&&e!==this.selectedClassificationModel&&(n[o.classification]=e),r!==null&&r!==this.selectedCropModel&&(n[o.crop]=r),Object.keys(n).length!==0&&await c.Session.update(this.currentSession.id,"inferenceModels",{...a,...n})}#w=i(()=>this.currentProtocol?C(this.currentProtocol,c.Metadata.state):void 0);get classificationMetadataId(){return t(this.#w)}set classificationMetadataId(e){s(this.#w,e)}}const _=new U;export{_ as u};
