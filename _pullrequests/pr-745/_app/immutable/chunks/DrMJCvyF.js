import{_ as A}from"./PPVm8Dsz.js";import{_ as b}from"./CFKIlU8F.js";import{o as y,t as x,e as P,w as h,k as N}from"./Ckf_cnrE.js";import{u as m}from"./DeF7JVqg.js";import"./DSBtPKP_.js";import{u as k}from"./DvdFYW7d.js";var F=class{constructor(){this.worker=new Worker(new URL(""+new URL("../workers/worker-PAsI-19H.js",import.meta.url).href,import.meta.url),{type:"module"}),this.waitForWorker=!1,this.worker.onmessage=({data:e})=>{if(this.waitForWorker){let{return:t,throw:r}=this.waitForWorker;this.waitForWorker=!1,e?.error?r(e.error):t(e?.out)}}}async runFn(e,...t){let r=new Promise((a,n)=>{this.waitForWorker={error:n,return:a}});return this.worker.postMessage({fn:e,args:t},t.map(a=>{if([ArrayBuffer,Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array].some(n=>a instanceof n))return a.buffer}).filter(a=>a)),await r}async open(e,t){return await this.runFn("open",e,t)}async metadata(e){let t=await this.runFn("metadata",!!e);return t?.hasOwnProperty("thumb_format")&&(t.thumb_format=["unknown","jpeg","bitmap","bitmap16","layer","rollei","h265"][t.thumb_format]||"unknown"),t?.hasOwnProperty("desc")&&(t.desc=String(t.desc).trim()),t?.hasOwnProperty("timestamp")&&(t.timestamp=new Date(t.timestamp)),t}async imageData(){return await this.runFn("imageData")}};const T="0123456789ABCDEFGHJKMNPQRSTVWXYZ",d=32,L=16,v=10,_=0xffffffffffff;var f;(function(e){e.Base32IncorrectEncoding="B32_ENC_INVALID",e.DecodeTimeInvalidCharacter="DEC_TIME_CHAR",e.DecodeTimeValueMalformed="DEC_TIME_MALFORMED",e.EncodeTimeNegative="ENC_TIME_NEG",e.EncodeTimeSizeExceeded="ENC_TIME_SIZE_EXCEED",e.EncodeTimeValueMalformed="ENC_TIME_MALFORMED",e.PRNGDetectFailure="PRNG_DETECT",e.ULIDInvalid="ULID_INVALID",e.Unexpected="UNEXPECTED",e.UUIDInvalid="UUID_INVALID"})(f||(f={}));class l extends Error{constructor(t,r){super(`${r} (${t})`),this.name="ULIDError",this.code=t}}function D(e){const t=Math.floor(e()*d)%d;return T.charAt(t)}function S(e){const t=U(),r=t&&(t.crypto||t.msCrypto)||null;if(typeof r?.getRandomValues=="function")return()=>{const a=new Uint8Array(1);return r.getRandomValues(a),a[0]/255};if(typeof r?.randomBytes=="function")return()=>r.randomBytes(1).readUInt8()/255;throw new l(f.PRNGDetectFailure,"Failed to find a reliable PRNG")}function U(){return j()?self:typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:null}function O(e,t){let r="";for(;e>0;e--)r=D(t)+r;return r}function C(e,t=v){if(isNaN(e))throw new l(f.EncodeTimeValueMalformed,`Time must be a number: ${e}`);if(e>_)throw new l(f.EncodeTimeSizeExceeded,`Cannot encode a time larger than ${_}: ${e}`);if(e<0)throw new l(f.EncodeTimeNegative,`Time must be positive: ${e}`);if(Number.isInteger(e)===!1)throw new l(f.EncodeTimeValueMalformed,`Time must be an integer: ${e}`);let r,a="";for(let n=t;n>0;n--)r=e%d,a=T.charAt(r)+a,e=(e-r)/d;return a}function j(){return typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope}function B(e,t){const r=S(),a=Date.now();return C(a,v)+O(L,r)}const w={maxMemoryUsageInMB:1024,maxResolutionInMP:100};function K(e,t=0){return`${e}_${t.toString().padStart(6,"0")}`}function Q(){return B()}function p(e){return/^[0-9A-Z]{26}_\d+$/.test(e)}function M(e){const t=b(N("js"));return new Error(t.t(215,[e]))}function ee(e){if(e===void 0)return e;if(!p(e))throw M(e);return e?.replace(/(_\d+)+$/,"")}function te(e,t){return!e||!t?!1:m.erroredImages.has(t)?!0:x.Image.state.some(r=>r.fileId===t&&r.boundingBoxesAnalyzed)}function re(e){return!!(m.classificationMetadataId&&e.metadata[m.classificationMetadataId]||m.erroredImages.has(e.id))}function ae(e){return!!(e.fileId||m.erroredImages.has(e.id))}async function ne(e,t,r=!0){await y(["Image","ImageFile","ImagePreviewFile","Observation"],{},async n=>{const i=await n.objectStore("Observation").getAll(),o=z(e);try{n.objectStore("ImageFile").delete(e),n.objectStore("ImagePreviewFile").delete(e);for(const c of o){n.objectStore("Image").delete(c.id);for(const s of i){const u=s.images.filter(g=>g!==c.id);u.length===0?n.objectStore("Observation").delete(s.id):u.length<s.images.length&&n.objectStore("Observation").put({...s,images:u})}}}catch(c){if(!r)return Promise.reject(c)}}),m.erroredImages.delete(e),m.loadingImages.delete(e),m.queuedImages.delete(e),m.imageOpenedInCropper===e&&(m.imageOpenedInCropper="");const a=m.previewURLs.get(e);a&&(URL.revokeObjectURL(a),m.previewURLs.delete(e))}async function oe({id:e,originalBytes:t,resizedBytes:r,contentType:a,filename:n,width:i,height:o,tx:c}){await y(["ImageFile","ImagePreviewFile"],{},async s=>{s.objectStore("ImageFile").put({id:e,bytes:t,contentType:a,filename:n,dimensions:{width:i,height:o}}),s.objectStore("ImagePreviewFile").put({id:e,bytes:r,contentType:a,filename:n,dimensions:{width:i,height:o}});const u=new Blob([r],{type:a});m.setPreviewURL(e,URL.createObjectURL(u))})}const I=1024,E=({width:e,height:t})=>Math.round(I*t/e),R=["image/CR2","image/x-canon-cr2","image/x-dcraw","image/x-canon-crw","image/x-kodak-dcr","image/x-adobe-dng","image/x-epson-erf","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-olympus-orf","image/x-pentax-pef","image/x-fuji-raf","image/x-panasonic-raw","image/x-sony-sr2","image/x-sony-srf","image/x-sigma-x3f"],W=[".3fr",".ari",".arw",".bay",".braw",".crw",".cr2",".cr3",".cap",".data",".dcs",".dcr",".dng",".drf",".eip",".erf",".fff",".gpr",".iiq",".k25",".kdc",".mdc",".mef",".mos",".mrw",".nef",".nrw",".obm",".orf",".pef",".ptx",".pxn",".r3d",".raf",".raw",".rwl",".rw2",".rwz",".sr2",".srf",".srw",".tif",".x3f"],G=["image/jpeg","image/png"],$=[...R];function V(){return b(N("js")).t(119,[w.maxResolutionInMP,w.maxMemoryUsageInMB])}async function ie({source:e,type:t}){const{resize:r}=await A(async()=>{const{resize:s}=await import("./DKBeN54O.js");return{resize:s}},[],import.meta.url),a=await createImageBitmap(e).catch(s=>{throw new Error(G.includes(t)?P(s):$.includes(e.type)?`Les fichiers ${h(e.type)} ne sont pas encore supportés`:`Le format de fichier ${h(e.type)} n'est pas supporté`)}),{width:n,height:i}=a;if(n*i>w.maxResolutionInMP*1e6)throw new Error(V());const o=document.createElement("canvas");o.width=n,o.height=i,o.getContext("2d")?.drawImage(a,0,0);const c=document.createElement("canvas");return c.width=I,c.height=E(a),r(o,c,{targetWidth:I,targetHeight:E(a),filter:"mks2013"}),new Promise(s=>{c.toBlob(u=>{if(!u)throw new Error("Failed to resize image");u.arrayBuffer().then(g=>s([[n,i],g]))},t)})}function z(e,t=void 0){return(t??x.Image.state).filter(r=>r.fileId===e)}function se(e){return k(e.map(t=>t.fileId).filter(t=>t!==null))}function me(e){if(!p(e)&&!p(`${e}_000000`))throw M(e);const[t,r]=e.split("_",2),a=Number.parseInt(r,10);return{fileId:t,subindex:Number.isNaN(a)?null:a}}function ce(e){const t=e.match(/(\d+)(px|%)/);if(!t)throw new Error(`Invalid crop padding: ${e}`);const[r,a]=[Number.parseInt(t[1],10),t[2]];return{withUnit:e,unitless:r,unit:a,inPixels:n=>a==="px"?r:Math.round(n*r/100)}}function ue(e){return R.includes(e.type)||W.some(t=>e.name.toLocaleLowerCase().endsWith(t))}async function fe(e){const t=new F;await t.open(new Uint8Array(e));const{width:r,height:a,data:n}=await t.imageData(),i=new ImageData(r,a);for(let o=0;o<n.length/3;o++)i.data[o*4+0]=n[o*3+0],i.data[o*4+1]=n[o*3+1],i.data[o*4+2]=n[o*3+2],i.data[o*4+3]=255;return i}async function le(e){const t=new OffscreenCanvas(e.width,e.height);return t.getContext("2d")?.putImageData(e,0,0),t.convertToBlob().then(r=>URL.createObjectURL(r))}export{ae as a,re as b,p as c,fe as d,ne as e,ee as f,te as g,z as h,le as i,K as j,se as k,w as l,V as m,ue as n,Q as o,me as p,ce as q,ie as r,oe as s};
