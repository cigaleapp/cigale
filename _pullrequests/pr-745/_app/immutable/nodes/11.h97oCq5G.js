import"../chunks/DsnmJJEf.js";import{p as te,g as e,u as q,i as $,ax as H,e as Y,d as Z,a as u,b as re,av as R,c as A,ay as o,aw as f,r as s,a7 as z,aA as se,a6 as oe}from"../chunks/CEjrMSr3.js";import{a as x}from"../chunks/CzPTknfj.js";import{i as V}from"../chunks/BQwRB0hY.js";import{c as ie}from"../chunks/Dz5Bnrn_.js";import{_ as le,g as ne,s as ce,b as de}from"../chunks/CFKIlU8F.js";import{t as J,f as K}from"../chunks/IkhSBAvL.js";import{w as me}from"../chunks/sX0DUBw3.js";import{A as fe}from"../chunks/CHmPELyJ.js";import{B as ve}from"../chunks/CSXPGx0M.js";import{C as pe}from"../chunks/Dx6TMgOp.js";import{c as ee,e as ue,a as ge,b as _e,d as be}from"../chunks/D6DjHfA_.js";import{t as T,e as he}from"../chunks/Ckf_cnrE.js";import{a as Ie,b as ye,c as xe,e as ze,f as we}from"../chunks/DrMJCvyF.js";import{L as Q}from"../chunks/B-ei7I0U.js";import{g as Me}from"../chunks/B2FtpkaY.js";import{P as Ce}from"../chunks/iVH6cKMV.js";import{s as Se}from"../chunks/eEn-YRt2.js";import{a as Ae,i as Oe}from"../chunks/C4k7jWy3.js";import{u as r}from"../chunks/DeF7JVqg.js";import{t as X}from"../chunks/CdFpUUK-.js";import{s as Pe}from"../chunks/DvdFYW7d.js";const ae=U=>{var w=Y(),n=Z(w);{var O=M=>{const v=q(()=>{const{model:k}=r.classificationModels[r.selectedClassificationModel];return{model:k}}),b=q(()=>new URL(typeof e(v).model=="string"?e(v).model:e(v).model?.url));var C=ke(),P=o(C),W=o(P,!0);s(P),s(C),z((k,j)=>{ce(C,"href",k),x(W,j)},[()=>e(b).toString(),()=>e(b).pathname.split("/").at(-1)]),u(M,C)};V(n,M=>{r.classificationInferenceAvailable&&M(O)})}u(U,w)};var ke=A('<a target="_blank" class="svelte-1o687fz"><code class="svelte-1o687fz"> </code></a>'),Le=A('<section class="loading svelte-1o687fz"><!> <p> </p> <p class="source svelte-1o687fz"><!></p> <div class="progressbar svelte-1o687fz"><!></div></section>'),Fe=A('<div class="empty svelte-1o687fz"><svelte-css-wrapper style="display: contents"><!></svelte-css-wrapper> <p> </p> <!></div>'),Be=A("<section><!> <!></section>"),Ee=A('<pre class="trace svelte-1o687fz"> </pre>'),Ne=A('<section class="loading errored svelte-1o687fz"><!> <h2 class="svelte-1o687fz"> </h2> <p class="svelte-1o687fz"> </p> <p class="source svelte-1o687fz"><!></p> <p class="message svelte-1o687fz"> </p> <!></section>');function oa(U,w){te(w,!0);const n=q(()=>le(ne("main")));Se({title:e(n).t(63)});const O=q(()=>T.Observation.state.map(a=>({id:a.id,addedAt:a.addedAt,name:a.label,virtual:!1,data:{observation:a,images:T.Image.state.filter(t=>a.images.includes(t.id))}})));let M=H(0),v=H(!1),b=H(void 0);async function C(){if(e(v)||!r.currentProtocol||!r.classificationInferenceAvailable)return;const a=ge(r.currentProtocol,r.selectedClassificationModel);if(!a){X.error(e(n).t(34,[r.selectedClassificationModel,r.currentProtocol.name]));return}await w.data.swarpc.loadModel.broadcast({protocolId:r.currentProtocol.id,request:a.model,classmapping:a.classmapping,task:"classification"},t=>{R(M,Pe(t.values())/w.data.parallelism)}).then(()=>{R(v,!0)}).catch(t=>{console.error(t),X.error(e(n).t(92))})}$(()=>{if(!r.classificationInferenceAvailable||!e(v)||e(b))return;const a=T.Image.state.filter(t=>Ie(t)&&!ye(t)&&!r.loadingImages.has(t.id));ee(a.map(t=>t.id))}),me(()=>r.selectedClassificationModel,()=>{R(v,!1),C().catch(a=>{R(b,a,!0)}).finally(()=>{R(v,!0)})}),$(()=>{r.setSelection&&ue()});var P=Y(),W=Z(P);{var k=a=>{var t=Le(),D=o(t);Q(D,{loading:!0});var L=f(D,2),G=o(L,!0);s(L);var p=f(L,2),c=o(p);ae(c),s(p);var h=f(p,2),I=o(h);Ce(I,{percentage:!0,alwaysActive:!0,get progress(){return e(M)}}),s(h),s(t),z(F=>x(G,F),[()=>e(n).t(56)]),J(1,t,()=>K,()=>({duration:100})),u(a,t)},j=a=>{var t=Y(),D=Z(t);{var L=p=>{var c=Be();let h;var I=o(c);fe(I,{get items(){return e(O)},get sort(){return Ae().gallerySort},groups:["Recadrées","Non recadrées"],grouping:({data:{images:d}})=>d.some(m=>r.cropMetadataValueOf(m))?"Recadrées":"Non recadrées",item:(d,m,g)=>{let E=()=>m?.().observation,N=()=>m?.().images,i=()=>g?.().id;{let y=q(()=>e(n).t(30));pe(d,{get observation(){return E()},get images(){return N()},boxes:"apply-first",get loadingStatusText(){return e(y)},onretry:()=>{r.erroredImages.delete(i());const l=T.Observation.getFromState(i())?.images;l?(l.forEach(_=>r.erroredImages.delete(_)),ee(l)):X.error(e(n).t(214,[i()]))},ondelete:async()=>{(T.Observation.getFromState(i())?.images??[i()]).forEach(_=>_e(_,"Cancelled by user")),xe(i())&&await ze(we(i())),await be(i(),{notFoundOk:!0,recursive:!0})}})}},$$slots:{item:!0}});var F=f(I,2);{var B=S=>{var d=Fe(),m=o(d);ie(m,()=>({"--size":"6em"})),Q(m.lastChild,{variant:"empty"}),s(m);var g=f(m,2),E=o(g,!0);s(g);var N=f(g,2);ve(N,{onclick:()=>Me("/import"),children:(i,y)=>{se();var l=oe();z(_=>x(l,_),[()=>e(n).t(108)]),u(i,l)},$$slots:{default:!0}}),s(d),z(i=>x(E,i),[()=>e(n).t(38)]),u(S,d)};V(F,S=>{e(O).length||S(B)})}s(c),z(()=>h=de(c,1,"observations svelte-1o687fz",null,h,{empty:!e(O).length})),J(1,c,()=>K,()=>({duration:100})),u(p,c)},G=p=>{var c=Ne(),h=o(c);Q(h,{variant:"error"});var I=f(h,2),F=o(I,!0);s(I);var B=f(I,2),S=o(B,!0);s(B);var d=f(B,2),m=o(d);ae(m),s(d);var g=f(d,2),E=o(g,!0);s(g);var N=f(g,2);{var i=y=>{var l=Ee(),_=o(l,!0);s(l),z(()=>x(_,e(b)?.stack)),u(y,l)};V(N,y=>{Oe()&&y(i)})}s(c),z((y,l,_)=>{x(F,y),x(S,l),x(E,_)},[()=>e(n).t(141),()=>e(n).t(113),()=>he(e(b))]),J(1,c,()=>K,()=>({duration:100})),u(p,c)};V(D,p=>{e(b)?p(G,!1):p(L)},!0)}u(a,t)};V(W,a=>{e(v)?a(j,!1):a(k)})}u(U,P),re()}export{oa as component};
