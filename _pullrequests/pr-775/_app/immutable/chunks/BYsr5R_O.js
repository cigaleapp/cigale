const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BZvTGrCn.js","./Bn_ZbADV.js","./DIeogL5L.js","./gEdK1vYj.js","./C0Q0tU0C.js","./PPVm8Dsz.js","./DvdFYW7d.js"])))=>i.map(i=>d[i]);
import{_ as R}from"./PPVm8Dsz.js";import{G as F,v,J as k,K as j,L as K,N as J,O as U,P as Z,Q as z,R as ee,S as W,T as te,U as ne,V as re,W as ae,B as $,X as Y,Y as oe,C as H,n as q,Z as B,g as l,_ as ie}from"./BZvTGrCn.js";import{g as L,n as se,e as ce,s as ue,m as C,a as p}from"./DvdFYW7d.js";function de(t,...e){const n=F.bind(null,t||e.find(r=>typeof r=="object"));return e.map(n)}function P(t,e){const n=v(t,e?.in);return n.setHours(0,0,0,0),n}function fe(t,e,n){const[r,a]=de(n?.in,t,e),o=P(r),i=P(a),u=+o-k(o),s=+i-k(i);return Math.round((u-s)/j)}function me(t,e){const n=v(t,e?.in);return n.setFullYear(n.getFullYear(),0,1),n.setHours(0,0,0,0),n}function ge(t,e){const n=v(t,e?.in);return fe(n,me(n))+1}function c(t,e){const n=t<0?"-":"",r=Math.abs(t).toString().padStart(e,"0");return n+r}const w={y(t,e){const n=t.getFullYear(),r=n>0?n:1-n;return c(e==="yy"?r%100:r,e.length)},M(t,e){const n=t.getMonth();return e==="M"?String(n+1):c(n+1,2)},d(t,e){return c(t.getDate(),e.length)},a(t,e){const n=t.getHours()/12>=1?"pm":"am";switch(e){case"a":case"aa":return n.toUpperCase();case"aaa":return n;case"aaaaa":return n[0];case"aaaa":default:return n==="am"?"a.m.":"p.m."}},h(t,e){return c(t.getHours()%12||12,e.length)},H(t,e){return c(t.getHours(),e.length)},m(t,e){return c(t.getMinutes(),e.length)},s(t,e){return c(t.getSeconds(),e.length)},S(t,e){const n=e.length,r=t.getMilliseconds(),a=Math.trunc(r*Math.pow(10,n-3));return c(a,e.length)}},b={midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},I={G:function(t,e,n){const r=t.getFullYear()>0?1:0;switch(e){case"G":case"GG":case"GGG":return n.era(r,{width:"abbreviated"});case"GGGGG":return n.era(r,{width:"narrow"});case"GGGG":default:return n.era(r,{width:"wide"})}},y:function(t,e,n){if(e==="yo"){const r=t.getFullYear(),a=r>0?r:1-r;return n.ordinalNumber(a,{unit:"year"})}return w.y(t,e)},Y:function(t,e,n,r){const a=Z(t,r),o=a>0?a:1-a;if(e==="YY"){const i=o%100;return c(i,2)}return e==="Yo"?n.ordinalNumber(o,{unit:"year"}):c(o,e.length)},R:function(t,e){const n=U(t);return c(n,e.length)},u:function(t,e){const n=t.getFullYear();return c(n,e.length)},Q:function(t,e,n){const r=Math.ceil((t.getMonth()+1)/3);switch(e){case"Q":return String(r);case"QQ":return c(r,2);case"Qo":return n.ordinalNumber(r,{unit:"quarter"});case"QQQ":return n.quarter(r,{width:"abbreviated",context:"formatting"});case"QQQQQ":return n.quarter(r,{width:"narrow",context:"formatting"});case"QQQQ":default:return n.quarter(r,{width:"wide",context:"formatting"})}},q:function(t,e,n){const r=Math.ceil((t.getMonth()+1)/3);switch(e){case"q":return String(r);case"qq":return c(r,2);case"qo":return n.ordinalNumber(r,{unit:"quarter"});case"qqq":return n.quarter(r,{width:"abbreviated",context:"standalone"});case"qqqqq":return n.quarter(r,{width:"narrow",context:"standalone"});case"qqqq":default:return n.quarter(r,{width:"wide",context:"standalone"})}},M:function(t,e,n){const r=t.getMonth();switch(e){case"M":case"MM":return w.M(t,e);case"Mo":return n.ordinalNumber(r+1,{unit:"month"});case"MMM":return n.month(r,{width:"abbreviated",context:"formatting"});case"MMMMM":return n.month(r,{width:"narrow",context:"formatting"});case"MMMM":default:return n.month(r,{width:"wide",context:"formatting"})}},L:function(t,e,n){const r=t.getMonth();switch(e){case"L":return String(r+1);case"LL":return c(r+1,2);case"Lo":return n.ordinalNumber(r+1,{unit:"month"});case"LLL":return n.month(r,{width:"abbreviated",context:"standalone"});case"LLLLL":return n.month(r,{width:"narrow",context:"standalone"});case"LLLL":default:return n.month(r,{width:"wide",context:"standalone"})}},w:function(t,e,n,r){const a=J(t,r);return e==="wo"?n.ordinalNumber(a,{unit:"week"}):c(a,e.length)},I:function(t,e,n){const r=K(t);return e==="Io"?n.ordinalNumber(r,{unit:"week"}):c(r,e.length)},d:function(t,e,n){return e==="do"?n.ordinalNumber(t.getDate(),{unit:"date"}):w.d(t,e)},D:function(t,e,n){const r=ge(t);return e==="Do"?n.ordinalNumber(r,{unit:"dayOfYear"}):c(r,e.length)},E:function(t,e,n){const r=t.getDay();switch(e){case"E":case"EE":case"EEE":return n.day(r,{width:"abbreviated",context:"formatting"});case"EEEEE":return n.day(r,{width:"narrow",context:"formatting"});case"EEEEEE":return n.day(r,{width:"short",context:"formatting"});case"EEEE":default:return n.day(r,{width:"wide",context:"formatting"})}},e:function(t,e,n,r){const a=t.getDay(),o=(a-r.weekStartsOn+8)%7||7;switch(e){case"e":return String(o);case"ee":return c(o,2);case"eo":return n.ordinalNumber(o,{unit:"day"});case"eee":return n.day(a,{width:"abbreviated",context:"formatting"});case"eeeee":return n.day(a,{width:"narrow",context:"formatting"});case"eeeeee":return n.day(a,{width:"short",context:"formatting"});case"eeee":default:return n.day(a,{width:"wide",context:"formatting"})}},c:function(t,e,n,r){const a=t.getDay(),o=(a-r.weekStartsOn+8)%7||7;switch(e){case"c":return String(o);case"cc":return c(o,e.length);case"co":return n.ordinalNumber(o,{unit:"day"});case"ccc":return n.day(a,{width:"abbreviated",context:"standalone"});case"ccccc":return n.day(a,{width:"narrow",context:"standalone"});case"cccccc":return n.day(a,{width:"short",context:"standalone"});case"cccc":default:return n.day(a,{width:"wide",context:"standalone"})}},i:function(t,e,n){const r=t.getDay(),a=r===0?7:r;switch(e){case"i":return String(a);case"ii":return c(a,e.length);case"io":return n.ordinalNumber(a,{unit:"day"});case"iii":return n.day(r,{width:"abbreviated",context:"formatting"});case"iiiii":return n.day(r,{width:"narrow",context:"formatting"});case"iiiiii":return n.day(r,{width:"short",context:"formatting"});case"iiii":default:return n.day(r,{width:"wide",context:"formatting"})}},a:function(t,e,n){const a=t.getHours()/12>=1?"pm":"am";switch(e){case"a":case"aa":return n.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"aaa":return n.dayPeriod(a,{width:"abbreviated",context:"formatting"}).toLowerCase();case"aaaaa":return n.dayPeriod(a,{width:"narrow",context:"formatting"});case"aaaa":default:return n.dayPeriod(a,{width:"wide",context:"formatting"})}},b:function(t,e,n){const r=t.getHours();let a;switch(r===12?a=b.noon:r===0?a=b.midnight:a=r/12>=1?"pm":"am",e){case"b":case"bb":return n.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"bbb":return n.dayPeriod(a,{width:"abbreviated",context:"formatting"}).toLowerCase();case"bbbbb":return n.dayPeriod(a,{width:"narrow",context:"formatting"});case"bbbb":default:return n.dayPeriod(a,{width:"wide",context:"formatting"})}},B:function(t,e,n){const r=t.getHours();let a;switch(r>=17?a=b.evening:r>=12?a=b.afternoon:r>=4?a=b.morning:a=b.night,e){case"B":case"BB":case"BBB":return n.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"BBBBB":return n.dayPeriod(a,{width:"narrow",context:"formatting"});case"BBBB":default:return n.dayPeriod(a,{width:"wide",context:"formatting"})}},h:function(t,e,n){if(e==="ho"){let r=t.getHours()%12;return r===0&&(r=12),n.ordinalNumber(r,{unit:"hour"})}return w.h(t,e)},H:function(t,e,n){return e==="Ho"?n.ordinalNumber(t.getHours(),{unit:"hour"}):w.H(t,e)},K:function(t,e,n){const r=t.getHours()%12;return e==="Ko"?n.ordinalNumber(r,{unit:"hour"}):c(r,e.length)},k:function(t,e,n){let r=t.getHours();return r===0&&(r=24),e==="ko"?n.ordinalNumber(r,{unit:"hour"}):c(r,e.length)},m:function(t,e,n){return e==="mo"?n.ordinalNumber(t.getMinutes(),{unit:"minute"}):w.m(t,e)},s:function(t,e,n){return e==="so"?n.ordinalNumber(t.getSeconds(),{unit:"second"}):w.s(t,e)},S:function(t,e){return w.S(t,e)},X:function(t,e,n){const r=t.getTimezoneOffset();if(r===0)return"Z";switch(e){case"X":return _(r);case"XXXX":case"XX":return y(r);case"XXXXX":case"XXX":default:return y(r,":")}},x:function(t,e,n){const r=t.getTimezoneOffset();switch(e){case"x":return _(r);case"xxxx":case"xx":return y(r);case"xxxxx":case"xxx":default:return y(r,":")}},O:function(t,e,n){const r=t.getTimezoneOffset();switch(e){case"O":case"OO":case"OOO":return"GMT"+N(r,":");case"OOOO":default:return"GMT"+y(r,":")}},z:function(t,e,n){const r=t.getTimezoneOffset();switch(e){case"z":case"zz":case"zzz":return"GMT"+N(r,":");case"zzzz":default:return"GMT"+y(r,":")}},t:function(t,e,n){const r=Math.trunc(+t/1e3);return c(r,e.length)},T:function(t,e,n){return c(+t,e.length)}};function N(t,e=""){const n=t>0?"-":"+",r=Math.abs(t),a=Math.trunc(r/60),o=r%60;return o===0?n+String(a):n+String(a)+e+c(o,2)}function _(t,e){return t%60===0?(t>0?"-":"+")+c(Math.abs(t)/60,2):y(t,e)}function y(t,e=""){const n=t>0?"-":"+",r=Math.abs(t),a=c(Math.trunc(r/60),2),o=c(r%60,2);return n+a+e+o}const he=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,le=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,we=/^'([^]*?)'?$/,ye=/''/g,pe=/[a-zA-Z]/;function be(t,e,n){const r=z(),a=r.locale??ee,o=r.firstWeekContainsDate??r.locale?.options?.firstWeekContainsDate??1,i=r.weekStartsOn??r.locale?.options?.weekStartsOn??0,u=v(t,n?.in);if(!W(u))throw new RangeError("Invalid time value");let s=e.match(le).map(d=>{const f=d[0];if(f==="p"||f==="P"){const h=te[f];return h(d,a.formatLong)}return d}).join("").match(he).map(d=>{if(d==="''")return{isToken:!1,value:"'"};const f=d[0];if(f==="'")return{isToken:!1,value:Me(d)};if(I[f])return{isToken:!0,value:d};if(f.match(pe))throw new RangeError("Format string contains an unescaped latin alphabet character `"+f+"`");return{isToken:!1,value:d}});a.localize.preprocessor&&(s=a.localize.preprocessor(u,s));const m={firstWeekContainsDate:o,weekStartsOn:i,locale:a};return s.map(d=>{if(!d.isToken)return d.value;const f=d.value;(ne(f)||re(f))&&ae(f,e,String(t));const h=I[f[0]];return h(u,f,a.localize,m)}).join("")}function Me(t){const e=t.match(we);return e?e[1].replace(ye,"'"):t}async function Oe({db:t,metadataId:e,confidence:n,value:r,alternatives:a}){return await Promise.all([{value:r,confidence:n},...a].map(async({confidence:o,value:i})=>{const u=await t.get("MetadataOption",$(e,i));if(!u?.cascade)return;const{cascade:s}=u;return{cascade:s,confidence:o}})).then(o=>{const i=L(o.filter(se).flatMap(({cascade:s,confidence:m})=>ce(s).map(([d,f])=>({optionId:$(d,f),confidence:m}))),s=>s.optionId,s=>s.confidence);return[...L(i.entries(),([s])=>Y(s).metadataId,([s,m])=>({value:Y(s).key,confidence:ue(m)})).entries()].map(([s,m])=>{const[{value:d,confidence:f},...h]=m.toSorted(({confidence:M},{confidence:x})=>x-M);return{metadataId:s,value:d,confidence:f,alternatives:h}})})}async function V(...t){try{const e=await R(()=>import("./BZvTGrCn.js").then(n=>n.ah),__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url);await Promise.all(t.map(n=>e.tables[n].refresh()))}catch(e){console.warn(`Cannot refresh tables ${t}:`,e)}}function Pe(t,e,n){const r=t.metadata[n];if(r!==void 0)return{...r,value:Ye(e,r.value)}}function T(t){return JSON.stringify(t instanceof Date&&W(t)?be(t,"yyyy-MM-dd'T'HH:mm:ss"):t)}function Ie(t){return C(t,({value:e,...n})=>({...n,value:T(e)}))}async function G({db:t,subjectId:e,metadataId:n,type:r,value:a,confidence:o=1,alternatives:i=[],manuallyModified:u=!1,cascadedFrom:s=[],abortSignal:m}){if(!B(n))throw new Error(`Le metadataId ${n} n'est pas namespacé`);m?.throwIfAborted();const d={value:T(a),confidence:o,manuallyModified:u,alternatives:Object.fromEntries(i.map(g=>[T(g.value),g.confidence]))};d.alternatives=Object.fromEntries(Object.entries(d.alternatives).filter(([g])=>g!==d.value)),console.debug(`Store metadata ${n} = `,a,` in ${e}`,d);const f=await t.get("Metadata",n);if(!f)throw new Error(`Métadonnée inconnue avec l'ID ${n}`);if(r&&f.type!==r)throw new Error(`Type de métadonnée incorrect: ${f.type} !== ${r}`);m?.throwIfAborted();const h=await t.get("Image",e),M=await t.get("Observation",e),x=await t.getAll("Image").then(g=>g.filter(({fileId:E})=>E===e));if(m?.throwIfAborted(),h)h.metadata[n]=d,t.put("Image",h);else if(M)M.metadataOverrides[n]=d,t.put("Observation",M);else if(x)for(const{id:g}of x)await G({db:t,subjectId:g,metadataId:n,value:a,confidence:o,manuallyModified:u,abortSignal:m});else throw new Error(`Aucune image ou observation avec l'ID ${e}`);m?.throwIfAborted();const A=await Oe({db:t,metadataId:n,value:a,confidence:o,alternatives:i});for(const g of A){if(m?.throwIfAborted(),s.includes(g.metadataId))throw new Error(`Boucle infinie de cascade détectée pour ${g.metadataId} avec ${g.value}: ${s.join(" -> ")} -> ${n} -> ${g.metadataId}`);console.info(`Cascading metadata ${n} @ ${a} -> ${g.metadataId}  = ${g.value}`);const E=B(n);if(!E)throw new Error(`Metadata ${n} is not namespaced, cannot cascade onto ${g.metadataId}`);g.metadataId=H(g.metadataId,E),await G({db:t,subjectId:e,manuallyModified:u,cascadedFrom:[...s,n],abortSignal:m,...g})}s.length===0&&await V(h?"Image":"Observation")}async function xe({db:t,subjectId:e,metadataId:n,recursive:r=!1,reactive:a=!0}){const o=await t.get("Image",e),i=await t.get("Observation",e);if(!o&&!i)throw new Error(`Aucune image ou observation avec l'ID ${e}`);if(console.debug(`Delete metadata ${n} in ${e}`),o)delete o.metadata[n],t.put("Image",o);else if(i&&(delete i.metadataOverrides[n],t.put("Observation",i),r))for(const u of i.images)await xe({db:t,subjectId:u,recursive:!1,metadataId:n,reactive:!1});a&&await V("Image","Observation")}const Ne=new Set(["boolean","integer","float","date","location","boundingbox","enum"]);async function _e(t,e,n){const r=await Q(t,e.map(u=>u.metadata)),a=await Q(t,n.map(u=>u.metadataOverrides)),o=new Set([...Object.keys(r),...Object.keys(a)]),i={};for(const u of o){const s=a[u]??r[u];s&&(i[u]=s)}return i}async function Q(t,e){if(e.length===1)return C(e[0],a=>({...a,merged:!1}));const n={},r=new Set(e.flatMap(a=>Object.keys(a)));for(const a of r){const o=ie.Metadata.assert(await t.get("Metadata",a));if(!o){console.warn(`Cannot merge metadata values for unknown key ${a}`);continue}const i=e.flatMap(s=>Object.entries(s).filter(([m])=>m===a).map(([,m])=>m)),u=Ee(o,i);u!=null&&(n[a]={...u,merged:new Set(i.map(s=>JSON.stringify(s.value))).size>1})}return n}function Ee(t,e){const n=(r,a)=>Object.fromEntries(a.flatMap(o=>Object.keys(o.alternatives)).map(o=>[o,r(a.flatMap(i=>i.alternatives[o]??null).filter(Boolean))]));switch(t.mergeMethod){case"average":return{value:Te(t.type,e.map(r=>r.value)),manuallyModified:e.some(r=>r.manuallyModified),confidence:p(e.map(r=>r.confidence)),alternatives:n(p,e)};case"max":case"min":return{value:De(t.type,e,t.mergeMethod==="max"?D:ve),manuallyModified:e.some(r=>r.manuallyModified),confidence:D(e.map(r=>r.confidence)),alternatives:n(D,e)};case"median":return{value:Se(t.type,e.map(r=>r.value)),manuallyModified:e.some(r=>r.manuallyModified),confidence:O(e.map(r=>r.confidence)),alternatives:n(O,e)};case"union":return{value:ke(t.type,e.map(r=>r.value)),manuallyModified:e.some(r=>r.manuallyModified),confidence:p(e.map(r=>r.confidence)),alternatives:n(p,e)};case"none":return null}}const D=t=>Math.max(...t),ve=t=>Math.min(...t);function De(t,e,n){const r=Math.max(...e.map(o=>o.confidence)),a=e.filter(o=>o.confidence===r);try{return n(a.map(o=>o.value))}catch(o){return console.error(o),a[0].value}}function Te(t,e){const n=r=>p(X(t,r));if(t==="boolean")return n(e)>.5;if(t==="integer")return Math.ceil(n(e));if(t==="float")return n(e);if(t==="date")return new Date(n(e));if(t==="location")return{latitude:p(e.map(r=>r.latitude)),longitude:p(e.map(r=>r.longitude))};throw new Error(`Impossible de fusionner en mode moyenne des valeurs de type ${t}`)}const O=t=>{const e=t.sort((r,a)=>r-a),n=Math.floor(e.length/2);return e.length%2===0?(e[n-1]+e[n])/2:e[n]};function Se(t,e){const n=r=>O(X(t,r));if(t==="boolean")return n(e)>.5;if(t==="integer")return Math.ceil(n(e));if(t==="float")return n(e);if(t==="date")return new Date(n(e));if(t==="location")return{latitude:O(e.map(r=>r.latitude)),longitude:O(e.map(r=>r.longitude))};throw new Error(`Impossible de fusionner en mode médiane des valeurs de type ${t}`)}function ke(t,e){if(!$e("boundingbox",t,e))throw new Error(`Impossible de fusionner en mode union des valeurs de type ${t}`);const n=Math.min(...e.map(i=>i.x)),r=Math.min(...e.map(i=>i.y)),a=Math.max(...e.map(i=>i.x+i.w)),o=Math.max(...e.map(i=>i.y+i.h));return{x:n,y:r,w:a-n,h:o-r}}function X(t,e){if(t==="integer"||t==="float")return e;if(t==="boolean")return e.map(n=>n?1:0);if(t==="date")return e.map(n=>new Date(n).getTime());throw new Error(`Impossible de convertir des valeurs de type ${t} en nombre`)}function S(t,e,n){const r=a=>e===t&&(n===void 0||!(a(n)instanceof l.errors));switch(t){case"boolean":return r(l("boolean"));case"integer":case"float":return r(l("number"));case"enum":return r(l("string | number"));case"date":return r(l("Date"));case"location":return r(l({latitude:"number",longitude:"number"}));case"boundingbox":return r(l({x:"number",y:"number",w:"number",h:"number"}));case"string":return r(l("string"));default:throw new Error(`Type inconnu: ${t}`)}}function $e(t,e,n){return n.every(r=>S(t,e,r))}function Ge(t,e){return S(t,t,e)}function Ye(t,e){if(!S(t,t,e))throw new Error(`La valeur n'est pas de type ${t}: ${JSON.stringify(e)}`);return e}function Qe(t){return(e,n)=>(typeof e!="string"&&(e=e.id),typeof n!="string"&&(n=n.id),t.metadataOrder?t.metadataOrder.indexOf(e)-t.metadataOrder.indexOf(n):oe(e,n))}function We(t,e){if(e){const n=H(e,t);return IDBKeyRange.bound(n+":",n+":￿")}else return IDBKeyRange.bound(q("",t),q("￿",t))}export{Ne as M,c as a,Qe as b,Ye as c,xe as d,Ie as e,T as f,Pe as g,Ge as h,Q as i,S as j,be as k,_e as l,We as m,de as n,G as s};
