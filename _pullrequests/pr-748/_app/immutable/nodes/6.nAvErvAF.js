import"../chunks/DsnmJJEf.js";import{A as ee,a as Y,g as t,aC as G,J as j,G as H,i as d,B as ae,aD as w,F as y,aA as l,aB as b,K as o,t as D,D as Q,aE as se,aF as te}from"../chunks/DLg_PPZ_.js";import{s as X}from"../chunks/9TbOa8jV.js";import{i as O}from"../chunks/D67Hg_eN.js";import{c as re}from"../chunks/Cmdet9fQ.js";import{s as oe,b as ie}from"../chunks/BNnFn6yw.js";import{t as J,f as K}from"../chunks/CKZ3iiSi.js";import{A as le}from"../chunks/BVsv4-Sq.js";import{B as ne}from"../chunks/BPUwB5iN.js";import{C as ce}from"../chunks/F8sFxmbw.js";import{c as Z,e as de,a as me,b as fe,d as ve}from"../chunks/hwqyxWC0.js";import{t as x,e as pe}from"../chunks/BCT7fajR.js";import{i as ue,a as ge,b as _e,d as be,c as he}from"../chunks/BbY4Fv7Y.js";import{L as U}from"../chunks/Bx3yqWKm.js";import{g as Ie}from"../chunks/pFYPpK6n.js";import{P as ye}from"../chunks/BidjZCUT.js";import{s as ze}from"../chunks/DgdFC4m6.js";import{u as s,g as Ce,i as Ae}from"../chunks/yjQBtq-m.js";import{t as W}from"../chunks/BVoxKip6.js";import{s as Me}from"../chunks/Csf0LG85.js";import{w as Se}from"../chunks/B6p9bkuE.js";const $=N=>{var h=j(),z=H(h);{var L=n=>{const m=Q(()=>{const{model:C}=s.classificationModels[s.selectedClassificationModel];return{model:C}}),P=Q(()=>new URL(typeof t(m).model=="string"?t(m).model:t(m).model?.url));var g=we(),k=l(g),R=l(k,!0);o(k),o(g),D((C,e)=>{oe(g,"href",C),X(R,e)},[()=>t(P).toString(),()=>t(P).pathname.split("/").at(-1)]),d(n,g)};O(z,n=>{s.classificationInferenceAvailable&&n(L)})}d(N,h)};var we=y('<a target="_blank" class="svelte-1o687fz"><code class="svelte-1o687fz"> </code></a>'),xe=y('<section class="loading svelte-1o687fz"><!> <p>Chargement du modèle de classification</p> <p class="source svelte-1o687fz"><!></p> <div class="progressbar svelte-1o687fz"><!></div></section>'),Oe=y('<div class="empty svelte-1o687fz"><svelte-css-wrapper style="display: contents"><!></svelte-css-wrapper> <p>Aucune image</p> <!></div>'),Le=y("<section><!> <!></section>"),Pe=y('<pre class="trace svelte-1o687fz"> </pre>'),ke=y('<section class="loading errored svelte-1o687fz"><!> <h2 class="svelte-1o687fz">Oops!</h2> <p class="svelte-1o687fz">Impossible de charger le modèle de classification</p> <p class="source svelte-1o687fz"><!></p> <p class="message svelte-1o687fz"> </p> <!></section>');function ea(N,h){ee(h,!0),ze({title:"Classification"});const z=Q(()=>x.Observation.state.map(e=>({id:e.id,addedAt:e.addedAt,name:e.label,virtual:!1,data:{observation:e,images:x.Image.state.filter(a=>e.images.includes(a.id))}})));let L=G(0),n=G(!1),m=G(void 0);async function P(){if(t(n)||!s.currentProtocol||!s.classificationInferenceAvailable)return;const e=me(s.currentProtocol,s.selectedClassificationModel);if(!e){W.error(`Aucun paramètre d'inférence défini pour le modèle ${s.selectedClassificationModel} sur le protocole ${s.currentProtocol.name}`);return}await h.data.swarpc.loadModel.broadcast({protocolId:s.currentProtocol.id,request:e.model,classmapping:e.classmapping,task:"classification"},a=>{w(L,Me(a.values())/h.data.parallelism)}).then(()=>{w(n,!0)}).catch(a=>{console.error(a),W.error("Erreur lors du chargement du modèle de classification")})}Y(()=>{if(!s.classificationInferenceAvailable||!t(n)||t(m))return;const e=x.Image.state.filter(a=>ue(a)&&!ge(a)&&!s.loadingImages.has(a.id));Z(e.map(a=>a.id))}),Se(()=>s.selectedClassificationModel,()=>{w(n,!1),P().catch(e=>{w(m,e,!0)}).finally(()=>{w(n,!0)})}),Y(()=>{s.setSelection&&de()});var g=j(),k=H(g);{var R=e=>{var a=xe(),F=l(a);U(F,{loading:!0});var A=b(F,4),T=l(A);$(T),o(A);var f=b(A,2),r=l(f);ye(r,{percentage:!0,alwaysActive:!0,get progress(){return t(L)}}),o(f),o(a),J(1,a,()=>K,()=>({duration:100})),d(e,a)},C=e=>{var a=j(),F=H(a);{var A=f=>{var r=Le();let M;var I=l(r);le(I,{get items(){return t(z)},get sort(){return Ce().gallerySort},groups:["Recadrées","Non recadrées"],grouping:({data:{images:v}})=>v.some(i=>s.cropMetadataValueOf(i))?"Recadrées":"Non recadrées",item:(v,i,p)=>{let _=()=>i?.().observation,B=()=>i?.().images,c=()=>p?.().id;ce(v,{get observation(){return _()},get images(){return B()},boxes:"apply-first",loadingStatusText:"Analyse…",onretry:()=>{s.erroredImages.delete(c());const E=x.Observation.getFromState(c())?.images;E?(E.forEach(q=>s.erroredImages.delete(q)),Z(E)):W.error(`L'observation ${c()} est vide`)},ondelete:async()=>{(x.Observation.getFromState(c())?.images??[c()]).forEach(q=>fe(q,"Cancelled by user")),_e(c())&&await be(he(c())),await ve(c(),{notFoundOk:!0,recursive:!0})}})},$$slots:{item:!0}});var V=b(I,2);{var S=u=>{var v=Oe(),i=l(v);re(i,()=>({"--size":"6em"})),U(i.lastChild,{variant:"empty"}),o(i);var p=b(i,4);ne(p,{onclick:()=>Ie("/import"),children:(_,B)=>{se();var c=te("Importer");d(_,c)},$$slots:{default:!0}}),o(v),d(u,v)};O(V,u=>{t(z).length||u(S)})}o(r),D(u=>M=ie(r,1,"observations svelte-1o687fz",null,M,u),[()=>({empty:!t(z).length})]),J(1,r,()=>K,()=>({duration:100})),d(f,r)},T=f=>{var r=ke(),M=l(r);U(M,{variant:"error"});var I=b(M,6),V=l(I);$(V),o(I);var S=b(I,2),u=l(S,!0);o(S);var v=b(S,2);{var i=p=>{var _=Pe(),B=l(_,!0);o(_),D(()=>X(B,t(m)?.stack)),d(p,_)};O(v,p=>{Ae()&&p(i)})}o(r),D(p=>X(u,p),[()=>pe(t(m))]),J(1,r,()=>K,()=>({duration:100})),d(f,r)};O(F,f=>{t(m)?f(T,!1):f(A)},!0)}d(e,a)};O(k,e=>{t(n)?e(C,!1):e(R)})}d(N,g),ae()}export{ea as component};
