const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./BCT7fajR.js","./DLg_PPZ_.js","./Csf0LG85.js","./nRrrBBXZ.js"])))=>i.map(i=>d[i]);
import{g as c,D as M,aC as w,br as T,af as Z,aD as f,b5 as O,aM as _}from"./DLg_PPZ_.js";import{g as ae,c as k,j as G,k as se,l as ie,q as oe,r as ce,s as ue,u as de,v as fe,w as J,x as le,y as he,z as me,A as ge,t as p,B as R,C as z,D as A,E as pe,b,S as we,f as H,F as Me,G as ye,M as be}from"./BCT7fajR.js";import{_ as ve}from"./PPVm8Dsz.js";import{a as Q,n as Oe,e as xe,s as Ie,m as ee,b as I}from"./Csf0LG85.js";function Se(n,...e){const t=ae.bind(null,n||e.find(r=>typeof r=="object"));return e.map(t)}function W(n,e){const t=k(n,e?.in);return t.setHours(0,0,0,0),t}function Ee(n,e,t){const[r,a]=Se(t?.in,n,e),s=W(r),i=W(a),u=+s-G(s),o=+i-G(i);return Math.round((u-o)/se)}function Pe(n,e){const t=k(n,e?.in);return t.setFullYear(t.getFullYear(),0,1),t.setHours(0,0,0,0),t}function De(n,e){const t=k(n,e?.in);return Ee(t,Pe(t))+1}function d(n,e){const t=n<0?"-":"",r=Math.abs(n).toString().padStart(e,"0");return t+r}const v={y(n,e){const t=n.getFullYear(),r=t>0?t:1-t;return d(e==="yy"?r%100:r,e.length)},M(n,e){const t=n.getMonth();return e==="M"?String(t+1):d(t+1,2)},d(n,e){return d(n.getDate(),e.length)},a(n,e){const t=n.getHours()/12>=1?"pm":"am";switch(e){case"a":case"aa":return t.toUpperCase();case"aaa":return t;case"aaaaa":return t[0];case"aaaa":default:return t==="am"?"a.m.":"p.m."}},h(n,e){return d(n.getHours()%12||12,e.length)},H(n,e){return d(n.getHours(),e.length)},m(n,e){return d(n.getMinutes(),e.length)},s(n,e){return d(n.getSeconds(),e.length)},S(n,e){const t=e.length,r=n.getMilliseconds(),a=Math.trunc(r*Math.pow(10,t-3));return d(a,e.length)}},S={midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},V={G:function(n,e,t){const r=n.getFullYear()>0?1:0;switch(e){case"G":case"GG":case"GGG":return t.era(r,{width:"abbreviated"});case"GGGGG":return t.era(r,{width:"narrow"});case"GGGG":default:return t.era(r,{width:"wide"})}},y:function(n,e,t){if(e==="yo"){const r=n.getFullYear(),a=r>0?r:1-r;return t.ordinalNumber(a,{unit:"year"})}return v.y(n,e)},Y:function(n,e,t,r){const a=ue(n,r),s=a>0?a:1-a;if(e==="YY"){const i=s%100;return d(i,2)}return e==="Yo"?t.ordinalNumber(s,{unit:"year"}):d(s,e.length)},R:function(n,e){const t=ce(n);return d(t,e.length)},u:function(n,e){const t=n.getFullYear();return d(t,e.length)},Q:function(n,e,t){const r=Math.ceil((n.getMonth()+1)/3);switch(e){case"Q":return String(r);case"QQ":return d(r,2);case"Qo":return t.ordinalNumber(r,{unit:"quarter"});case"QQQ":return t.quarter(r,{width:"abbreviated",context:"formatting"});case"QQQQQ":return t.quarter(r,{width:"narrow",context:"formatting"});case"QQQQ":default:return t.quarter(r,{width:"wide",context:"formatting"})}},q:function(n,e,t){const r=Math.ceil((n.getMonth()+1)/3);switch(e){case"q":return String(r);case"qq":return d(r,2);case"qo":return t.ordinalNumber(r,{unit:"quarter"});case"qqq":return t.quarter(r,{width:"abbreviated",context:"standalone"});case"qqqqq":return t.quarter(r,{width:"narrow",context:"standalone"});case"qqqq":default:return t.quarter(r,{width:"wide",context:"standalone"})}},M:function(n,e,t){const r=n.getMonth();switch(e){case"M":case"MM":return v.M(n,e);case"Mo":return t.ordinalNumber(r+1,{unit:"month"});case"MMM":return t.month(r,{width:"abbreviated",context:"formatting"});case"MMMMM":return t.month(r,{width:"narrow",context:"formatting"});case"MMMM":default:return t.month(r,{width:"wide",context:"formatting"})}},L:function(n,e,t){const r=n.getMonth();switch(e){case"L":return String(r+1);case"LL":return d(r+1,2);case"Lo":return t.ordinalNumber(r+1,{unit:"month"});case"LLL":return t.month(r,{width:"abbreviated",context:"standalone"});case"LLLLL":return t.month(r,{width:"narrow",context:"standalone"});case"LLLL":default:return t.month(r,{width:"wide",context:"standalone"})}},w:function(n,e,t,r){const a=oe(n,r);return e==="wo"?t.ordinalNumber(a,{unit:"week"}):d(a,e.length)},I:function(n,e,t){const r=ie(n);return e==="Io"?t.ordinalNumber(r,{unit:"week"}):d(r,e.length)},d:function(n,e,t){return e==="do"?t.ordinalNumber(n.getDate(),{unit:"date"}):v.d(n,e)},D:function(n,e,t){const r=De(n);return e==="Do"?t.ordinalNumber(r,{unit:"dayOfYear"}):d(r,e.length)},E:function(n,e,t){const r=n.getDay();switch(e){case"E":case"EE":case"EEE":return t.day(r,{width:"abbreviated",context:"formatting"});case"EEEEE":return t.day(r,{width:"narrow",context:"formatting"});case"EEEEEE":return t.day(r,{width:"short",context:"formatting"});case"EEEE":default:return t.day(r,{width:"wide",context:"formatting"})}},e:function(n,e,t,r){const a=n.getDay(),s=(a-r.weekStartsOn+8)%7||7;switch(e){case"e":return String(s);case"ee":return d(s,2);case"eo":return t.ordinalNumber(s,{unit:"day"});case"eee":return t.day(a,{width:"abbreviated",context:"formatting"});case"eeeee":return t.day(a,{width:"narrow",context:"formatting"});case"eeeeee":return t.day(a,{width:"short",context:"formatting"});case"eeee":default:return t.day(a,{width:"wide",context:"formatting"})}},c:function(n,e,t,r){const a=n.getDay(),s=(a-r.weekStartsOn+8)%7||7;switch(e){case"c":return String(s);case"cc":return d(s,e.length);case"co":return t.ordinalNumber(s,{unit:"day"});case"ccc":return t.day(a,{width:"abbreviated",context:"standalone"});case"ccccc":return t.day(a,{width:"narrow",context:"standalone"});case"cccccc":return t.day(a,{width:"short",context:"standalone"});case"cccc":default:return t.day(a,{width:"wide",context:"standalone"})}},i:function(n,e,t){const r=n.getDay(),a=r===0?7:r;switch(e){case"i":return String(a);case"ii":return d(a,e.length);case"io":return t.ordinalNumber(a,{unit:"day"});case"iii":return t.day(r,{width:"abbreviated",context:"formatting"});case"iiiii":return t.day(r,{width:"narrow",context:"formatting"});case"iiiiii":return t.day(r,{width:"short",context:"formatting"});case"iiii":default:return t.day(r,{width:"wide",context:"formatting"})}},a:function(n,e,t){const a=n.getHours()/12>=1?"pm":"am";switch(e){case"a":case"aa":return t.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"aaa":return t.dayPeriod(a,{width:"abbreviated",context:"formatting"}).toLowerCase();case"aaaaa":return t.dayPeriod(a,{width:"narrow",context:"formatting"});case"aaaa":default:return t.dayPeriod(a,{width:"wide",context:"formatting"})}},b:function(n,e,t){const r=n.getHours();let a;switch(r===12?a=S.noon:r===0?a=S.midnight:a=r/12>=1?"pm":"am",e){case"b":case"bb":return t.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"bbb":return t.dayPeriod(a,{width:"abbreviated",context:"formatting"}).toLowerCase();case"bbbbb":return t.dayPeriod(a,{width:"narrow",context:"formatting"});case"bbbb":default:return t.dayPeriod(a,{width:"wide",context:"formatting"})}},B:function(n,e,t){const r=n.getHours();let a;switch(r>=17?a=S.evening:r>=12?a=S.afternoon:r>=4?a=S.morning:a=S.night,e){case"B":case"BB":case"BBB":return t.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"BBBBB":return t.dayPeriod(a,{width:"narrow",context:"formatting"});case"BBBB":default:return t.dayPeriod(a,{width:"wide",context:"formatting"})}},h:function(n,e,t){if(e==="ho"){let r=n.getHours()%12;return r===0&&(r=12),t.ordinalNumber(r,{unit:"hour"})}return v.h(n,e)},H:function(n,e,t){return e==="Ho"?t.ordinalNumber(n.getHours(),{unit:"hour"}):v.H(n,e)},K:function(n,e,t){const r=n.getHours()%12;return e==="Ko"?t.ordinalNumber(r,{unit:"hour"}):d(r,e.length)},k:function(n,e,t){let r=n.getHours();return r===0&&(r=24),e==="ko"?t.ordinalNumber(r,{unit:"hour"}):d(r,e.length)},m:function(n,e,t){return e==="mo"?t.ordinalNumber(n.getMinutes(),{unit:"minute"}):v.m(n,e)},s:function(n,e,t){return e==="so"?t.ordinalNumber(n.getSeconds(),{unit:"second"}):v.s(n,e)},S:function(n,e){return v.S(n,e)},X:function(n,e,t){const r=n.getTimezoneOffset();if(r===0)return"Z";switch(e){case"X":return F(r);case"XXXX":case"XX":return x(r);case"XXXXX":case"XXX":default:return x(r,":")}},x:function(n,e,t){const r=n.getTimezoneOffset();switch(e){case"x":return F(r);case"xxxx":case"xx":return x(r);case"xxxxx":case"xxx":default:return x(r,":")}},O:function(n,e,t){const r=n.getTimezoneOffset();switch(e){case"O":case"OO":case"OOO":return"GMT"+X(r,":");case"OOOO":default:return"GMT"+x(r,":")}},z:function(n,e,t){const r=n.getTimezoneOffset();switch(e){case"z":case"zz":case"zzz":return"GMT"+X(r,":");case"zzzz":default:return"GMT"+x(r,":")}},t:function(n,e,t){const r=Math.trunc(+n/1e3);return d(r,e.length)},T:function(n,e,t){return d(+n,e.length)}};function X(n,e=""){const t=n>0?"-":"+",r=Math.abs(n),a=Math.trunc(r/60),s=r%60;return s===0?t+String(a):t+String(a)+e+d(s,2)}function F(n,e){return n%60===0?(n>0?"-":"+")+d(Math.abs(n)/60,2):x(n,e)}function x(n,e=""){const t=n>0?"-":"+",r=Math.abs(n),a=d(Math.trunc(r/60),2),s=d(r%60,2);return t+a+e+s}const Ce=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,Le=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,Te=/^'([^]*?)'?$/,ke=/''/g,_e=/[a-zA-Z]/;function $e(n,e,t){const r=de(),a=r.locale??fe,s=r.firstWeekContainsDate??r.locale?.options?.firstWeekContainsDate??1,i=r.weekStartsOn??r.locale?.options?.weekStartsOn??0,u=k(n,t?.in);if(!J(u))throw new RangeError("Invalid time value");let o=e.match(Le).map(l=>{const h=l[0];if(h==="p"||h==="P"){const y=le[h];return y(l,a.formatLong)}return l}).join("").match(Ce).map(l=>{if(l==="''")return{isToken:!1,value:"'"};const h=l[0];if(h==="'")return{isToken:!1,value:qe(l)};if(V[h])return{isToken:!0,value:l};if(h.match(_e))throw new RangeError("Format string contains an unescaped latin alphabet character `"+h+"`");return{isToken:!1,value:l}});a.localize.preprocessor&&(o=a.localize.preprocessor(u,o));const m={firstWeekContainsDate:s,weekStartsOn:i,locale:a};return o.map(l=>{if(!l.isToken)return l.value;const h=l.value;(he(h)||me(h))&&ge(h,e,String(n));const y=V[h[0]];return y(u,h,a.localize,m)}).join("")}function qe(n){const e=n.match(Te);return e?e[1].replace(ke,"'"):n}const Ye=M(()=>p.Settings.state.find(n=>n.id==="user")??p.Settings.state.find(n=>n.id==="defaults"));function Y(){return c(Ye)}async function Be(n,e){console.debug("setSetting",n,e);const t=await p.Settings.get("user")??await p.Settings.get("defaults");if(!t)throw new Error("Les réglages par défaut n'ont pas été initialisés. Rechargez la page.");return p.Settings.set({...t,id:"user",[n]:e})}async function Ne(n,{fallback:e}={}){const t=await p.Settings.get("user")??await p.Settings.get("defaults");if(!t){if(e!==void 0)return e;throw new Error("Les réglages par défaut n'ont pas été initialisés. Rechargez la page.")}return t[n]}async function nt(n){const e=await p.Settings.get("user")??await p.Settings.get("defaults");if(!e)throw new Error("Les réglages par défaut n'ont pas été initialisés. Rechargez la page.");return p.Settings.set({...e,id:"user",[n]:!e[n]})}function at(){return Y().showTechnicalMetadata}var Ge=["forEach","isDisjointFrom","isSubsetOf","isSupersetOf"],Re=["difference","intersection","symmetricDifference","union"],j=!1;class D extends Set{#r=new Map;#e=w(0);#t=w(0);#s=T||-1;constructor(e){if(super(),e){for(var t of e)super.add(t);this.#t.v=super.size}j||this.#a()}#n(e){return T===this.#s?w(e):Z(e)}#a(){j=!0;var e=D.prototype,t=Set.prototype;for(const r of Ge)e[r]=function(...a){return c(this.#e),t[r].apply(this,a)};for(const r of Re)e[r]=function(...a){c(this.#e);var s=t[r].apply(this,a);return new D(s)}}has(e){var t=super.has(e),r=this.#r,a=r.get(e);if(a===void 0){if(!t)return c(this.#e),!1;a=this.#n(!0),r.set(e,a)}return c(a),t}add(e){return super.has(e)||(super.add(e),f(this.#t,super.size),O(this.#e)),this}delete(e){var t=super.delete(e),r=this.#r,a=r.get(e);return a!==void 0&&(r.delete(e),f(a,!1)),t&&(f(this.#t,super.size),O(this.#e)),t}clear(){if(super.size!==0){super.clear();var e=this.#r;for(var t of e.values())f(t,!1);e.clear(),f(this.#t,0),O(this.#e)}}keys(){return this.values()}values(){return c(this.#e),super.values()}entries(){return c(this.#e),super.entries()}[Symbol.iterator](){return this.keys()}get size(){return c(this.#t)}}class $ extends Map{#r=new Map;#e=w(0);#t=w(0);#s=T||-1;constructor(e){if(super(),e){for(var[t,r]of e)super.set(t,r);this.#t.v=super.size}}#n(e){return T===this.#s?w(e):Z(e)}has(e){var t=this.#r,r=t.get(e);if(r===void 0){var a=super.get(e);if(a!==void 0)r=this.#n(0),t.set(e,r);else return c(this.#e),!1}return c(r),!0}forEach(e,t){this.#a(),super.forEach(e,t)}get(e){var t=this.#r,r=t.get(e);if(r===void 0){var a=super.get(e);if(a!==void 0)r=this.#n(0),t.set(e,r);else{c(this.#e);return}}return c(r),super.get(e)}set(e,t){var r=this.#r,a=r.get(e),s=super.get(e),i=super.set(e,t),u=this.#e;if(a===void 0)a=this.#n(0),r.set(e,a),f(this.#t,super.size),O(u);else if(s!==t){O(a);var o=u.reactions===null?null:new Set(u.reactions),m=o===null||!a.reactions?.every(l=>o.has(l));m&&O(u)}return i}delete(e){var t=this.#r,r=t.get(e),a=super.delete(e);return r!==void 0&&(t.delete(e),f(this.#t,super.size),f(r,-1),O(this.#e)),a}clear(){if(super.size!==0){super.clear();var e=this.#r;f(this.#t,0);for(var t of e.values())f(t,-1);O(this.#e),e.clear()}}#a(){c(this.#e);var e=this.#r;if(this.#t.v!==e.size){for(var t of super.keys())if(!e.has(t)){var r=this.#n(0);e.set(t,r)}}for([,r]of this.#r)c(r)}keys(){return c(this.#e),super.keys()}values(){return this.#a(),super.values()}entries(){return this.#a(),super.entries()}[Symbol.iterator](){return this.entries()}get size(){return c(this.#t),super.size}}async function ze({db:n,metadataId:e,confidence:t,value:r,alternatives:a}){return await Promise.all([{value:r,confidence:t},...a].map(async({confidence:s,value:i})=>{const u=await n.get("MetadataOption",R(e,i));if(!u?.cascade)return;const{cascade:o}=u;return{cascade:o,confidence:s}})).then(s=>{const i=Q(s.filter(Oe).flatMap(({cascade:o,confidence:m})=>xe(o).map(([l,h])=>({optionId:R(l,h),confidence:m}))),o=>o.optionId,o=>o.confidence);return[...Q(i.entries(),([o])=>z(o).metadataId,([o,m])=>({value:z(o).key,confidence:Ie(m)})).entries()].map(([o,m])=>{const[{value:l,confidence:h},...y]=m.toSorted(({confidence:E},{confidence:C})=>C-E);return{metadataId:o,value:l,confidence:h,alternatives:y}})})}async function te(...n){try{const e=await ve(()=>import("./BCT7fajR.js").then(t=>t.a4),__vite__mapDeps([0,1,2,3]),import.meta.url);await Promise.all(n.map(t=>e.tables[t].refresh()))}catch(e){console.warn(`Cannot refresh tables ${n}:`,e)}}function Ae(n,e,t){const r=n.metadata[t];if(r!==void 0)return{...r,value:Ke(e,r.value)}}function B(n){return JSON.stringify(n instanceof Date&&J(n)?$e(n,"yyyy-MM-dd'T'HH:mm:ss"):n)}function st(n){return ee(n,({value:e,...t})=>({...t,value:B(e)}))}async function U({db:n,subjectId:e,metadataId:t,type:r,value:a,confidence:s=1,alternatives:i=[],manuallyModified:u=!1,cascadedFrom:o=[],abortSignal:m}){if(!A(t))throw new Error(`Le metadataId ${t} n'est pas namespacé`);m?.throwIfAborted();const l={value:B(a),confidence:s,manuallyModified:u,alternatives:Object.fromEntries(i.map(g=>[B(g.value),g.confidence]))};l.alternatives=Object.fromEntries(Object.entries(l.alternatives).filter(([g])=>g!==l.value)),console.debug(`Store metadata ${t} = `,a,` in ${e}`,l);const h=await n.get("Metadata",t);if(!h)throw new Error(`Métadonnée inconnue avec l'ID ${t}`);if(r&&h.type!==r)throw new Error(`Type de métadonnée incorrect: ${h.type} !== ${r}`);m?.throwIfAborted();const y=await n.get("Image",e),E=await n.get("Observation",e),C=await n.getAll("Image").then(g=>g.filter(({fileId:L})=>L===e));if(m?.throwIfAborted(),y)y.metadata[t]=l,n.put("Image",y);else if(E)E.metadataOverrides[t]=l,n.put("Observation",E);else if(C)for(const{id:g}of C)await U({db:n,subjectId:g,metadataId:t,value:a,confidence:s,manuallyModified:u,abortSignal:m});else throw new Error(`Aucune image ou observation avec l'ID ${e}`);m?.throwIfAborted();const ne=await ze({db:n,metadataId:t,value:a,confidence:s,alternatives:i});for(const g of ne){if(m?.throwIfAborted(),o.includes(g.metadataId))throw new Error(`Boucle infinie de cascade détectée pour ${g.metadataId} avec ${g.value}: ${o.join(" -> ")} -> ${t} -> ${g.metadataId}`);console.info(`Cascading metadata ${t} @ ${a} -> ${g.metadataId}  = ${g.value}`);const L=A(t);if(!L)throw new Error(`Metadata ${t} is not namespaced, cannot cascade onto ${g.metadataId}`);g.metadataId=pe(g.metadataId,L),await U({db:n,subjectId:e,manuallyModified:u,cascadedFrom:[...o,t],abortSignal:m,...g})}o.length===0&&await te(y?"Image":"Observation")}async function He({db:n,subjectId:e,metadataId:t,recursive:r=!1,reactive:a=!0}){const s=await n.get("Image",e),i=await n.get("Observation",e);if(!s&&!i)throw new Error(`Aucune image ou observation avec l'ID ${e}`);if(console.debug(`Delete metadata ${t} in ${e}`),s)delete s.metadata[t],n.put("Image",s);else if(i&&(delete i.metadataOverrides[t],n.put("Observation",i),r))for(const u of i.images)await He({db:n,subjectId:u,recursive:!1,metadataId:t,reactive:!1});a&&await te("Image","Observation")}async function it(n,e,t){const r=await K(n,e.map(u=>u.metadata)),a=await K(n,t.map(u=>u.metadataOverrides)),s=new Set([...Object.keys(r),...Object.keys(a)]),i={};for(const u of s){const o=a[u]??r[u];o&&(i[u]=o)}return i}async function K(n,e){if(e.length===1)return ee(e[0],a=>({...a,merged:!1}));const t={},r=new Set(e.flatMap(a=>Object.keys(a)));for(const a of r){const s=we.Metadata.assert(await n.get("Metadata",a));if(!s){console.warn(`Cannot merge metadata values for unknown key ${a}`);continue}const i=e.flatMap(o=>Object.entries(o).filter(([m])=>m===a).map(([,m])=>m)),u=Qe(s,i);u!=null&&(t[a]={...u,merged:new Set(i.map(o=>JSON.stringify(o.value))).size>1})}return t}function Qe(n,e){const t=(r,a)=>Object.fromEntries(a.flatMap(s=>Object.keys(s.alternatives)).map(s=>[s,r(a.flatMap(i=>i.alternatives[s]??null).filter(Boolean))]));switch(n.mergeMethod){case"average":return{value:Xe(n.type,e.map(r=>r.value)),manuallyModified:e.some(r=>r.manuallyModified),confidence:I(e.map(r=>r.confidence)),alternatives:t(I,e)};case"max":case"min":return{value:Ve(n.type,e,n.mergeMethod==="max"?q:We),manuallyModified:e.some(r=>r.manuallyModified),confidence:q(e.map(r=>r.confidence)),alternatives:t(q,e)};case"median":return{value:Fe(n.type,e.map(r=>r.value)),manuallyModified:e.some(r=>r.manuallyModified),confidence:P(e.map(r=>r.confidence)),alternatives:t(P,e)};case"union":return{value:je(n.type,e.map(r=>r.value)),manuallyModified:e.some(r=>r.manuallyModified),confidence:I(e.map(r=>r.confidence)),alternatives:t(I,e)};case"none":return null}}const q=n=>Math.max(...n),We=n=>Math.min(...n);function Ve(n,e,t){const r=Math.max(...e.map(s=>s.confidence)),a=e.filter(s=>s.confidence===r);try{return t(a.map(s=>s.value))}catch(s){return console.error(s),a[0].value}}function Xe(n,e){const t=r=>I(re(n,r));if(n==="boolean")return t(e)>.5;if(n==="integer")return Math.ceil(t(e));if(n==="float")return t(e);if(n==="date")return new Date(t(e));if(n==="location")return{latitude:I(e.map(r=>r.latitude)),longitude:I(e.map(r=>r.longitude))};throw new Error(`Impossible de fusionner en mode moyenne des valeurs de type ${n}`)}const P=n=>{const e=n.sort((r,a)=>r-a),t=Math.floor(e.length/2);return e.length%2===0?(e[t-1]+e[t])/2:e[t]};function Fe(n,e){const t=r=>P(re(n,r));if(n==="boolean")return t(e)>.5;if(n==="integer")return Math.ceil(t(e));if(n==="float")return t(e);if(n==="date")return new Date(t(e));if(n==="location")return{latitude:P(e.map(r=>r.latitude)),longitude:P(e.map(r=>r.longitude))};throw new Error(`Impossible de fusionner en mode médiane des valeurs de type ${n}`)}function je(n,e){if(!Ue("boundingbox",n,e))throw new Error(`Impossible de fusionner en mode union des valeurs de type ${n}`);const t=Math.min(...e.map(i=>i.x)),r=Math.min(...e.map(i=>i.y)),a=Math.max(...e.map(i=>i.x+i.w)),s=Math.max(...e.map(i=>i.y+i.h));return{x:t,y:r,w:a-t,h:s-r}}function re(n,e){if(n==="integer"||n==="float")return e;if(n==="boolean")return e.map(t=>t?1:0);if(n==="date")return e.map(t=>new Date(t).getTime());throw new Error(`Impossible de convertir des valeurs de type ${n} en nombre`)}function N(n,e,t){const r=a=>e===n&&(t===void 0||!(a(t)instanceof b.errors));switch(n){case"boolean":return r(b("boolean"));case"integer":case"float":return r(b("number"));case"enum":return r(b("string | number"));case"date":return r(b("Date"));case"location":return r(b({latitude:"number",longitude:"number"}));case"boundingbox":return r(b({x:"number",y:"number",w:"number",h:"number"}));case"string":return r(b("string"));default:throw new Error(`Type inconnu: ${n}`)}}function Ue(n,e,t){return t.every(r=>N(n,e,r))}function ot(n,e){return N(n,n,e)}function Ke(n,e){if(!N(n,n,e))throw new Error(`La valeur n'est pas de type ${n}: ${JSON.stringify(e)}`);return e}function ct(n){return({id:e},{id:t})=>n.metadataOrder?n.metadataOrder.indexOf(e)-n.metadataOrder.indexOf(t):Me(e,t)}function ut(n,e){return IDBKeyRange.bound(H("",n),H("￿",n))}class Ze{#r=w(_({files:[],total:0,done:0,time:0,task:"",get progress(){return this.total?this.done/this.total:0},removeFile(e){const t=this.files.findIndex(r=>r.id===e);t!==-1&&this.files.splice(t,1)},reset(){this.total=0,this.done=0,this.time=0,this.task=""}}));get processing(){return c(this.#r)}set processing(e){f(this.#r,e,!0)}#e=w(_([]));get selection(){return c(this.#e)}set selection(e){f(this.#e,e,!0)}#t=w("");get imageOpenedInCropper(){return c(this.#t)}set imageOpenedInCropper(e){f(this.#t,e,!0)}#s=w("");get imagePreviouslyOpenedInCropper(){return c(this.#s)}set imagePreviouslyOpenedInCropper(e){f(this.#s,e,!0)}previewURLs=new $;erroredImages=new $;loadingImages=new D;queuedImages=new D;#n=w(_({}));get keybinds(){return c(this.#n)}set keybinds(e){f(this.#n,e,!0)}cropperZoomStates=new $;#a=w(void 0);get setSelection(){return c(this.#a)}set setSelection(e){f(this.#a,e,!0)}#i=w("");get _currentProtocolId(){return c(this.#i)}set _currentProtocolId(e){f(this.#i,e,!0)}cropMetadataValueOf(e){return Ae(e,"boundingbox",this.cropMetadataId)}#o=M(()=>p.Protocol.state.find(e=>e.id===this.currentProtocolId));get currentProtocol(){return c(this.#o)}set currentProtocol(e){f(this.#o,e)}#c=M(()=>this._currentProtocolId||localStorage.getItem("currentProtocolId")||"");get currentProtocolId(){return c(this.#c)}set currentProtocolId(e){f(this.#c,e)}setCurrentProtocolId(e){localStorage.setItem("currentProtocolId",e),this._currentProtocolId=e}#u=M(()=>p.Metadata.state.find(e=>this.currentProtocol?.metadata.includes(e.id)&&this.currentProtocol?.crop?.metadata===e.id)?.id??"crop");get cropMetadataId(){return c(this.#u)}set cropMetadataId(e){f(this.#u,e)}#d=M(()=>p.Metadata.state.find(e=>this.currentProtocol?.metadata.includes(e.id)&&this.currentProtocol?.crop?.confirmationMetadata===e.id)?.id??"");get cropConfirmationMetadataId(){return c(this.#d)}set cropConfirmationMetadataId(e){f(this.#d,e)}hasPreviewURL(e){return e?this.previewURLs.has(e):!1}setPreviewURL(e,t){console.debug("setPreviewURL",{imageFileId:e,url:t}),e&&this.previewURLs.set(e,t)}#f=M(()=>p.Metadata.state.find(e=>e.id===this.classificationMetadataId)?.infer?.neural??[]);get classificationModels(){return c(this.#f)}set classificationModels(e){f(this.#f,e)}#l=M(()=>this.currentProtocol?.crop?.infer??[]);get cropModels(){return c(this.#l)}set cropModels(e){f(this.#l,e)}#h=M(()=>{const e=this.cropMetadataId;return e?Y().protocolModelSelections[this.currentProtocolId]?.[e]??0:-1});get selectedCropModel(){return c(this.#h)}set selectedCropModel(e){f(this.#h,e)}#m=M(()=>{const e=this.classificationMetadataId;return e?Y().protocolModelSelections[this.currentProtocolId]?.[e]??0:-1});get selectedClassificationModel(){return c(this.#m)}set selectedClassificationModel(e){f(this.#m,e)}#g=M(()=>this.cropModels.length>0&&this.selectedCropModel!==-1);get cropInferenceAvailable(){return c(this.#g)}set cropInferenceAvailable(e){f(this.#g,e)}#p=M(()=>this.classificationModels.length>0&&this.selectedClassificationModel!==-1);get classificationInferenceAvailable(){return c(this.#p)}set classificationInferenceAvailable(e){f(this.#p,e)}async setModelSelections({classification:e=null,crop:t=null}){if(e===null&&t===null)return;const r={classification:this.classificationMetadataId,crop:this.cropMetadataId};if(!r.classification||!r.crop)return;const a=await Ne("protocolModelSelections"),s={};e!==null&&e!==this.selectedClassificationModel&&(s[r.classification]=e),t!==null&&t!==this.selectedCropModel&&(s[r.crop]=t),Object.keys(s).length!==0&&await Be("protocolModelSelections",{...a,[this.currentProtocolId]:{...a[this.currentProtocolId],...s}})}#w=M(()=>{const e=ye.case({id:"string",type:'"enum"',infer:be},({id:t})=>this.currentProtocol?.metadata.includes(t)).default(()=>!1);return p.Metadata.state.find(t=>e(t))?.id});get classificationMetadataId(){return c(this.#w)}set classificationMetadataId(e){f(this.#w,e)}}const dt=new Ze;export{$ as S,d as a,U as b,Ke as c,He as d,st as e,B as f,Y as g,ot as h,at as i,Ne as j,N as k,$e as l,K as m,ut as n,ct as o,it as p,Se as q,Be as s,nt as t,dt as u};
