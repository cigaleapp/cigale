import{a as l,u as i}from"./yjQBtq-m.js";import{c as D,o as v,t as _,e as O,h as y}from"./BCT7fajR.js";import{o as A,a as k}from"./D6ilWQdm.js";import{e as L,k as F,u as U}from"./Csf0LG85.js";import{_ as C}from"./PPVm8Dsz.js";import"./C8qYVKmu.js";function se(e,n){const t=D(e,n?.in);if(isNaN(+t))throw new RangeError("Invalid time value");let a="",o="";const c="-",m=":";{const r=l(t.getDate(),2),s=l(t.getMonth()+1,2);a=`${l(t.getFullYear(),4)}${c}${s}${c}${r}`}{const r=t.getTimezoneOffset();if(r!==0){const h=Math.abs(r),$=l(Math.trunc(h/60),2),S=l(h%60,2);o=`${r<0?"+":"-"}${$}:${S}`}else o="Z";const s=l(t.getHours(),2),f=l(t.getMinutes(),2),I=l(t.getSeconds(),2),R=a===""?"":"T",P=[s,f,I].join(m);a=`${a}${R}${P}${o}`}return a}const G={general:"Général",observations:"Observations",navigation:"Navigation",cropping:"Recadrage",debugmode:"Debug mode"};function ce(e,n){A(()=>{for(const[t,a]of L(n)){if(t in i.keybinds){console.warn(`Keybind ${t} already defined, not overriding.`);continue}i.keybinds[t]={group:G[a.debug?"debugmode":e],...a}}}),k(()=>{for(const t of F(n))delete i.keybinds[t]})}const N="0123456789ABCDEFGHJKMNPQRSTVWXYZ",g=32,j=16,T=10,w=0xffffffffffff;var u;(function(e){e.Base32IncorrectEncoding="B32_ENC_INVALID",e.DecodeTimeInvalidCharacter="DEC_TIME_CHAR",e.DecodeTimeValueMalformed="DEC_TIME_MALFORMED",e.EncodeTimeNegative="ENC_TIME_NEG",e.EncodeTimeSizeExceeded="ENC_TIME_SIZE_EXCEED",e.EncodeTimeValueMalformed="ENC_TIME_MALFORMED",e.PRNGDetectFailure="PRNG_DETECT",e.ULIDInvalid="ULID_INVALID",e.Unexpected="UNEXPECTED",e.UUIDInvalid="UUID_INVALID"})(u||(u={}));class d extends Error{constructor(n,t){super(`${t} (${n})`),this.name="ULIDError",this.code=n}}function B(e){const n=Math.floor(e()*g)%g;return N.charAt(n)}function V(e){const n=z(),t=n&&(n.crypto||n.msCrypto)||null;if(typeof t?.getRandomValues=="function")return()=>{const a=new Uint8Array(1);return t.getRandomValues(a),a[0]/255};if(typeof t?.randomBytes=="function")return()=>t.randomBytes(1).readUInt8()/255;throw new d(u.PRNGDetectFailure,"Failed to find a reliable PRNG")}function z(){return X()?self:typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:null}function W(e,n){let t="";for(;e>0;e--)t=B(n)+t;return t}function H(e,n=T){if(isNaN(e))throw new d(u.EncodeTimeValueMalformed,`Time must be a number: ${e}`);if(e>w)throw new d(u.EncodeTimeSizeExceeded,`Cannot encode a time larger than ${w}: ${e}`);if(e<0)throw new d(u.EncodeTimeNegative,`Time must be positive: ${e}`);if(Number.isInteger(e)===!1)throw new d(u.EncodeTimeValueMalformed,`Time must be an integer: ${e}`);let t,a="";for(let o=n;o>0;o--)t=e%g,a=N.charAt(t)+a,e=(e-t)/g;return a}function X(){return typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope}function Y(e,n){const t=V(),a=Date.now();return H(a,T)+W(j,t)}const p={maxMemoryUsageInMB:1024,maxResolutionInMP:100};function me(e,n=0){return`${e}_${n.toString().padStart(6,"0")}`}function fe(){return Y()}function b(e){return/^[0-9A-Z]{26}_\d+$/.test(e)}function x(e){return new Error(`Identifiant d'image invalide (le format correct est aaaaaaaaaaaaaaaaaaaaaaaaaa_nnnnnn) : ${e}`)}function le(e){if(e===void 0)return e;if(!b(e))throw x(e);return e?.replace(/(_\d+)+$/,"")}function ue(e,n){return!e||!n?!1:i.erroredImages.has(n)?!0:_.Image.state.some(t=>t.fileId===n&&t.boundingBoxesAnalyzed)}function de(e){return!!(i.classificationMetadataId&&e.metadata[i.classificationMetadataId]||i.erroredImages.has(e.id))}function ge(e){return!!(e.fileId||i.erroredImages.has(e.id))}async function Ie(e,n,t=!0){await v(["Image","ImageFile","ImagePreviewFile","Observation"],{},async o=>{const c=await o.objectStore("Observation").getAll(),m=Q(e);try{o.objectStore("ImageFile").delete(e),o.objectStore("ImagePreviewFile").delete(e);for(const r of m){o.objectStore("Image").delete(r.id);for(const s of c){const f=s.images.filter(I=>I!==r.id);f.length===0?o.objectStore("Observation").delete(s.id):f.length<s.images.length&&o.objectStore("Observation").put({...s,images:f})}}}catch(r){if(!t)return Promise.reject(r)}}),i.erroredImages.delete(e),i.loadingImages.delete(e),i.queuedImages.delete(e),i.imageOpenedInCropper===e&&(i.imageOpenedInCropper="");const a=i.previewURLs.get(e);a&&(URL.revokeObjectURL(a),i.previewURLs.delete(e))}async function pe({id:e,originalBytes:n,resizedBytes:t,contentType:a,filename:o,width:c,height:m,tx:r}){await v(["ImageFile","ImagePreviewFile"],{},async s=>{s.objectStore("ImageFile").put({id:e,bytes:n,contentType:a,filename:o,dimensions:{width:c,height:m}}),s.objectStore("ImagePreviewFile").put({id:e,bytes:t,contentType:a,filename:o,dimensions:{width:c,height:m}});const f=new Blob([t],{type:a});i.setPreviewURL(e,URL.createObjectURL(f))})}const E=1024,M=({width:e,height:n})=>Math.round(E*n/e),Z=["image/CR2","image/x-canon-cr2","image/x-dcraw","image/x-canon-crw","image/x-kodak-dcr","image/x-adobe-dng","image/x-epson-erf","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-olympus-orf","image/x-pentax-pef","image/x-fuji-raf","image/x-panasonic-raw","image/x-sony-sr2","image/x-sony-srf","image/x-sigma-x3f"],K=["image/jpeg","image/png"],q=[...Z];function J(){return`L'image est trop grande pour être traitée. Elle doit faire moins de ${p.maxResolutionInMP} Megapixels et ${p.maxMemoryUsageInMB} Mo`}async function be({source:e}){const{resize:n}=await C(async()=>{const{resize:r}=await import("./DKBeN54O.js");return{resize:r}},[],import.meta.url),t=await createImageBitmap(e).catch(r=>{throw new Error(K.includes(e.type)?O(r):q.includes(e.type)?`Les fichiers ${y(e.type)} ne sont pas encore supportés`:`Le format de fichier ${y(e.type)} n'est pas supporté`)}),{width:a,height:o}=t;if(a*o>p.maxResolutionInMP*1e6)throw new Error(J());const c=document.createElement("canvas");c.width=a,c.height=o,c.getContext("2d")?.drawImage(t,0,0);const m=document.createElement("canvas");return m.width=E,m.height=M(t),n(c,m,{targetWidth:E,targetHeight:M(t),filter:"mks2013"}),new Promise(r=>{m.toBlob(s=>{if(!s)throw new Error("Failed to resize image");s.arrayBuffer().then(f=>r([[a,o],f]))},e.type)})}function Q(e,n=void 0){return(n??_.Image.state).filter(t=>t.fileId===e)}function Ee(e){return U(e.map(n=>n.fileId).filter(n=>n!==null))}function he(e){if(!b(e)&&!b(`${e}_000000`))throw x(e);const[n,t]=e.split("_",2),a=Number.parseInt(t,10);return{fileId:n,subindex:Number.isNaN(a)?null:a}}function ye(e){const n=e.match(/(\d+)(px|%)/);if(!n)throw new Error(`Invalid crop padding: ${e}`);const[t,a]=[Number.parseInt(n[1],10),n[2]];return{withUnit:e,unitless:t,unit:a,inPixels:o=>a==="px"?t:Math.round(o*t/100)}}export{de as a,b,le as c,Ie as d,ue as e,ce as f,Q as g,me as h,ge as i,se as j,Ee as k,p as l,J as m,fe as n,ye as o,he as p,be as r,pe as s};
