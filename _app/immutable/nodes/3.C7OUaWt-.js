import"../chunks/DsnmJJEf.js";import{f as Oe,a as b,p as ke,as as oe,aq as Te,g as e,u as s,H as F,ar as k,ap as S,J as x,G as $,b as Me,D as ee,C as ve,F as fe,I as Ce}from"../chunks/BwdvgNQo.js";import{s as je}from"../chunks/DYy3QkOc.js";import{r as Pe,i as H}from"../chunks/CKH9F0ww.js";import{t as De,f as Ae}from"../chunks/BjiNJ5CV.js";import{a as $e,c as Fe,b as ze,d as Ee,s as _e}from"../chunks/08d27X49.js";import{p as ie}from"../chunks/BzM0mbGE.js";import{t as Re}from"../chunks/Bd7_h5c3.js";import{m as He,p as Le}from"../chunks/Xiow3_xo.js";import{a7 as Be,l as Ve,t as w,v as ge,o as he,a1 as be}from"../chunks/Don2Ydo1.js";import{g as Ke,d as we,e as We}from"../chunks/DfkTl275.js";import{b as qe,i as Ne,A as Ue}from"../chunks/YI6rRCuH.js";import{d as Ge}from"../chunks/iDw1HNQ9.js";import{m as Je}from"../chunks/BxRil6yI.js";import{m as ye,d as Ye,a as Qe}from"../chunks/BhEwWWID.js";import{d as Xe,n as Ze,m as et}from"../chunks/BOvN9V9s.js";import{s as tt}from"../chunks/B2RSv_jY.js";import{u as i}from"../chunks/BPJfxdhi.js";import{t as at}from"../chunks/BYqiwRWy.js";import{s as q}from"../chunks/HTLptRgQ.js";import{e as Ie,i as rt}from"../chunks/CuPIRSst.js";import{w as st}from"../chunks/2OzU4e1W.js";import{D as nt}from"../chunks/DBaFXsNm.js";import{F as ot}from"../chunks/DEX3zmBU.js";import{F as it}from"../chunks/BbsYXVtf.js";import{I as lt}from"../chunks/T09AO1QC.js";import{S as dt}from"../chunks/DE2W_C2B.js";import{B as te}from"../chunks/DgJA6oA6.js";import{C as ct}from"../chunks/BlwUordC.js";import{I as mt}from"../chunks/BWUfZxGx.js";import{K as ut}from"../chunks/C6sIn56-.js";import{L as Se}from"../chunks/72YJCPe-.js";import{M as ft,a as gt}from"../chunks/C2nvjL5G.js";import{g as pt}from"../chunks/DyfjURbU.js";import{a as vt}from"../chunks/CEoeiZ5P.js";import{R as ae}from"../chunks/DWCXZatK.js";var xe=Object.prototype.hasOwnProperty;function pe(m,o){var r,g;if(m===o)return!0;if(m&&o&&(r=m.constructor)===o.constructor){if(r===Date)return m.getTime()===o.getTime();if(r===RegExp)return m.toString()===o.toString();if(r===Array){if((g=m.length)===o.length)for(;g--&&pe(m[g],o[g]););return g===-1}if(!r||typeof m=="object"){g=0;for(r in m)if(xe.call(m,r)&&++g&&!xe.call(o,r)||!(r in o)||!pe(m[r],o[r]))return!1;return Object.keys(o).length===g}}return m!==m&&o!==o}var _t=Oe('<svg><path fill="currentColor" d="M13 19.9a5 5 0 0 0 4-4.9v-3c0-.701-.144-1.378-.415-2h-9.17A5 5 0 0 0 7 12v3a5 5 0 0 0 4 4.9V14h2zm-7.464-2.21A7 7 0 0 1 5 15H2v-2h3v-1c0-.643.087-1.265.249-1.856L3.036 8.866l1-1.732L6.056 8.3a7 7 0 0 1 .199-.3h11.49q.103.148.199.3l2.02-1.166l1 1.732l-2.213 1.278c.162.59.249 1.213.249 1.856v1h3v2h-3a7 7 0 0 1-.536 2.69l2.5 1.444l-1 1.732l-2.526-1.458A6.99 6.99 0 0 1 12 22a6.99 6.99 0 0 1-5.438-2.592l-2.526 1.458l-1-1.732zM8 6a4 4 0 1 1 8 0z"></path></svg>');function ht(m,o){const r=Pe(o,["$$slots","$$events","$$legacy"]);var g=_t();$e(g,()=>({class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...r})),b(m,g)}var bt=Oe('<svg><path fill="currentColor" d="M4 19h16v-7h2v8a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-8h2zm9-10v7h-2V9H6l6-6l6 6z"></path></svg>');function wt(m,o){const r=Pe(o,["$$slots","$$events","$$legacy"]);var g=bt();$e(g,()=>({class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...r})),b(m,g)}var yt=F("<img/>"),It=F('<div class="image svelte-xtkozr"><!></div>'),St=F("<!> <!>",1),xt=F("<!> ",1),Ot=F('<div class="images svelte-xtkozr"></div> <h2 class="svelte-xtkozr"><!></h2> <!>',1),kt=F('<section class="empty-selection svelte-xtkozr"><!> <p> </p></section>'),Mt=F('<section class="empty-selection svelte-xtkozr"><!> <p> </p></section>'),Pt=F('<div class="side-by-side svelte-xtkozr"><!> <!></div>'),$t=F('<aside data-testid="sidepanel"><!> <section class="button svelte-xtkozr"><!> <!> <!> <!></section></aside>');function Ft(m,o){ke(o,!0);const r=s(()=>ze("main")),g=s(()=>{const t=i.currentProtocol;return t?[...t.importedMetadata.filter(a=>!a.sessionwide).map(a=>w.Metadata.getFromState(a.source)),...t.metadata.filter(a=>!t.sessionMetadata.includes(a)).map(a=>w.Metadata.getFromState(a))].filter(a=>a!==void 0).toSorted(He(t)):[]}),j={};let M=Te(!0);st([()=>e(g)],()=>{if(!i.currentProtocol){oe(M,!1);return}if(Object.keys(j).length>0){oe(M,!1);return}const t=[ye(i.currentProtocol.id,null),...i.currentProtocol.importedMetadata.filter(({sessionwide:a})=>!a).map(({source:a})=>{const{namespace:l,id:d}=Be(a);return ye(l,d)})];Promise.all(t.map(a=>Ve("MetadataOption",a))).then(a=>{if(Object.keys(j).length>0){oe(M,!1);return}for(const{metadataId:l,key:d,...u}of a.flat()){j[l]??=new Map;const c=d.toString();j[l].set(c,{key:c,...u})}oe(M,!1)})});const re=s(()=>vt().showTechnicalMetadata),y=s(()=>i.selection.length===1?w.Observation.state.find(t=>t.id===i.selection[0]):void 0),N=s(()=>i.selection.length===1?w.Image.state.find(t=>[t.id,t.fileId].includes(i.selection[0])):void 0),z=s(()=>({image:i.selection.filter(t=>w.Image.state.some(a=>[a.id,a.fileId].includes(t))).length,observation:i.selection.filter(t=>w.Observation.state.some(a=>a.id===t)).length,get all(){return this.image+this.observation}}));function le(t,a){const l=(d,u)=>u?Math.round(d*u):d;return[l(t.width,a?.width),l(t.height,a?.height)]}var V=$t();let D;var U=k(V);{var G=t=>{var a=Ot(),l=ee(a);Ie(l,21,()=>o.images,rt,(v,_,h)=>{let R=()=>e(_).src,C=()=>e(_).box,O=()=>e(_).dimensions;const K=s(()=>e(y)?`Image ${h+1} de l'observation ${e(y).label}`:`Image ${h+1} de la sélection`);var B=It();let ne;var me=k(B);{var Z=P=>{ct(P,{blurfill:!0,get src(){return R()},get alt(){return e(K)},get box(){return C()},get dimensions(){return O()}})},ue=P=>{var W=yt();$(()=>{_e(W,"src",R()),_e(W,"alt",e(K))}),b(P,W)};H(me,P=>{C()?P(Z):P(ue,!1)})}x(B),$(P=>ne=Ee(B,"",ne,P),[()=>({"aspect-ratio":le(O(),C()).join(" / ")})]),b(v,B)}),x(l);var d=S(l,2),u=k(d);{var c=v=>{var _=St(),h=ee(_);ht(h,{});var R=S(h,2);{let C=s(()=>e(r)(125));mt(R,{get label(){return e(C)},get value(){return e(y).label},onblur:async O=>{O!==e(y).label&&await w.Observation.update(e(y).id,"label",O)}})}b(v,_)},E=v=>{var _=xt(),h=ee(_);lt(h,{});var R=S(h);$(()=>q(R,` ${e(N).filename??""}`)),b(v,_)},I=v=>{var _=fe();$(h=>q(_,h),[()=>ge(e(z).all,e(r).p(325),e(r)._.p)]),b(v,_)},Y=v=>{var _=fe();$(h=>q(_,h),[()=>ge(e(z).image,e(r).p(326),e(r)._.p)]),b(v,_)},Q=v=>{var _=fe();$(h=>q(_,h),[()=>ge(e(z).observation,e(r).p(327),e(r)._.p)]),b(v,_)};H(u,v=>{e(y)?v(c):e(N)?v(E,1):e(z).image>0&&e(z).observation>0?v(I,2):e(z).image>0?v(Y,3):e(z).observation>0&&v(Q,4)})}x(d);var X=S(d,2);ft(X,{testid:"sidepanel-metadata",children:(v,_)=>{var h=ve(),R=ee(h);Ie(R,17,()=>e(g),C=>C.id,(C,O)=>{const K=s(()=>o.metadata[e(O).id]);var B=ve(),ne=ee(B);{var me=Z=>{{let ue=s(()=>e(K)?.merged),P=s(()=>[...(j[e(O).id]??new Map).values()]);gt(Z,{get merged(){return e(ue)},get definition(){return e(O)},get value(){return e(K)},get options(){return e(P)},onchange:async W=>{pe(W,e(K)?.value)||o.onmetadatachange(e(O).id,W)}})}};H(ne,Z=>{(e(O).label||e(re))&&Z(me)})}b(C,B)}),b(v,h)}}),b(t,a)},de=t=>{var a=kt(),l=k(a);Se(l,{variant:"empty"});var d=S(l,2),u=k(d,!0);x(d),x(a),$(c=>q(u,c),[()=>e(r)(53)]),b(t,a)},ce=t=>{var a=Mt(),l=k(a);Se(l,{variant:"empty"});var d=S(l,2),u=k(d,!0);x(d),x(a),$(c=>q(u,c),[()=>e(r)(161)]),b(t,a)};H(U,t=>{o.images.length>0&&!e(M)?t(G):e(M)?t(de,1):t(ce,!1)})}var se=S(U,2),n=k(se);{var p=t=>{var a=Pt(),l=k(a);{const u=I=>{dt(I,{})};let c=s(()=>!o.canmerge),E=s(()=>e(r)(143));te(l,{get disabled(){return e(c)},get onclick(){return o.onmerge},keyboard:"$mod+g",get help(){return e(E)},_w_snippet_0:u,children:(I,Y)=>{{let Q=s(()=>[u]),X=s(()=>e(r).c(10));ae(I,{get t(){return e(Q)},get x(){return e(X)}})}},$$slots:{_w_snippet_0:!0,default:!0}})}var d=S(l,2);{const u=I=>{it(I,{})};let c=s(()=>!o.cansplit),E=s(()=>e(r)(162));te(d,{get disabled(){return e(c)},get onclick(){return o.onsplit},keyboard:"$mod+Shift+g",get help(){return e(E)},_w_snippet_1:u,children:(I,Y)=>{{let Q=s(()=>[u]),X=s(()=>e(r).c(17));ae(I,{get t(){return e(Q)},get x(){return e(X)}})}},$$slots:{_w_snippet_1:!0,default:!0}})}x(a),b(t,a)};H(n,t=>{o.onmerge&&o.onsplit&&t(p)})}var f=S(n,2);{var A=t=>{{const a=l=>{wt(l,{})};te(t,{get onclick(){return o.onimport},_w_snippet_2:a,children:(l,d)=>{{let u=s(()=>[a]),c=s(()=>e(r).c(6));ae(l,{get t(){return e(u)},get x(){return e(c)}})}},$$slots:{_w_snippet_2:!0,default:!0}})}};H(f,t=>{o.onimport&&t(A)})}var L=S(f,2);{var J=t=>{{const a=c=>{ot(c,{})},l=c=>{ut(c,{shortcut:"$mod+Enter"})};let d=s(()=>!e(y)),u=s(()=>e(y)?"":"Sélectionnez une seule observation");te(t,{get disabled(){return e(d)},loading:!0,get help(){return e(u)},onclick:async()=>{e(y)&&await pt("/(app)/(sidepanel)/classify/[observation]",{observation:e(y).id})},_w_snippet_3:a,_w_snippet_4:l,children:(c,E)=>{{let I=s(()=>[a,l]),Y=s(()=>e(r).c(425));ae(c,{get t(){return e(I)},get x(){return e(Y)}})}},$$slots:{_w_snippet_3:!0,_w_snippet_4:!0,default:!0}})}};H(L,t=>{ie.route.id==="/(app)/(sidepanel)/classify"&&t(J)})}var T=S(L,2);{const t=d=>{nt(d,{})};let a=s(()=>o.images.length===0),l=s(()=>e(r)(157));te(T,{get disabled(){return e(a)},get onclick(){return o.ondelete},keyboard:"Delete",get help(){return e(l)},danger:!0,_w_snippet_5:t,children:(d,u)=>{{let c=s(()=>[t]),E=s(()=>e(r).c(16)),I=s(()=>[o.images.length]);ae(d,{get t(){return e(c)},get x(){return e(E)},get a(){return e(I)}})}},$$slots:{_w_snippet_5:!0,default:!0}})}x(se),x(V),$(()=>D=Fe(V,1,"sidepanel svelte-xtkozr",null,D,{empty:o.images.length===0||e(M)})),b(m,V),Me()}var zt=F('<div><main data-testid="app-main" class="svelte-di4wkt"><!></main> <!></div>');function ga(m,o){ke(o,!0);const r=s(()=>ze("main"));tt({title:e(r)(103)});async function g(){Ne(await Le({accept:Ue,multiple:!0}))}async function j(){const n=await et(i.selection);i.setSelection?.([n])}async function M(){const n=[],p=i.currentProtocol;if(!p)throw new Error("No protocol selected");await he(["Image","Observation"],{mode:"readwrite"},async f=>{if(!i.currentSession)throw new Error("No session selected, cannot split observations");for(const A of i.selection){const L=w.Observation.getFromState(A);if(L){f.objectStore("Observation").delete(A);for(const J of L.images){const T=await f.objectStore("Image").get(J);if(!T)continue;const t=Ze(T,p,i.currentSession);f.objectStore("Observation").add(t),n.push(t.id)}}}}),i.setSelection?.(n)}async function re(){await he(["Image","Observation","ImageFile","ImagePreviewFile"],{},async n=>{for(const p of i.selection)qe(p,"Cancelled by user"),await Xe(p,{tx:n,notFoundOk:!0,recursive:!0}),await we(p,n,!0),await we(We(p),n,!0)}),i.setSelection?.([])}Ge("observations",{"x x":{help:e(r)(189),debug:!0,do(){for(const n of i.selection)i.erroredImages.has(n)||i.erroredImages.set(n,"Errored!")}},"x u":{help:e(r)(190),debug:!0,do(){for(const n of i.selection)i.erroredImages.delete(n)}},"x f":{help:e(r)(191),debug:!0,do(){i.processing.files.push({id:Ke(),name:"Debug image.jpeg",addedAt:new Date})}},"$mod+g":{help:e(r)(95),do:j},"$mod+Shift+g":{help:e(r)(162),do:M},Delete:{help:e(r)(155),do:re}});let y=s(()=>i.processing.files.length+w.Observation.state.length+w.Image.state.length>0);const N=s(()=>i.selection.flatMap(n=>{const p=w.Image.state.find(f=>[f.fileId,f.id].includes(n));return p?[p]:w.Observation.state.find(f=>f.id===n)?.images.map(f=>w.Image.state.find(A=>A.id===f)).filter(f=>f!==void 0)}).filter(n=>n!==void 0)),z=s(()=>i.selection.map(n=>w.Observation.state.find(p=>p.id===n)).filter(n=>n!==void 0)),le=s(()=>e(N).map(n=>{if(!n.fileId)return;const p=i.getPreviewURL(n.fileId);if(!p)return;const f=i.cropMetadataValueOf(n)?.value;return{src:p,id:n.id,dimensions:n.dimensions,box:f?Re(f):void 0}}).filter(n=>n!==void 0));let V=s(()=>{if(!i.currentProtocol)return{};try{return Je({definitions:w.Metadata.state,images:e(N),observations:e(z)})}catch(n){return console.error(n),at.error(n),{}}});var D=zt();let U;var G=k(D),de=k(G);je(de,()=>o.children??Ce),x(G);var ce=S(G,2);{var se=n=>{{let p=s(()=>i.selection.length>0),f=s(()=>ie.route.id?.endsWith("classify")?j:void 0),A=s(()=>i.selection.some(T=>w.Observation.state.some(t=>t.id===T))),L=s(()=>ie.route.id?.endsWith("classify")?M:void 0),J=s(()=>ie.route.id?.endsWith("import")?g:void 0);Ft(n,{get images(){return e(le)},get metadata(){return e(V)},get canmerge(){return e(p)},get onmerge(){return e(f)},get cansplit(){return e(A)},get onsplit(){return e(L)},get onimport(){return e(J)},ondelete:re,onmetadatachange:async(T,t)=>{if(i.currentProtocol)for(const a of i.selection)t===void 0?await Ye({db:be(),sessionId:i.currentSession?.id,subjectId:a,metadataId:T,recursive:!0}):await Qe({db:be(),sessionId:i.currentSession?.id,subjectId:a,metadataId:T,confidence:1,manuallyModified:!0,value:t})}})}};H(ce,n=>{e(y)&&n(se)})}x(D),$(()=>U=Fe(D,1,"main-and-sidepanel svelte-di4wkt",null,U,{"has-sidepanel":e(y)})),De(1,D,()=>Ae,()=>({duration:100})),b(m,D),Me()}export{ga as component};
