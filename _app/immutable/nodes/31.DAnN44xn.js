import{e as at}from"../chunks/ft-thZGf.js";import{ae as gt,t as P,af as _t,ag as ht,A as wt,s as yt,I as Mt,d as C,b as xt,c as bt,l as St,p as st,a1 as $,v as rt}from"../chunks/Don2Ydo1.js";import{t as ct}from"../chunks/BYqiwRWy.js";import{b as H,a as ut,m as It,d as Pt}from"../chunks/BhEwWWID.js";import{g as kt}from"../chunks/BeqcFVE5.js";import"../chunks/DsnmJJEf.js";import{p as mt,I as Ot,g as o,u as h,b as ft,H as k,ap as x,ar as p,a as g,G as I,J as _,F as K,D as tt,as as jt,at as ot,aK as At,C as Dt}from"../chunks/BwdvgNQo.js";import{s as T,e as it}from"../chunks/HTLptRgQ.js";import{p as Tt,i as z,s as Bt}from"../chunks/CKH9F0ww.js";import{e as Ct}from"../chunks/CuPIRSst.js";import{t as Rt,f as Lt}from"../chunks/BjiNJ5CV.js";import{a as Vt,C as zt,b as vt,e as Et}from"../chunks/08d27X49.js";import{i as q}from"../chunks/BDV6zAFm.js";import{B as Ft}from"../chunks/CayOuDVJ.js";import{B as Ut}from"../chunks/DgJA6oA6.js";import{F as Z}from"../chunks/CfpiF-ni.js";import{I as Ht}from"../chunks/BWUfZxGx.js";import{a as qt,t as Gt}from"../chunks/C6sIn56-.js";import{A as Kt}from"../chunks/Cyizp9nt.js";import{C as Jt}from"../chunks/DZRaQp3m.js";import{E as Nt}from"../chunks/CUbNYyyV.js";import{B as Qt}from"../chunks/Bga-pN0V.js";import{D as Wt}from"../chunks/Bsw8Srli.js";import{g as G}from"../chunks/DyfjURbU.js";import{M as Xt,a as Yt}from"../chunks/C2nvjL5G.js";import{M as Zt}from"../chunks/9Mu7JFJd.js";import{e as $t,s as nt}from"../chunks/YI6rRCuH.js";import{R as te}from"../chunks/DWCXZatK.js";async function pt({db:r,sessionId:t,metadataToConsider:e,iterations:s=e.length}){if(s<=0)return;const i=await r.get("Session",t).then(a=>gt.Session.assert(a)),b=await P.Metadata.getMany(e).then(a=>a.filter(d=>d.default!==void 0)),S=_t(i.metadata),u={protocolMetadata:{},metadata:{},session:{createdAt:i.createdAt,metadata:S,protocolMetadata:ht(S,(a,d)=>{if(yt(i.protocol,a))return[Mt(a),d]})}},M=new Set;for(const{default:a,id:d,type:O}of b){if(a===void 0||a===null)continue;const w=kt(i,O,d);if(w&&!w.isDefault)continue;const m=typeof a=="object"&&"render"in a?a.render(u):a;if(m instanceof wt){ct.warn(`La valeur par défaut de la métadonnée ${d} est invalide : ${m.toString()}`);continue}console.debug("resolved default for",d,{defaultSpec:a,value:m,currentValue:w,serializeds:{new:H(m),current:H(w?.value)}}),H(m)!==H(w?.value)&&(await ut({db:r,sessionId:t,metadataId:d,subjectId:t,type:O,isDefault:!0,value:m}),M.add(d))}await pt({db:r,sessionId:t,metadataToConsider:[...M],iterations:s-1})}async function ee({params:{id:r},depends:t}){t(C("Session",r));let e=await P.Session.get(r);const s=xt("js");e||at(404,s(512)),t(C("Protocol",e.protocol));const i=await P.Protocol.get(e.protocol);if(!i)return{session:e,protocol:null,sessionMetadata:[],sessionMetadataOptions:{},counts:{observations:0,images:0}};const b=await P.Metadata.getMany([...i.sessionMetadata,...i.importedMetadata.filter(a=>a.sessionwide).map(a=>a.source)]);b.forEach(({id:a})=>t(C("Metadata",a))),b.sort(bt(({id:a})=>i.metadataOrder?.indexOf(a)??-1));const S=await Promise.all(b.map(async a=>[a.id,a.type==="enum"?await St("MetadataOption",It(i.id,a.id)):[]])).then(a=>Object.fromEntries(a)),u={observations:await st("Observation","sessionId",e.id).then(a=>a.length),images:await st("Image","sessionId",e.id).then(a=>a.length)};await pt({db:$(),sessionId:e.id,metadataToConsider:b.map(({id:a})=>a)}),e=await P.Session.get(r),e||at(404,s(512));const M=b.map(a=>({def:a,value:e.metadata?.[a.id]}));return{session:e,protocol:i,sessionMetadata:M,sessionMetadataOptions:S,counts:u}}const Ue=Object.freeze(Object.defineProperty({__proto__:null,load:ee},Symbol.toStringTag,{value:"Module"}));var lt=Object.prototype.hasOwnProperty;function dt(r,t,e){for(e of r.keys())if(E(e,t))return e}function E(r,t){var e,s,i;if(r===t)return!0;if(r&&t&&(e=r.constructor)===t.constructor){if(e===Date)return r.getTime()===t.getTime();if(e===RegExp)return r.toString()===t.toString();if(e===Array){if((s=r.length)===t.length)for(;s--&&E(r[s],t[s]););return s===-1}if(e===Set){if(r.size!==t.size)return!1;for(s of r)if(i=s,i&&typeof i=="object"&&(i=dt(t,i),!i)||!t.has(i))return!1;return!0}if(e===Map){if(r.size!==t.size)return!1;for(s of r)if(i=s[0],i&&typeof i=="object"&&(i=dt(t,i),!i)||!E(s[1],t.get(i)))return!1;return!0}if(e===ArrayBuffer)r=new Uint8Array(r),t=new Uint8Array(t);else if(e===DataView){if((s=r.byteLength)===t.byteLength)for(;s--&&r.getInt8(s)===t.getInt8(s););return s===-1}if(ArrayBuffer.isView(r)){if((s=r.byteLength)===t.byteLength)for(;s--&&r[s]===t[s];);return s===-1}if(!e||typeof r=="object"){s=0;for(e in r)if(lt.call(r,e)&&++s&&!lt.call(t,e)||!(e in t)||!E(r[e],t[e]))return!1;return Object.keys(t).length===s}}return r!==r&&t!==t}var ae=k("<button><!> <!></button>"),se=k('<code class="svelte-ngwarr"> </code>'),re=k("<!> <!>",1),oe=k('<div class="item svelte-ngwarr"><div class="label svelte-ngwarr"><div class="icon svelte-ngwarr"><!></div> </div> <div class="version svelte-ngwarr"><!></div></div>');function ie(r,t){mt(t,!0);const e=h(()=>vt("main"));let s=Tt(t,"value",15);{const i=(u,M=Ot)=>{var a=ae();Vt(a,v=>({"aria-label":v,class:"trigger",...M(),[zt]:{"none-selected":!s()}}),[()=>o(e)(419)],void 0,void 0,"svelte-ngwarr");var d=p(a);{var O=v=>{var j=K();I(B=>T(j,B),[()=>P.Protocol.getFromState(s())?.name]),g(v,j)},w=v=>{var j=K();I(B=>T(j,B),[()=>o(e)(34)]),g(v,j)};z(d,v=>{s()?v(O):v(w,!1)})}var m=x(d,2);Nt(m,{}),_(a),g(u,a)},b=(u,M,a)=>{let d=()=>M?.().protocol,O=()=>a?.().label;var w=oe(),m=p(w),v=p(m),j=p(v);{var B=n=>{Jt(n,{})},J=n=>{Kt(n,{})};z(j,n=>{s()===d()?.id?n(B):d()||n(J,1)})}_(v);var N=x(v);_(m);var R=x(m,2),Q=p(R);{var l=n=>{var f=re(),c=tt(f);{var y=D=>{var L=se(),F=p(L);_(L),qt(L,(W,V)=>Gt?.(W,V),()=>"Version du protocole"),I(()=>T(F,`v${d().version??""}`)),g(D,L)};z(c,D=>{d().version&&D(y)})}var A=x(c,2);Qt(A,Bt({compact:!0},d)),g(n,f)};z(Q,n=>{d()&&n(l)})}_(R),_(w),I(()=>T(N,` ${O()??""}`)),g(u,w)};let S=h(()=>[{label:"Choisir un protocole",items:P.Protocol.state.map(u=>({type:"selectable",data:{protocol:u},key:u.id,label:u.name,selected:s()===u.id,async onclick(){s(u.id),await t.onchange?.(s())}}))},{items:[{type:"clickable",data:{protocol:null},label:"Gérer les protocoles",async onclick(){await G("/protocols")}}]}]);Wt(r,{get testid(){return t.testid},get items(){return o(S)},trigger:i,item:b,$$slots:{trigger:!0,item:!0}})}ft()}var ne=k("<textarea></textarea>"),le=k('<code class="svelte-1xkdn1f"> </code>'),de=k('<section class="error svelte-1xkdn1f"><!></section>'),ce=k('<h2> </h2> <form class="metadata svelte-1xkdn1f" data-testid="session-metadata"><!></form>',1),ue=k("<code> </code>"),me=k('<main class="svelte-1xkdn1f"><h1 class="svelte-1xkdn1f"><!> <section class="actions svelte-1xkdn1f"><!> <!></section></h1> <form class="svelte-1xkdn1f"><!> <!></form> <!> <!> <!></main>');function He(r,t){mt(t,!0);const e=h(()=>vt("main"));let s=h(()=>t.data.sessionMetadata),i=h(()=>t.data.session),b=h(()=>o(i).protocol),S=h(()=>o(i).name);var u=me(),M=p(u),a=p(M);{let l=h(()=>o(e)(378));Ht(a,{discreet:!0,get label(){return o(l)},get value(){return o(S)},placeholder:"",onblur:async n=>{n!==o(S)&&(await P.Session.update(t.data.session.id,"name",n),jt(S,n),q(C("Session",t.data.session.id)))}})}var d=x(a,2),O=p(d);{let l=h(()=>[rt(t.data.counts.images,o(e).p(388),o(e)._.p),rt(t.data.counts.observations,o(e).p(389),o(e)._.p)]);Zt(O,{key:"modal_delete_session",get typeToConfirm(){return o(S)},get consequences(){return o(l)},onconfirm:async()=>{await $t(t.data.session.id),ct.success(o(e)(379)),await G("/sessions")}})}var w=x(O,2);Ut(w,{onclick:async()=>{await nt(t.data.session.id),await G("/import")},children:(l,n)=>{ot();var f=K();I(c=>T(f,c),[()=>o(e)(380)]),g(l,f)},$$slots:{default:!0}}),_(d),_(M);var m=x(M,2),v=p(m);{let l=h(()=>o(e)(260));Z(v,{get label(){return o(l)},children:(n,f)=>{var c=ne();At(c),I(()=>Et(c,t.data.session.description)),it("blur",c,async({target:y})=>{y instanceof HTMLTextAreaElement&&(await P.Session.update(t.data.session.id,"description",y.value),q(C("Session",t.data.session.id)))}),g(n,c)},$$slots:{default:!0}})}var j=x(v,2);{let l=h(()=>o(e)(381));Z(j,{composite:!0,get label(){return o(l)},children:(n,f)=>{ie(n,{testid:"protocol",get value(){return o(b)},onchange:async c=>{await P.Session.update(t.data.session.id,"protocol",c),q(C("Session",t.data.session.id))}})},$$slots:{default:!0}})}_(m);var B=x(m,2);{var J=l=>{var n=de();{const c=y=>{var A=le(),D=p(A,!0);_(A),I(()=>T(D,t.data.session.protocol)),g(y,A)};var f=p(n);{let y=h(()=>[c]),A=h(()=>o(e).c(390));te(f,{get t(){return o(y)},get x(){return o(A)}})}_(n)}g(l,n)},N=l=>{var n=ce(),f=tt(n),c=p(f,!0);_(f);var y=x(f,2),A=p(y);Xt(A,{children:(D,L)=>{var F=Dt(),W=tt(F);Ct(W,17,()=>o(s),({def:V,value:X})=>V.id,(V,X)=>{let U=()=>o(X).def,et=()=>o(X).value;Yt(V,{get options(){return t.data.sessionMetadataOptions[U().id]},get definition(){return U()},get value(){return et()},onchange:async Y=>{E(Y,et()?.value)||(Y!==void 0?await ut({db:$(),manuallyModified:!0,subjectId:t.data.session.id,metadataId:U().id,value:Y}):await Pt({db:$(),subjectId:t.data.session.id,metadataId:U().id}),q(C("Session",t.data.session.id)))}})}),g(D,F)}}),_(y),I(D=>T(c,D),[()=>o(e)(382)]),g(l,n)};z(B,l=>{t.data.protocol?o(s).length>0&&l(N,1):l(J)})}var R=x(B,2);Ft(R,{loading:!0,onclick:async()=>{await nt(t.data.session.id),await G("/import")},children:(l,n)=>{ot();var f=K();I(c=>T(f,c),[()=>o(e)(372)]),g(l,f)},$$slots:{default:!0}});var Q=x(R,2);{let l=h(()=>o(e)(383));Z(Q,{get label(){return o(l)},children:(n,f)=>{var c=ue(),y=p(c,!0);_(c),I(()=>T(y,t.data.session.id)),g(n,c)},$$slots:{default:!0}})}_(u),it("submit",m,l=>{l.preventDefault()}),Rt(1,u,()=>Lt,()=>({duration:100})),g(r,u),ft()}export{He as component,Ue as universal};
