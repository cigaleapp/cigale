import"../chunks/DsnmJJEf.js";import{p as ne,g as a,u as C,ao as Q,aq as R,C as W,D as j,a as v,b as le,as as y,H as D,ar as l,ap as h,J as n,G as L,at as de,F as me}from"../chunks/BwdvgNQo.js";import{s as T}from"../chunks/HTLptRgQ.js";import{i as V}from"../chunks/CKH9F0ww.js";import{c as ce}from"../chunks/CxwMZO45.js";import{t as X,f as Y}from"../chunks/BjiNJ5CV.js";import{b as fe,c as pe,s as ve}from"../chunks/08d27X49.js";import{w as ue}from"../chunks/2OzU4e1W.js";import{A as ge}from"../chunks/BgBcKoa6.js";import{B as _e}from"../chunks/DgJA6oA6.js";import{C as be}from"../chunks/Dqw32fY-.js";import{C as Ie}from"../chunks/Cmm9BnbL.js";import{c as Z,a as ye,b as he}from"../chunks/YI6rRCuH.js";import{t as p,q as Ce,a as $}from"../chunks/Don2Ydo1.js";import{a as we,b as Ae,c as Se,d as xe,e as Me}from"../chunks/DfkTl275.js";import{l as Oe}from"../chunks/Bd7_h5c3.js";import{d as Fe}from"../chunks/iDw1HNQ9.js";import{L as ee}from"../chunks/72YJCPe-.js";import{e as Pe,o as ke,d as ze}from"../chunks/BOvN9V9s.js";import{g as N}from"../chunks/DyfjURbU.js";import{P as Le}from"../chunks/BRQ5Qhft.js";import{s as Ee}from"../chunks/B2RSv_jY.js";import{u as s}from"../chunks/BPJfxdhi.js";import{t as U}from"../chunks/BYqiwRWy.js";const Be=G=>{var w=W(),r=j(w);{var g=d=>{const A=C(()=>{const{model:M}=s.classificationModels[s.selectedClassificationModel];return{model:M}}),S=C(()=>new URL(typeof a(A).model=="string"?a(A).model:a(A).model?.url));var m=qe(),c=l(m),x=l(c,!0);n(c),n(m),L((M,E)=>{ve(m,"href",M),T(x,E)},[()=>a(S).toString(),()=>a(S).pathname.split("/").at(-1)]),v(d,m)};V(r,d=>{s.classificationInferenceAvailable&&d(g)})}v(G,w)};var qe=D('<a target="_blank"><code> </code></a>'),Re=D('<section class="loading svelte-1o687fz"><!> <p> </p> <p class="source svelte-1o687fz"><!></p> <div class="progressbar svelte-1o687fz"><!></div></section>'),Te=D('<div class="empty svelte-1o687fz"><svelte-css-wrapper style="display: contents"><!></svelte-css-wrapper> <p> </p> <!></div>'),Ve=D("<section><!> <!></section>");function ma(G,w){ne(w,!0);const r=C(()=>fe("main"));Ee({title:a(r)(60)});const g=C(()=>p.Observation.state.map(e=>({id:e.id,sessionId:e.sessionId,addedAt:e.addedAt,name:e.label,metadata:ke({definitions:p.Metadata.state,images:e.images.map(t=>p.Image.getFromState(t)).filter($),observation:e}),virtual:!1,data:{image:void 0,observation:e,images:e.images.map(t=>p.Image.getFromState(t)).filter($)}})));let d=R("");const A=C(()=>[a(d),a(g).find(e=>e.id===a(d))?.data.images.map(e=>({id:e.id,name:e.filename,addedAt:e.addedAt,sessionId:e.sessionId,metadata:e.metadata,virtual:!1,data:{image:e,observation:void 0,images:[e]}}))??[]]);let S=R(0),m=new AbortController,c=R(!1),x=R(void 0);async function M(){if(a(c)||!s.currentProtocol||!s.classificationInferenceAvailable)return;const e=ye(s.currentProtocol,s.selectedClassificationModel);if(!e){U.error(a(r)(33,[s.selectedClassificationModel,s.currentProtocol.name]));return}m.abort(),y(x,void 0),m=new AbortController,await Oe(w.data.swarpc,"classification",{abortSignal:m.signal,protocolId:s.currentProtocol.id,requests:{model:e.model,classmapping:e.classmapping},onProgress(t){y(S,t,!0)}})}Q(()=>{if(!s.classificationInferenceAvailable||!a(c)||a(x))return;const e=p.Image.state.filter(t=>we(t)&&!Ae(t)&&!s.loadingImages.has(t.id)&&s.cropMetadataValueOf(t));Z(e.map(t=>t.id))}),ue(()=>s.selectedClassificationModel,()=>{y(c,!1),M().catch(e=>{y(x,e,!0),!Ce(e)&&(console.error(e),U.error(a(r)(89)))}).then(()=>{y(c,!0)})}),Q(()=>{s.setSelection&&Pe()}),Fe("classification",{"$mod+Enter":{help:a(r)(426),when:()=>s.selection.length===1&&p.Observation.getFromState(s.selection[0]),async do(){let e=s.selection.at(0);e&&await N("/(app)/(sidepanel)/classify/[observation]",{observation:e})}}});var E=W(),ae=j(E);{var te=e=>{var t=Re(),O=l(t);ee(O,{loading:!0});var _=h(O,2),H=l(_,!0);n(_);var F=h(_,2),b=l(F);Be(b),n(F);var f=h(F,2),i=l(f);Le(i,{percentage:!0,alwaysActive:!0,get progress(){return a(S)}}),n(f),n(t),L(u=>T(H,u),[()=>a(r)(54)]),X(1,t,()=>Y,()=>({duration:100})),v(e,t)},se=e=>{var t=Ve();let O;var _=l(t);ge(_,{get items(){return a(g)},get unroll(){return a(A)},zone:"classify",item:(f,i,u)=>{let P=()=>i?.().observation,B=()=>i?.().image,k=()=>i?.().images,o=()=>u?.().id;var z=W(),J=j(z);{var re=I=>{{let ie=C(()=>a(r)(29));Ie(I,{get observation(){return P()},get images(){return k()},boxes:"apply-first",get loadingStatusText(){return a(ie)},onstacksizeclick:()=>{y(d,a(d)===o()?"":o(),!0)},ondoubleclick:()=>{N("/(app)/(sidepanel)/classify/[observation]",{observation:P().id})},onretry:()=>{s.erroredImages.delete(o());const q=p.Observation.getFromState(o())?.images;q?(q.forEach(K=>s.erroredImages.delete(K)),Z(q)):U.error(a(r)(193,[o()]))},ondelete:async()=>{(p.Observation.getFromState(o())?.images??[o()]).forEach(K=>he(K,"Cancelled by user")),Se(o())&&await xe(Me(o())),await ze(o(),{notFoundOk:!0,recursive:!0})}})}},oe=I=>{be(I,{get image(){return B()},boxes:"apply-first"})};V(J,I=>{P()?I(re):B()&&I(oe,1)})}v(f,z)},$$slots:{item:!0}});var H=h(_,2);{var F=b=>{var f=Te(),i=l(f);ce(i,()=>({"--size":"6em"})),ee(i.lastChild,{variant:"empty"}),n(i);var u=h(i,2),P=l(u,!0);n(u);var B=h(u,2);_e(B,{onclick:()=>N("/import"),children:(k,o)=>{de();var z=me();L(J=>T(z,J),[()=>a(r)(103)]),v(k,z)},$$slots:{default:!0}}),n(f),L(k=>T(P,k),[()=>a(r)(37)]),v(b,f)};V(H,b=>{a(g).length||b(F)})}n(t),L(()=>O=pe(t,1,"observations svelte-1o687fz",null,O,{empty:!a(g).length})),X(1,t,()=>Y,()=>({duration:100})),v(e,t)};V(ae,e=>{a(c)?e(se,!1):e(te)})}v(G,E),le()}export{ma as component};
