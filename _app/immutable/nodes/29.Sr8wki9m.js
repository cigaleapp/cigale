import"../chunks/DsnmJJEf.js";import{f as Te,a as $,p as Le,ao as K,g as e,u as i,as as f,aq as C,aR as Be,H as N,G as M,b as Ce,ap as x,ar as m,I as D,C as Q,D as X,at as Y,F as ee,J as v,aI as Me}from"../chunks/BwdvgNQo.js";import{s as y}from"../chunks/HTLptRgQ.js";import{r as Ze,i as te}from"../chunks/CKH9F0ww.js";import{a as ve,t as fe}from"../chunks/C6sIn56-.js";import{a as De,c as Ee,b as Ne,d as Ue}from"../chunks/08d27X49.js";import{w as we}from"../chunks/2OzU4e1W.js";import{F as Ve}from"../chunks/0FVT5fxA.js";import{a as Ae}from"../chunks/BRmTdaxr.js";import{p as He}from"../chunks/BzM0mbGE.js";import{B as ge}from"../chunks/DgJA6oA6.js";import{d as je}from"../chunks/Xiow3_xo.js";import{g as Ge}from"../chunks/7XoH3LsZ.js";import{a4 as S,C as Oe}from"../chunks/Don2Ydo1.js";import{p as Z}from"../chunks/DfkTl275.js";import{I as We}from"../chunks/BWUfZxGx.js";import{L as _e}from"../chunks/DkW1Bdbi.js";import{L as E,a as re}from"../chunks/BwliMRya.js";import{e as he}from"../chunks/BOvN9V9s.js";import{R as qe}from"../chunks/DoUkWLbC.js";import{S as Je}from"../chunks/BW1llP4t.js";import{u as w}from"../chunks/BPJfxdhi.js";import{t as R}from"../chunks/BYqiwRWy.js";import{Z as Ke}from"../chunks/5NMmPB3q.js";import{R as se}from"../chunks/DWCXZatK.js";var Qe=Te('<svg><path fill="currentColor" d="M12.414 5H21a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h7.414zM4 5v14h16V7h-8.414l-2-2zm9 8h3l-4 4l-4-4h3V9h2z"></path></svg>');function Xe(F,I){const b=Ze(I,["$$slots","$$events","$$legacy"]);var g=Qe();De(g,()=>({class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em",...b})),$(F,g)}async function Ye(F,I,b){const[g,..._]=I.split("/").filter(Boolean).toReversed();let d=F;for(const u of _.toReversed())d=await d.getDirectoryHandle(u,{create:!0});const k=await d.getFileHandle(g,{create:!0}).then(u=>u.createWritable());await k.write(b),await k.close()}var et=N('<code class="size svelte-1t5c71w"><!></code>'),tt=N('<code class="size svelte-1t5c71w"><!></code>'),rt=N('<div class="numeric svelte-1t5c71w"><!> </div>'),st=N('<main class="svelte-1t5c71w"><header class="svelte-1t5c71w"><h1> </h1> <div class="actions svelte-1t5c71w"><!> <!></div></header> <div class="side-by-side svelte-1t5c71w"><section class="settings svelte-1t5c71w"><div class="include svelte-1t5c71w"><!></div> <div><div class="label svelte-1t5c71w"> </div> <!> <p class="fineprint svelte-1t5c71w"> </p></div></section> <section class="preview" data-testid="zip-preview"><h2> </h2> <div class="tree loading"><!></div></section></div></main>');function Rt(F,I){Le(I,!0);const b=i(()=>I.data.swarpc);let g=C(!1),_=C("croppedonly"),d=i(()=>Z(w.currentProtocol?.crop?.padding??"0px")),k=i(()=>e(d).unitless===0?"none":e(d).unit==="px"?"customPixels":e(d).unitless===5?"small":e(d).unitless===10?"medium":"customPercent");K(()=>{switch(e(k)){case"none":f(d,Z("0px"));break;case"small":f(d,Z("5%"));break;case"medium":f(d,Z("10%"));break}}),K(()=>{!e(g)&&w.processing.task==="export"&&w.processing.reset()});const u=i(()=>Ne("main"));async function ae(o){await R.clear("exporter"),w.processing.reset();const n=o?"folder":"zip";if(f(g,n,!0),!w.currentSessionId){R.error(e(u)(405)),f(g,!1);return}try{await he(),w.processing.task="export",w.processing.total=1,w.processing.done=0;const a=await e(b).generateResultsExport.once({include:e(_),format:n,sessionId:w.currentSessionId,cropPadding:e(d).withUnit,jsonSchemaURL:new URL(Ae("/results.schema.json"),He.url.origin).toString()},async({event:s,data:t})=>{switch(s){case"progress":w.processing.done=t;break;case"writeFile":{if(!o)return;await Ye(o,t.filepath,t.contents);break}case"warning":{const[r,{filename:p}]=t;switch(r){case"exif-write-error":R.warn(e(u)(359,[p]));break}break}}});n==="folder"&&o&&R.success(e(u)(453,[o.name])),n==="zip"&&je(a,"results.zip","application/zip")}catch(a){console.error(a),R.error(e(u)(360,[a]))}finally{f(g,!1)}}async function $e(){if(!w.currentSessionId)return R.error(e(u)(406)),[];await he();const o=await e(b).previewResultsZip.once({include:e(_),sessionId:w.currentSessionId}),n=[];for(const[a,s]of Oe(o))Ge({tree:n,paths:s.map(t=>t.path),provenance:a,contentType:t=>s.find(r=>r.path===t)?.contentType??"application/octet-stream"});return n}let U=C(void 0);we([()=>e(_)],()=>{f(U,void 0),(async()=>f(U,await $e(),!0))()});let T=C(Be({}));we([()=>e(_),()=>e(d)],()=>{f(T,{},!0),(async()=>w.currentSessionId&&f(T,await e(b).estimateResultsZipSize.once({include:e(_),sessionId:w.currentSessionId,cropPadding:e(d).withUnit}),!0))()});const V={folder:E,children:Array(10).fill(E)};let L=C(!1);K(()=>{"showDirectoryPicker"in window&&f(L,!0)});var A=st(),H=m(A),j=m(H),xe=m(j,!0);v(j);var oe=x(j,2),ie=m(oe);{const o=a=>{var s=Q(),t=X(s);{var r=l=>{_e(l,{})},p=l=>{Ve(l,{})};te(t,l=>{e(g)==="zip"?l(r):l(p,!1)})}$(a,s)},n=a=>{var s=et(),t=m(s);{const r=(l,h=D)=>{Y();var c=ee();M(z=>y(c,`~${z??""}`),[()=>S(h(),"narrow")]),$(l,c)};let p=i(()=>S(15e4,"narrow"));re(t,{get value(){return e(T).compressed},get mask(){return`~${e(p)??""}`},loaded:r,$$slots:{loaded:!0}})}v(s),ve(s,(r,p)=>fe?.(r,p),()=>"Taille estimée de l'archive .zip"),$(a,s)};ge(ie,{onclick:async()=>await ae(void 0),_w_snippet_0:o,_w_snippet_1:n,children:(a,s)=>{{let t=i(()=>[o,n]),r=i(()=>e(u).c(454));se(a,{get t(){return e(t)},get x(){return e(r)}})}},$$slots:{_w_snippet_0:!0,_w_snippet_1:!0,default:!0}})}var ye=x(ie,2);{const o=t=>{var r=Q(),p=X(r);{var l=c=>{_e(c,{})},h=c=>{Xe(c,{})};te(p,c=>{e(g)==="folder"?c(l):c(h,!1)})}$(t,r)},n=t=>{var r=Q(),p=X(r);{var l=h=>{var c=tt(),z=m(c);{const B=(Se,Re=D)=>{Y();var me=ee();M(Fe=>y(me,`~${Fe??""}`),[()=>S(Re(),"narrow")]),$(Se,me)};let P=i(()=>S(15e4,"narrow"));re(z,{get value(){return e(T).uncompressed},get mask(){return`~${e(P)??""}`},loaded:B,$$slots:{loaded:!0}})}v(c),ve(c,(B,P)=>fe?.(B,P),()=>"Taille totale estimée du dossier"),$(h,c)};te(p,h=>{e(L)&&h(l)})}$(t,r)};let a=i(()=>!e(L)),s=i(()=>e(L)?void 0:"Votre navigateur ne supporte pas l'exportation en dossier, utilisez Chrome ou Edge.");ge(ye,{get disabled(){return e(a)},get help(){return e(s)},onclick:async()=>{if(!e(L))return;const t=await window.showDirectoryPicker({mode:"readwrite",startIn:"documents",id:"results-export"});await ae(t)},_w_snippet_2:o,_w_snippet_3:n,children:(t,r)=>{{let p=i(()=>[o,n]),l=i(()=>e(u).c(455));se(t,{get t(){return e(p)},get x(){return e(l)}})}},$$slots:{_w_snippet_2:!0,_w_snippet_3:!0,default:!0}})}v(oe),v(H);var ne=x(H,2),G=m(ne),O=m(G),be=m(O);qe(be,{options:[{key:"metadataonly",label:"Métadonnées seulement"},{key:"croppedonly",label:"Métadonnées et images recadrées"},{key:"full",label:"Métadonnées, images recadrées et images originales",subtext:"Permet de ré-importer les résultats ultérieurement"}],get value(){return e(_)},set value(o){f(_,o,!0)}}),v(O);var W=x(O,2);let le;var q=m(W),ke=m(q,!0);v(q);var ce=x(q,2);{const o=(a,s=D)=>{const t=i(()=>s()==="customPercent"?"%":"px");var r=rt();let p;var l=m(r);{let c=i(()=>s()==="customPercent"?"en pourcentage des dimensions de l'image":"en pixels"),z=i(()=>e(d).unitless===0?"0":e(d).unit===e(t)?e(d).unitless.toString():"?");We(l,{get label(){return e(c)},get value(){return e(z)},onblur:async B=>{await Me();const P=Number.parseInt(B,10);!isNaN(P)&&P>0&&(f(d,Z(P+e(t))),f(k,s()))}})}var h=x(l);v(r),M(()=>{p=Ue(r,"",p,{"--width":e(t)==="%"?"3ch":"4ch"}),y(h,` ${e(t)??""}`)}),$(a,r)};let n=i(()=>e(u)(115));Je(ce,{get"aria-label"(){return e(n)},options:["none","small","medium","customPercent","customPixels"],labels:{none:"Aucune",small:"5%",medium:"10%"},get value(){return e(k)},set value(a){f(k,a)},customOption:o,$$slots:{customOption:!0}})}var de=x(ce,2),ze=m(de,!0);v(de),v(W),v(G);var pe=x(G,2),J=m(pe),Pe=m(J,!0);v(J);var ue=x(J,2),Ie=m(ue);{const o=a=>{const s=t=>{{const r=(l,h=D)=>{Y();var c=ee();M(z=>y(c,`~${z??""}`),[()=>S(h(),"narrow")]),$(l,c)};let p=i(()=>S(1e6,"narrow"));re(t,{get value(){return e(T).uncompressed},get mask(){return`~${e(p)??""}`},loaded:r,$$slots:{loaded:!0}})}};{let t=i(()=>[s]),r=i(()=>e(u).c(410));se(a,{get t(){return e(t)},get x(){return e(r)}})}};let n=i(()=>e(U)??[E,E,...{metadataonly:[],croppedonly:[V],full:[V,V]}[e(_)]]);Ke(Ie,{get tree(){return e(n)},rootHelp:o,$$slots:{rootHelp:!0}})}v(ue),v(pe),v(ne),v(A),M((o,n,a,s)=>{y(xe,o),le=Ee(W,1,"crop-padding svelte-1t5c71w",null,le,{irrelevant:e(_)==="metadataonly"}),y(ke,n),y(ze,a),y(Pe,s)},[()=>e(u)(13),()=>e(u)(115),()=>e(u)(407),()=>e(u)(408)]),$(F,A),Ce()}export{Rt as component};
