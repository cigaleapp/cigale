import{_ as N}from"./PPVm8Dsz.js";import{u as i}from"./BPJfxdhi.js";import{t as R}from"./Bd7_h5c3.js";import{r as g,t as y,b as h,o as M,e as S,X as _,Y as A,u as L}from"./Don2Ydo1.js";const P="0123456789ABCDEFGHJKMNPQRSTVWXYZ",I=32,D=16,T=10,w=0xffffffffffff;var u;(function(e){e.Base32IncorrectEncoding="B32_ENC_INVALID",e.DecodeTimeInvalidCharacter="DEC_TIME_CHAR",e.DecodeTimeValueMalformed="DEC_TIME_MALFORMED",e.EncodeTimeNegative="ENC_TIME_NEG",e.EncodeTimeSizeExceeded="ENC_TIME_SIZE_EXCEED",e.EncodeTimeValueMalformed="ENC_TIME_MALFORMED",e.PRNGDetectFailure="PRNG_DETECT",e.ULIDInvalid="ULID_INVALID",e.Unexpected="UNEXPECTED",e.UUIDInvalid="UUID_INVALID"})(u||(u={}));class d extends Error{constructor(t,n){super(`${n} (${t})`),this.name="ULIDError",this.code=t}}function F(e){const t=Math.floor(e()*I)%I;return P.charAt(t)}function U(e){const t=O(),n=t&&(t.crypto||t.msCrypto)||null;if(typeof n?.getRandomValues=="function")return()=>{const a=new Uint8Array(1);return n.getRandomValues(a),a[0]/256};if(typeof n?.randomBytes=="function")return()=>n.randomBytes(1).readUInt8()/256;throw new d(u.PRNGDetectFailure,"Failed to find a reliable PRNG")}function O(){return k()?self:typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:null}function C(e,t){let n="";for(;e>0;e--)n=F(t)+n;return n}function j(e,t=T){if(isNaN(e))throw new d(u.EncodeTimeValueMalformed,`Time must be a number: ${e}`);if(e>w)throw new d(u.EncodeTimeSizeExceeded,`Cannot encode a time larger than ${w}: ${e}`);if(e<0)throw new d(u.EncodeTimeNegative,`Time must be positive: ${e}`);if(Number.isInteger(e)===!1)throw new d(u.EncodeTimeValueMalformed,`Time must be an integer: ${e}`);let n,a="";for(let r=t;r>0;r--)n=e%I,a=P.charAt(n)+a,e=(e-n)/I;return a}function k(){return typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope}function B(e,t){const n=U(),a=Date.now();return j(a,T)+C(D,n)}const p={maxMemoryUsageInMB:1024,maxResolutionInMP:100};function q(e,t=0){return`${e}_${t.toString().padStart(6,"0")}`}function J(){return B()}function E(e){return/^[0-9A-Z]{26}_\d+$/.test(e)}function v(e){const t=h("js");return new Error(t(492,[e]))}function K(e){if(e===void 0)return e;if(!E(e))throw v(e);return e?.replace(/(_\d+)+$/,"")}function Q(e,t){return!e||!t?!1:i.erroredImages.has(t)?!0:y.Image.state.some(n=>n.fileId===t&&n.boundingBoxesAnalyzed)}function ee(e){return!!(i.classificationMetadataId&&e.metadata[i.classificationMetadataId]||i.erroredImages.has(e.id)||i.classificationMetadataId&&e.metadataErrors?.[i.classificationMetadataId]?.length)}function te(e){return!!(e.fileId||i.erroredImages.has(e.id))}async function ne(e,t,n=!0){await M(["Image","ImageFile","ImagePreviewFile","Observation"],{session:i.currentSession?.id},async r=>{const o=await r.objectStore("Observation").getAll(),c=z(e);try{r.objectStore("ImageFile").delete(e),r.objectStore("ImagePreviewFile").delete(e);for(const s of c){r.objectStore("Image").delete(s.id);for(const m of o){const l=m.images.filter(f=>f!==s.id);l.length===0?r.objectStore("Observation").delete(m.id):l.length<m.images.length&&r.objectStore("Observation").put({...m,images:l})}}}catch(s){if(!n)return Promise.reject(s)}}),i.erroredImages.delete(e),i.loadingImages.delete(e),i.queuedImages.delete(e),i.imageOpenedInCropper===e&&(i.imageOpenedInCropper="");const a=i.getPreviewURL(e);a&&(URL.revokeObjectURL(a),i.previewURLs.delete(e))}async function ae({id:e,sessionId:t,originalBytes:n,resizedBytes:a,contentType:r,filename:o,width:c,height:s,tx:m}){await M(["ImageFile","ImagePreviewFile"],{},async l=>{l.objectStore("ImageFile").put({id:e,bytes:n,contentType:r,filename:o,dimensions:{width:c,height:s},sessionId:t??i.currentSessionId}),l.objectStore("ImagePreviewFile").put({id:e,bytes:a,contentType:r,filename:o,dimensions:{width:c,height:s},sessionId:t??i.currentSessionId});const f=new Blob([a],{type:r});i.setPreviewURL(e,URL.createObjectURL(f))})}async function re(e,t="session"){const n=await A("ImagePreviewFile",e);if(!n)return;const a=new Blob([n.bytes],{type:n.contentType});i.setPreviewURL(e,URL.createObjectURL(a),t==="global")}const b=1024,x=({width:e,height:t})=>Math.round(b*t/e),$=["image/CR2","image/x-canon-cr2","image/x-dcraw","image/x-canon-crw","image/x-kodak-dcr","image/x-adobe-dng","image/x-epson-erf","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-olympus-orf","image/x-pentax-pef","image/x-fuji-raf","image/x-panasonic-raw","image/x-sony-sr2","image/x-sony-srf","image/x-sigma-x3f"],G=["image/jpeg","image/png"],V=[...$];function W(){return h("js")(490,[p.maxResolutionInMP,p.maxMemoryUsageInMB])}async function ie({source:e}){const{resize:t}=await N(async()=>{const{resize:s}=await import("./DKBeN54O.js");return{resize:s}},[],import.meta.url),n=await createImageBitmap(e).catch(s=>{throw new Error(G.includes(e.type)?S(s):V.includes(e.type)?`Les fichiers ${_(e.type)} ne sont pas encore supportés`:`Le format de fichier ${_(e.type)} n'est pas supporté`)}),{width:a,height:r}=n;if(a*r>p.maxResolutionInMP*1e6)throw new Error(W());const o=document.createElement("canvas");o.width=a,o.height=r,o.getContext("2d")?.drawImage(n,0,0);const c=document.createElement("canvas");return c.width=b,c.height=x(n),t(o,c,{targetWidth:b,targetHeight:x(n),filter:"mks2013"}),new Promise(s=>{c.toBlob(m=>{if(!m)throw new Error("Failed to resize image");m.arrayBuffer().then(l=>s([[a,r],l]))},e.type)})}function z(e,t=void 0){return(t??y.Image.state).filter(n=>n.fileId===e)}function oe(e){return L(e.map(t=>t.fileId).filter(t=>t!==null))}function se(e){if(!E(e)&&!E(`${e}_000000`))throw v(e);const[t,n]=e.split("_",2),a=Number.parseInt(n,10);return{fileId:t,subindex:Number.isNaN(a)?null:a}}function ce(e){const t=e.match(/(\d+)(px|%)/);if(!t)throw new Error(`Invalid crop padding: ${e}`);const[n,a]=[Number.parseInt(t[1],10),t[2]];return{withUnit:e,unitless:n,unit:a,inPixels:r=>a==="px"?n:Math.round(r*n/100),apply({width:r,height:o},{w:c,h:s,...m}){const{x:l,y:f}=R({w:c,h:s,...m});return{x:g(l*r-this.inPixels(r),0,r),y:g(f*o-this.inPixels(o),0,o),width:g(c*r+this.inPixels(r)*2,1,r),height:g(s*o+this.inPixels(o)*2,1,o)}}}}export{te as a,ee as b,E as c,ne as d,K as e,Q as f,J as g,q as h,oe as i,se as j,z as k,re as l,p as m,W as n,ce as p,ie as r,ae as s};
