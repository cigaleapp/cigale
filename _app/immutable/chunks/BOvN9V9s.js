import{o as b,c as g,g as u,b as O,t as c,a as f,m as S}from"./Don2Ydo1.js";import{i as p,d as F}from"./DfkTl275.js";import{m as v}from"./BxRil6yI.js";import{s as h}from"./BhEwWWID.js";import{u as d}from"./BPJfxdhi.js";async function E(e){const t=d.currentProtocol;if(!t)throw new Error("No protocol selected");const a=d.currentSession?.id;if(!a)throw new Error("No session selected");const i=e.map(o=>c.Observation.getFromState(o)).filter(f),s=await Promise.all(e.map(async o=>c.Image.raw.get(o))).then(o=>o.filter(f)),l=new Set(i.flatMap(o=>o.images)).union(new Set(s.map(o=>o.id))),r=u("Observation"),n={id:r,sessionId:a,images:[...l].toSorted(g(o=>e.indexOf(o))),addedAt:new Date().toISOString(),label:m([...i,...s]),metadataOverrides:S(v({definitions:c.Metadata.state,images:[],observations:i}),h)};return n.label=w({protocol:t,images:s,observation:n}),await c.Observation.do(void 0,o=>{o.add(n);for(const{id:I}of i)o.delete(I)}),r}async function L(e,{recursive:t=!1,notFoundOk:a=!0,tx:i=void 0}={}){await b(["Observation","Image","ImageFile","ImagePreviewFile"],{},async s=>{const l=await s.objectStore("Observation").get(e);if(!l){if(a)return;throw"Observation non trouvÃ©e"}s.objectStore("Observation").delete(e);const r=await s.objectStore("Image").getAll().then(n=>n.filter(o=>l.images.includes(o.id)));if(t)for(const n of p(r))await F(n,s,a);d.erroredImages.delete(e)})}function w({images:e,observation:t,protocol:a}){return a?.observations?.defaultLabel?.render({images:e,observation:t})||m([t,...e])}function m(e){for(const a of e){if("label"in a)return a.label;if("filename"in a)return a.filename.replace(/\.[^.]+$/,"")}return O("js")(491)}function j(e,t,a){const s={id:u("Observation"),sessionId:a.id,images:[e.id],addedAt:new Date().toISOString(),label:m([e]),metadataOverrides:{}};return{...s,label:w({images:[e],observation:s,protocol:t})}}async function P(e){const t=d.currentSession,a=d.currentProtocol;if(!a)throw new Error("No protocol selected");if(!t)throw new Error("No session selected");await b(["Observation","Image"],{},async i=>{const s=await i.objectStore("Image").index("sessionId").getAll(t.id),l=await i.objectStore("Observation").index("sessionId").getAll(t.id);for(const r of s)if(!l.some(n=>n.images.includes(r.id))){const n=j(r,a,t);i.objectStore("Observation").add(n),d.setSelection?.(d.selection.map(o=>o===r.id?n.id:o))}})}function D({definitions:e,observation:t,images:a}){return{...v({definitions:e,observations:[],images:a.filter(({id:s})=>t.images.includes(s)).toSorted(g(({id:s})=>t.images.indexOf(s)))}),...t.metadataOverrides}}export{L as d,P as e,E as m,j as n,D as o};
