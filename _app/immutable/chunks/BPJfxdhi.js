import{aq as u,by as m,W as C,g as r,as as n,bg as d,aR as S,u as o}from"./BwdvgNQo.js";import{t as f}from"./Don2Ydo1.js";import{g as L}from"./BeqcFVE5.js";import{a as U,b as y}from"./Xiow3_xo.js";var w={},P;function _(){return P||(P=1,(function(l){Object.defineProperty(l,"__esModule",{value:!0}),l.Estimation=l.defaultClock=void 0;const e=()=>typeof performance<"u"?performance.now():new Date().getTime();l.defaultClock=e;class t{timeFetcher;state;constructor({progress:i=0,total:a=100,startTime:p,timeFetcher:c}={}){this.timeFetcher=c??l.defaultClock,this.state={progress:i,total:a,startTime:p??this.now()}}reset(i){this.state.startTime=i!==void 0?i:this.now()}update(i,a){return this.state.progress=i,a!==void 0&&(this.state.total=a),this.measure()}estimate(){return this.measure().estimate}measure(i=1e3){const{progress:a,total:p}=this.state,c=this.now()-this.state.startTime,h=c/a,g=p-a,I=h*g,R=i/h;return{timeDelta:c,averageTime:h,progressLeft:g,speed:R,estimate:I}}now(){return this.timeFetcher()}}l.Estimation=t})(w)),w}var z=_(),O=["forEach","isDisjointFrom","isSubsetOf","isSupersetOf"],A=["difference","intersection","symmetricDifference","union"],b=!1;class v extends Set{#t=new Map;#e=u(0);#s=u(0);#n=m||-1;constructor(e){if(super(),e){for(var t of e)super.add(t);this.#s.v=super.size}b||this.#i()}#r(e){return m===this.#n?u(e):C(e)}#i(){b=!0;var e=v.prototype,t=Set.prototype;for(const s of O)e[s]=function(...i){return r(this.#e),t[s].apply(this,i)};for(const s of A)e[s]=function(...i){r(this.#e);var a=t[s].apply(this,i);return new v(a)}}has(e){var t=super.has(e),s=this.#t,i=s.get(e);if(i===void 0){if(!t)return r(this.#e),!1;i=this.#r(!0),s.set(e,i)}return r(i),t}add(e){return super.has(e)||(super.add(e),n(this.#s,super.size),d(this.#e)),this}delete(e){var t=super.delete(e),s=this.#t,i=s.get(e);return i!==void 0&&(s.delete(e),n(i,!1)),t&&(n(this.#s,super.size),d(this.#e)),t}clear(){if(super.size!==0){super.clear();var e=this.#t;for(var t of e.values())n(t,!1);e.clear(),n(this.#s,0),d(this.#e)}}keys(){return this.values()}values(){return r(this.#e),super.values()}entries(){return r(this.#e),super.entries()}[Symbol.iterator](){return this.keys()}get size(){return r(this.#s)}}class M extends Map{#t=new Map;#e=u(0);#s=u(0);#n=m||-1;constructor(e){if(super(),e){for(var[t,s]of e)super.set(t,s);this.#s.v=super.size}}#r(e){return m===this.#n?u(e):C(e)}has(e){var t=this.#t,s=t.get(e);if(s===void 0){var i=super.get(e);if(i!==void 0)s=this.#r(0),t.set(e,s);else return r(this.#e),!1}return r(s),!0}forEach(e,t){this.#i(),super.forEach(e,t)}get(e){var t=this.#t,s=t.get(e);if(s===void 0){var i=super.get(e);if(i!==void 0)s=this.#r(0),t.set(e,s);else{r(this.#e);return}}return r(s),super.get(e)}set(e,t){var s=this.#t,i=s.get(e),a=super.get(e),p=super.set(e,t),c=this.#e;if(i===void 0)i=this.#r(0),s.set(e,i),n(this.#s,super.size),d(c);else if(a!==t){d(i);var h=c.reactions===null?null:new Set(c.reactions),g=h===null||!i.reactions?.every(I=>h.has(I));g&&d(c)}return p}delete(e){var t=this.#t,s=t.get(e),i=super.delete(e);return s!==void 0&&(t.delete(e),n(this.#s,super.size),n(s,-1),d(this.#e)),i}clear(){if(super.size!==0){super.clear();var e=this.#t;n(this.#s,0);for(var t of e.values())n(t,-1);d(this.#e),e.clear()}}#i(){r(this.#e);var e=this.#t;if(this.#s.v!==e.size){for(var t of super.keys())if(!e.has(t)){var s=this.#r(0);e.set(t,s)}}for([,s]of this.#t)r(s)}keys(){return r(this.#e),super.keys()}values(){return this.#i(),super.values()}entries(){return this.#i(),super.entries()}[Symbol.iterator](){return this.entries()}get size(){return r(this.#s),super.size}}class T{#t=u(S({files:[],total:0,done:0,time:0,task:"",get progress(){return this.total?this.done/this.total:0},removeFile(e){const t=this.files.findIndex(s=>s.id===e);t!==-1&&this.files.splice(t,1)},reset(){this.total=0,this.done=0,this.time=0,this.task=""}}));get processing(){return r(this.#t)}set processing(e){n(this.#t,e,!0)}#e=new z.Estimation({total:0});#s(e,t){if(e>=t||t===0){this.#e.reset();return}this.#e.update(e,t)}#n=o(()=>(this.#s(this.processing.done,this.processing.total),this.#e.estimate()));get eta(){return r(this.#n)}set eta(e){n(this.#n,e)}#r=u(S([]));get selection(){return r(this.#r)}set selection(e){n(this.#r,e,!0)}#i=u("");get imageOpenedInCropper(){return r(this.#i)}set imageOpenedInCropper(e){n(this.#i,e,!0)}#a=u("");get imagePreviouslyOpenedInCropper(){return r(this.#a)}set imagePreviouslyOpenedInCropper(e){n(this.#a,e,!0)}previewURLs=new M;globalPreviewURLs=new M;erroredImages=new M;loadingImages=new v;queuedImages=new v;#o=u(S({}));get keybinds(){return r(this.#o)}set keybinds(e){n(this.#o,e,!0)}cropperZoomStates=new M;#u=u(void 0);get setSelection(){return r(this.#u)}set setSelection(e){n(this.#u,e,!0)}#c=u(null);get _currentSessionId(){return r(this.#c)}set _currentSessionId(e){n(this.#c,e,!0)}#l=o(()=>this._currentSessionId||localStorage.getItem("currentSessionId")||null);get currentSessionId(){return r(this.#l)}set currentSessionId(e){n(this.#l,e)}async setCurrentSession(e){e===null?localStorage.removeItem("currentSessionId"):(f.Session.update(e,"openedAt",new Date().toISOString()),localStorage.setItem("currentSessionId",e)),this._currentSessionId=e}#d=o(()=>f.Session.state.find(e=>e.id===this.currentSessionId));get currentSession(){return r(this.#d)}set currentSession(e){n(this.#d,e)}#h=o(()=>this.currentSession?.protocol);get currentProtocolId(){return r(this.#h)}set currentProtocolId(e){n(this.#h,e)}#f=o(()=>f.Protocol.state.find(e=>e.id===this.currentProtocolId));get currentProtocol(){return r(this.#f)}set currentProtocol(e){n(this.#f,e)}#p=o(()=>this.currentProtocol?U(this.currentProtocol,f.Metadata.state):void 0);get classificationMetadata(){return r(this.#p)}set classificationMetadata(e){n(this.#p,e)}#v=o(()=>this.classificationMetadata?.id);get classificationMetadataId(){return r(this.#v)}set classificationMetadataId(e){n(this.#v,e)}#g=o(()=>this.currentProtocol?y(this.currentProtocol,f.Metadata.state):void 0);get cropMetadata(){return r(this.#g)}set cropMetadata(e){n(this.#g,e)}#M=o(()=>this.cropMetadata?.id??"crop");get cropMetadataId(){return r(this.#M)}set cropMetadataId(e){n(this.#M,e)}cropMetadataValueOf(e){return L(e,"boundingbox",this.cropMetadataId)}hasPreviewURL(e){return e?this.globalPreviewURLs.has(e)||this.previewURLs.has(e):!1}getPreviewURL(e){if(e)return this.previewURLs.get(e)||this.globalPreviewURLs.get(e)}setPreviewURL(e,t,s=!1){console.debug("setPreviewURL",{imageFileId:e,url:t,global:s}),e&&(s?this.globalPreviewURLs.set(e,t):this.previewURLs.set(e,t))}revokePreviewURL(e){const t=this.previewURLs.get(e);t&&(URL.revokeObjectURL(t),this.previewURLs.delete(e),this.globalPreviewURLs.delete(e))}clearPreviewURLs(){for(const e of this.previewURLs.keys())this.revokePreviewURL(e)}#m=o(()=>{const e=this.classificationMetadata?.infer;return e?"neural"in e?e.neural:[]:[]});get classificationModels(){return r(this.#m)}set classificationModels(e){n(this.#m,e)}#I=o(()=>{const e=this.cropMetadata?.infer;return e?e.neural:[]});get cropModels(){return r(this.#I)}set cropModels(e){n(this.#I,e)}#S=o(()=>{if(!this.currentProtocolId)return-1;const e=this.cropMetadataId;return e?this.currentSession?.inferenceModels[e]??0:-1});get selectedCropModel(){return r(this.#S)}set selectedCropModel(e){n(this.#S,e)}#w=o(()=>{if(!this.currentProtocolId)return-1;const e=this.classificationMetadataId;return e?this.currentSession?.inferenceModels[e]??0:-1});get selectedClassificationModel(){return r(this.#w)}set selectedClassificationModel(e){n(this.#w,e)}#P=o(()=>this.cropModels.length>0&&this.selectedCropModel!==-1);get cropInferenceAvailable(){return r(this.#P)}set cropInferenceAvailable(e){n(this.#P,e)}#b=o(()=>this.classificationModels.length>0&&this.selectedClassificationModel!==-1);get classificationInferenceAvailable(){return r(this.#b)}set classificationInferenceAvailable(e){n(this.#b,e)}async setModelSelections({classification:e=null,crop:t=null}){if(!this.currentSession||e===null&&t===null)return;const s={classification:this.classificationMetadataId,crop:this.cropMetadataId};if(!s.classification||!s.crop)return;const i=this.currentSession.inferenceModels,a={};e!==null&&e!==this.selectedClassificationModel&&(a[s.classification]=e),t!==null&&t!==this.selectedCropModel&&(a[s.crop]=t),Object.keys(a).length!==0&&await f.Session.update(this.currentSession.id,"inferenceModels",{...i,...a})}}const q=new T;export{v as S,M as a,q as u};
