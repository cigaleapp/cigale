import{a as f}from"./B5Ge56Uk.js";import{v as A,o as v,t as M,e as k,w as h,j as N}from"./D9uJnc4X.js";import{o as L,a as F}from"./CNplBLUs.js";import{u as i}from"./B5baxliF.js";import{e as j,k as U,u as C}from"./DvdFYW7d.js";import{_ as G}from"./PPVm8Dsz.js";import{_ as T}from"./ByTqR5TD.js";import"./DWOfE_Fn.js";function fe(e,n){const t=A(e,n?.in);if(isNaN(+t))throw new RangeError("Invalid time value");let a="",o="";const c="-",m=":";{const r=f(t.getDate(),2),s=f(t.getMonth()+1,2);a=`${f(t.getFullYear(),4)}${c}${s}${c}${r}`}{const r=t.getTimezoneOffset();if(r!==0){const _=Math.abs(r),$=f(Math.trunc(_/60),2),O=f(_%60,2);o=`${r<0?"+":"-"}${$}:${O}`}else o="Z";const s=f(t.getHours(),2),u=f(t.getMinutes(),2),I=f(t.getSeconds(),2),S=a===""?"":"T",D=[s,u,I].join(m);a=`${a}${S}${D}${o}`}return a}const B={general:"Général",observations:"Observations",navigation:"Navigation",cropping:"Recadrage",debugmode:"Debug mode"};function le(e,n){L(()=>{for(const[t,a]of j(n)){if(t in i.keybinds){console.warn(`Keybind ${t} already defined, not overriding.`);continue}i.keybinds[t]={group:B[a.debug?"debugmode":e],...a}}}),F(()=>{for(const t of U(n))delete i.keybinds[t]})}const x="0123456789ABCDEFGHJKMNPQRSTVWXYZ",g=32,V=16,R=10,w=0xffffffffffff;var l;(function(e){e.Base32IncorrectEncoding="B32_ENC_INVALID",e.DecodeTimeInvalidCharacter="DEC_TIME_CHAR",e.DecodeTimeValueMalformed="DEC_TIME_MALFORMED",e.EncodeTimeNegative="ENC_TIME_NEG",e.EncodeTimeSizeExceeded="ENC_TIME_SIZE_EXCEED",e.EncodeTimeValueMalformed="ENC_TIME_MALFORMED",e.PRNGDetectFailure="PRNG_DETECT",e.ULIDInvalid="ULID_INVALID",e.Unexpected="UNEXPECTED",e.UUIDInvalid="UUID_INVALID"})(l||(l={}));class d extends Error{constructor(n,t){super(`${t} (${n})`),this.name="ULIDError",this.code=n}}function z(e){const n=Math.floor(e()*g)%g;return x.charAt(n)}function W(e){const n=H(),t=n&&(n.crypto||n.msCrypto)||null;if(typeof t?.getRandomValues=="function")return()=>{const a=new Uint8Array(1);return t.getRandomValues(a),a[0]/255};if(typeof t?.randomBytes=="function")return()=>t.randomBytes(1).readUInt8()/255;throw new d(l.PRNGDetectFailure,"Failed to find a reliable PRNG")}function H(){return Z()?self:typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:null}function X(e,n){let t="";for(;e>0;e--)t=z(n)+t;return t}function Y(e,n=R){if(isNaN(e))throw new d(l.EncodeTimeValueMalformed,`Time must be a number: ${e}`);if(e>w)throw new d(l.EncodeTimeSizeExceeded,`Cannot encode a time larger than ${w}: ${e}`);if(e<0)throw new d(l.EncodeTimeNegative,`Time must be positive: ${e}`);if(Number.isInteger(e)===!1)throw new d(l.EncodeTimeValueMalformed,`Time must be an integer: ${e}`);let t,a="";for(let o=n;o>0;o--)t=e%g,a=x.charAt(t)+a,e=(e-t)/g;return a}function Z(){return typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope}function K(e,n){const t=W(),a=Date.now();return Y(a,R)+X(V,t)}const p={maxMemoryUsageInMB:1024,maxResolutionInMP:100};function de(e,n=0){return`${e}_${n.toString().padStart(6,"0")}`}function ge(){return K()}function b(e){return/^[0-9A-Z]{26}_\d+$/.test(e)}function P(e){const n=T(N("js"));return new Error(n.t(215,[e]))}function Ie(e){if(e===void 0)return e;if(!b(e))throw P(e);return e?.replace(/(_\d+)+$/,"")}function pe(e,n){return!e||!n?!1:i.erroredImages.has(n)?!0:M.Image.state.some(t=>t.fileId===n&&t.boundingBoxesAnalyzed)}function be(e){return!!(i.classificationMetadataId&&e.metadata[i.classificationMetadataId]||i.erroredImages.has(e.id))}function Ee(e){return!!(e.fileId||i.erroredImages.has(e.id))}async function _e(e,n,t=!0){await v(["Image","ImageFile","ImagePreviewFile","Observation"],{},async o=>{const c=await o.objectStore("Observation").getAll(),m=te(e);try{o.objectStore("ImageFile").delete(e),o.objectStore("ImagePreviewFile").delete(e);for(const r of m){o.objectStore("Image").delete(r.id);for(const s of c){const u=s.images.filter(I=>I!==r.id);u.length===0?o.objectStore("Observation").delete(s.id):u.length<s.images.length&&o.objectStore("Observation").put({...s,images:u})}}}catch(r){if(!t)return Promise.reject(r)}}),i.erroredImages.delete(e),i.loadingImages.delete(e),i.queuedImages.delete(e),i.imageOpenedInCropper===e&&(i.imageOpenedInCropper="");const a=i.previewURLs.get(e);a&&(URL.revokeObjectURL(a),i.previewURLs.delete(e))}async function he({id:e,originalBytes:n,resizedBytes:t,contentType:a,filename:o,width:c,height:m,tx:r}){await v(["ImageFile","ImagePreviewFile"],{},async s=>{s.objectStore("ImageFile").put({id:e,bytes:n,contentType:a,filename:o,dimensions:{width:c,height:m}}),s.objectStore("ImagePreviewFile").put({id:e,bytes:t,contentType:a,filename:o,dimensions:{width:c,height:m}});const u=new Blob([t],{type:a});i.setPreviewURL(e,URL.createObjectURL(u))})}const E=1024,y=({width:e,height:n})=>Math.round(E*n/e),q=["image/CR2","image/x-canon-cr2","image/x-dcraw","image/x-canon-crw","image/x-kodak-dcr","image/x-adobe-dng","image/x-epson-erf","image/x-kodak-k25","image/x-kodak-kdc","image/x-minolta-mrw","image/x-nikon-nef","image/x-olympus-orf","image/x-pentax-pef","image/x-fuji-raf","image/x-panasonic-raw","image/x-sony-sr2","image/x-sony-srf","image/x-sigma-x3f"],J=["image/jpeg","image/png"],Q=[...q];function ee(){return T(N("js")).t(119,[p.maxResolutionInMP,p.maxMemoryUsageInMB])}async function we({source:e}){const{resize:n}=await G(async()=>{const{resize:r}=await import("./DKBeN54O.js");return{resize:r}},[],import.meta.url),t=await createImageBitmap(e).catch(r=>{throw new Error(J.includes(e.type)?k(r):Q.includes(e.type)?`Les fichiers ${h(e.type)} ne sont pas encore supportés`:`Le format de fichier ${h(e.type)} n'est pas supporté`)}),{width:a,height:o}=t;if(a*o>p.maxResolutionInMP*1e6)throw new Error(ee());const c=document.createElement("canvas");c.width=a,c.height=o,c.getContext("2d")?.drawImage(t,0,0);const m=document.createElement("canvas");return m.width=E,m.height=y(t),n(c,m,{targetWidth:E,targetHeight:y(t),filter:"mks2013"}),new Promise(r=>{m.toBlob(s=>{if(!s)throw new Error("Failed to resize image");s.arrayBuffer().then(u=>r([[a,o],u]))},e.type)})}function te(e,n=void 0){return(n??M.Image.state).filter(t=>t.fileId===e)}function ye(e){return C(e.map(n=>n.fileId).filter(n=>n!==null))}function ve(e){if(!b(e)&&!b(`${e}_000000`))throw P(e);const[n,t]=e.split("_",2),a=Number.parseInt(t,10);return{fileId:n,subindex:Number.isNaN(a)?null:a}}function Me(e){const n=e.match(/(\d+)(px|%)/);if(!n)throw new Error(`Invalid crop padding: ${e}`);const[t,a]=[Number.parseInt(n[1],10),n[2]];return{withUnit:e,unitless:t,unit:a,inPixels:o=>a==="px"?t:Math.round(o*t/100)}}export{be as a,b,Ie as c,_e as d,pe as e,le as f,te as g,de as h,Ee as i,fe as j,ye as k,p as l,ee as m,ge as n,Me as o,ve as p,we as r,he as s};
