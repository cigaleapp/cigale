name: Draft a desktop app release

on:
  push:
    tags: [v202*.*.*]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag for the release'
        required: true

# https://www.electronforge.io/config/publishers/github#authentication
permissions:
  contents: write

jobs:
  draft_release:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Node.js
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: .bun-version
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Get release notes
        id: release_notes
        run: |
          Get-Content Env:SCRIPT | Out-File get-notes.js
          bun get-notes.js >> $GITHUB_OUTPUT
        env:
          SCRIPT: |
            const fs = require('fs'); 
            const changelog = fs.readFileSync('CHANGELOG.md', 'utf8'); 
            const lines = changelog.split(/\r?\n/); 
            let notes = []; 
            let inSection = false; 
            let foundSection = false; 

            for (const line of lines) { 
              if (line.trim().startsWith('## ')) { 
                if (inSection) break; 
                inSection = true; 
                foundSection = true; 
                continue; 
              } 
                
              if (inSection) notes.push(line); 
            } 
              
            while (notes.length && notes[0].trim() === '') notes.shift(); 

            const result = notes.join('\n').trim(); 

            console.log('release_notes<<EOF'); 

            if (foundSection) { 
              console.log(result || '[No content found after first ## section]'); 
            } else { 
              console.log('[No ## section found in CHANGELOG.md]'); 
            } 
              
            console.log('EOF');
      - name: Build, package and publish app
        run: bun run prebuild; bunx electron-forge publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ELECTRON_BUILD: '1'

      - name: Set release notes on release draft
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.release_notes.outputs.release_notes }}
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          draft: true
