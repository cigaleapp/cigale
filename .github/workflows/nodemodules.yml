name: node_modules

permissions: 
  actions: write
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  ELECTRON_SKIP_BINARY_DOWNLOAD: 'true'

on:
  pull_request:
    branches: [main]
    paths:
      - .github/workflows/nodemodules.yml
      - package.json
      - bun.lock

jobs:
  analyze:
    if: ${{ !startsWith(github.head_ref, 'renovate/') }}
    runs-on: ubuntu-latest
    environment:
      name: '#${{ github.event.pull_request.number }}: node_modules analysis'
      url: ${{ steps.upload.outputs.preview-url }}
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: .bun-version
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Install node-modules-inspector
        run: bun install --global node-modules-inspector
      - name: Run node-modules-inspector
        run: bunx node-modules-inspector build --base /node-modules --outDir out
      - name: Save report
        uses: actions/upload-artifact@v6
        with:
          path: ./out
          name: report
          retention-days: 1

  report:
    needs: analyze
    uses: ./.github/workflows/dev-deploy.yml
    secrets: inherit
    with:
      artifact: report
      subdomain: pr-${{ github.event.number }}-reports
      path: /node-modules
