name: End-to-end tests on production

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0' # Every week

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    environment:
      name: Live tests
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/playwright
    container:
      image: ghcr.io/gwennlbh/playwright-bun:v1.55.0
      options: --user 1001
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: .bun-version
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Run Playwright tests
        run: bunx playwright test
        env:
          BASE_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
      - name: Deploy results on github pages
        if: ${{ !cancelled() }}
        env:
          NODE_DEBUG: gh-pages
          ORIGIN: https://git:${{ github.token }}@github.com/${{ github.repository }}.git
        run: |
          mv test-results.json playwright-report/test-results.json
          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions@users.noreply.github.com"
          git remote set-url origin $ORIGIN
          bunx --yes gh-pages --dist=playwright-report --dest=./playwright --branch=gh-pages --message="Deploy Playwright report for prod, run #${{ github.run_number }}\n\nSee logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/job/${{ github.job }}"
