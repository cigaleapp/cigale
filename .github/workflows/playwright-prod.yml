name: End-to-end tests on production

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0' # Every week

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    environment:
      name: Live tests
      url: https://cigaleapp.github.io/cigale/playwright-report
    container:
      image: mcr.microsoft.com/playwright:v1.55.0-noble
      options: --user 1001
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Run Playwright tests
        run: npx playwright test
        env:
          BASE_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/
      - name: Deploy results on github pages
        if: ${{ !cancelled() }}
        env:
          NODE_DEBUG: gh-pages
          ORIGIN: https://git:${{ github.token }}@github.com/${{ github.repository }}.git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "github-actions@users.noreply.github.com"
          git remote set-url origin $ORIGIN
          npx --yes gh-pages --dist=playwright-report --dest=./playwright --branch=gh-pages --message="Deploy Playwright report for prod, run #${{ github.run_number }}\n\nSee logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/job/${{ github.job }}"
