name: Regenerate example protocols

on:
  schedule:
    # Runs at 00:00 UTC every Monday
    - cron: '0 0 * * 1,4'
  # Allow manual triggering from the Actions tab
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or tag to run the workflow on'
        required: false
        default: 'main'
  # Run when scripts or the job itself are modified on main branch
  push:
    branches: [main]
    paths:
      - scripts/generate-protocols.js
      - scripts/add-species-from-jessica-joachim.js
      - scripts/add-species-from-google-slides.js
      - scripts/add-taxonomic-parents-from-gbif.js
      - .github/workflows/protocols.yml

jobs:
  generate-arthropods-protocol:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.inputs.ref || 'main' }}

      - name: Setup Node.js
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: .bun-version

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Initialize protocol
        run: bun run scripts/generate-protocols.js

      - name: Add data from Jessica Joachim
        run: bun run scripts/add-species-from-jessica-joachim.js

      - name: Set google-drive-key.json
        uses: mobiledevops/secret-to-file-action@v1
        with:
          base64-encoded-secret: ${{ secrets.GOOGLE_DRIVE_KEY_BASE64 }}
          filename: google-drive-key.json
          is-executable: false
          working-directory: ./

      - name: Add data from Google Slides folder
        run: bun run scripts/add-species-from-google-slides.js

      - name: Unset google-drive-key.json
        run: rm google-drive-key.json

      - name: Add data from GBIF
        run: bun run scripts/add-taxonomic-parents-from-gbif.js

      - name: Clean old protocol
        run: rm examples/old-*.json

      - name: Store scripts/jessica-joachim-crawler-report.md
        id: get-report
        run: |
          touch scripts/jessica-joachim-crawler-report.md
          {
            echo 'report<<EOF'
            cat scripts/jessica-joachim-crawler-report.md
            echo 
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Format & lintfix
        run: bun run format && bun run lintfix

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: üç± Regenerate arthropods protocol
          title: üç± Regenerate arthropods protocol
          branch: example-protocols--from-${{ github.event.inputs.ref || 'main' }}
          base: ${{ github.event.inputs.ref || 'main' }}
          body: |
            Based on ${{ github.event.inputs.ref || 'main' }}.

            This PR was automatically generated by [a workflow](https://github.com/${{ github.repository }}/actions/workflows/protocols.yml).

            ## Report for potential missing descriptions

            ${{ steps.get-report.outputs.report }}
