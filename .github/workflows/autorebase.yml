name: Auto-rebase PRs on main

on:
  schedule:
    - cron: '6 7 * * 2' # every week
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: write

jobs:
  autorebase:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          ref: main
      - name: Auto-rebase PRs
        run: |
          # Recursive function to take into account PRs that target other PR's branches, 
          # so that they are rebased in the correct order.
          function rebase_prs() {
            depth=${2:-1}
            additional_filters=$1

            function msg() {
              indent=$(printf '  %.0s' $(seq 1 $depth))
              echo "${indent}$@"
            }

            msg "Rebasing PRs with $additional_filters"

            to_update=$(gh pr list -S "$FILTER $additional_filters" --json number --jq '.[].number')

            for pr in $to_update; do
              msg ""
              msg "Rebasing PR #$pr https://github.com/${{ github.repository }}/pull/$pr"

              if ! gh pr update-branch $pr --rebase; then
                msg "Failed to rebase PR #$pr, adding comment"
                gh pr comment $pr --body "$PR_COMMENT"

              else
                msg "Successfully rebased PR #$pr"

                branch=$(gh pr view $pr --json headRefName --jq '.headRefName')
                rebase_prs "base:$branch" $((depth + 1))
              fi
            done
          }

          rebase_prs "base:main"
        env:
          GITHUB_TOKEN: ${{ github.token }}
          FILTER: >-
            -label:no-autorebase
            -author:app/github-actions 
            -author:app/copilot-swe-agent
            -author:app/renovate 
            -author:app/mend
          PR_COMMENT: |
            ðŸ¤– **Autorebase failed**

            The automatic rebase of this PR failed. This could be due to:
            - Merge conflicts that need manual resolution
            - The PR branch being out of sync with the base branch
            - Other git-related issues

            Please manually rebase your branch or resolve any conflicts:
            ```bash
            git checkout your-branch-name
            git rebase main
            # Resolve any conflicts if they occur
            git push --force-with-lease
            ```

            The autorebase will be attempted again on the next scheduled run.
